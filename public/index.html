<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Simulator Engineering Authoring Tool</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">

  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="shortcut icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />

  <style>
    #instrTable .instr-text {
      resize: none;
      overflow: hidden;
      min-height: 60px;
    }

    .visually-hidden {
      position: absolute !important;
      width: 1px !important;
      height: 1px !important;
      padding: 0 !important;
      margin: -1px !important;
      overflow: hidden !important;
      clip: rect(0, 0, 0, 0) !important;
      white-space: nowrap !important;
      border: 0 !important;
    }
  </style>

  <!-- TinyMCE – load once -->
  <script src="tinymce/js/tinymce/tinymce.min.js"></script>


  <!-- GLOBAL HELPERS – must exist before any inline onclick -->
  <script>
    function loadExistingAttachments(attachments) {
      const $c = $('#existingAttachments').empty();
      if (!attachments || !attachments.length) {
        $c.html('<small class="text-muted">No attachments</small>');
        return;
      }
      const list = attachments.map(url => {
        const name = url.split('/').pop();
        const full = url.startsWith('http') ? url : location.origin + url;
        const escAttr = url.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        const escJS = url.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
        return `<div class="d-flex align-items-center mb-1 p-2 border rounded bg-light">
                  <a href="${full}" target="_blank" class="text-decoration-none me-2 flex-grow-1">${name}</a>
                  <button type="button" class="btn btn-sm btn-outline-danger"
                          onclick="removeExistingAttachment(this, '${escJS}')">Remove</button>
                  <input type="hidden" name="keep_attachments[]" value="${escAttr}">
                </div>`;
      }).join('');
      $c.html(`<div class="border p-2 rounded bg-white mb-2">
                <small class="text-muted d-block mb-2"><strong>Current attachments:</strong></small>${list}
              </div>`);
    }

    function removeExistingAttachment(btn, url) {
      if (!confirm('Remove this attachment?')) return;
      $(btn).closest('div').remove();
    }

    // TinyMCE – SINGLE GLOBAL INITIALIZATION
    tinymce.init({
      selector: '#instrTable .instr-text',
      height: 80,
      menubar: false,
      plugins: 'lists link image table code autoresize',
      toolbar: 'undo redo | bold italic underline | bullist numlist | link image | removeformat | code | table',
      toolbar_mode: 'wrap',
      branding: false,
      statusbar: true,
      resize: true,
      autoresize_bottom_margin: 12,
      images_upload_handler: (blobInfo, progress) => new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', './src/upload_image.php');
        xhr.upload.onprogress = e => progress(e.loaded / e.total * 100);

        xhr.onload = () => {
          if (xhr.status < 200 || xhr.status >= 300) return reject('HTTP ' + xhr.status);
          let json;
          try { json = JSON.parse(xhr.responseText); } catch { return reject('Invalid JSON'); }
          if (!json?.location) return reject('No location in response');

          // Optional: client-side resize preview (most keep original + CSS)
          resolve(json.location);
        };

        xhr.onerror = () => reject('Upload failed');

        const formData = new FormData();
        formData.append('file', blobInfo.blob(), blobInfo.filename());
        formData.append('sea_id', $('#sea_id').val() || 'temp');
        xhr.send(formData);
      }),
      setup: editor => {
        editor.on('change keyup', () => {
          editor.save();
          try { autoResizeTextarea(editor.getElement()); } catch { }
        });
      }
    });
  </script>
</head>

<body>
  <div class="container mt-5">

    <!-- CHOICE SCREEN -->
    <div id="choiceScreen">
      <h1 class="text-center mb-5">Simulator Engineering Authoring Tool</h1>
      <div class="row g-4">
        <div class="col-md-6">
          <div class="card choice-card h-100 text-center p-4" onclick="showCreateForm()">
            <h2 class="text-primary">Create New SEA</h2>
            <p class="text-muted">Start a fresh engineering authorization</p>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card choice-card h-100 text-center p-4" onclick="showSeaList()">
            <h2 class="text-success">View / Edit Existing SEA</h2>
            <p class="text-muted">Search and modify previous submissions</p>
          </div>
        </div>
      </div>

      <!-- About footer -->
      <footer id="siteFooter" class="mt-5">
        <!-- ... your existing about content and GitHub version fetch script ... -->
      </footer>
    </div>

    <!-- CREATE / EDIT FORM -->
    <div id="createForm" class="hidden">
      <button class="btn btn-sm btn-outline-secondary mb-3" onclick="goBack()">Back</button>
      <h2 id="formTitle" class="mb-3 d-flex justify-content-between align-items-center">
        <span>New SEA</span>
        <div>
          <button type="button" class="btn btn-sm btn-outline-secondary me-2" onclick="showSeaList()">Cancel</button>
          <button type="button" class="btn btn-sm btn-secondary" onclick="goBack()">Back</button>
        </div>
      </h2>

      <form id="seaForm" class="needs-validation" novalidate enctype="multipart/form-data">
        <!-- ... all your form fields remain unchanged ... -->
        <!-- Important: keep id="instrTable" and class="instr-text" on instruction textareas -->
        <!-- ... rest of form (parts table, instructions table, submit buttons) ... -->
      </form>
    </div>

    <!-- LIST VIEW -->
    <div id="listView" class="hidden">
      <!-- ... existing list view content ... -->
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
      // ────────────────────────────────────────────────
      // HELPERS
      // ────────────────────────────────────────────────
      function h(s) {
        if (s == null) return '';
        return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;').replace(/'/g, '&#39;');
      }

      function autoResizeTextarea(el) {
        el.style.height = 'auto';
        el.style.height = el.scrollHeight + 'px';
      }

      const debounce = (fn, wait) => {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), wait);
        };
      };

      // ────────────────────────────────────────────────
      // DRAFT
      // ────────────────────────────────────────────────
      function saveDraft() {
        const seaId = $('#sea_id').val() || 'new';
        const draft = {
          sea_id: seaId,
          impact: $('#impact').val(),
          justification: $('#justification').val(),
          description: $('#description').val(),
          requester: $('#requester').val(),
          ea_number: $('#ea_number').val(),
          timestamp: new Date().toISOString()
        };
        try {
          localStorage.setItem('seaDraft_' + seaId, JSON.stringify(draft));
        } catch (e) {
          if (!window.draftWarningShown) {
            window.draftWarningShown = true;
            alert('Browser privacy settings may be blocking local draft saving.\n\n' +
              'Try setting Tracking Prevention to "Basic" in Edge.');
          }
        }
      }

      function loadDraft(seaId) {
        const key = 'seaDraft_' + (seaId || 'new');
        const saved = localStorage.getItem(key);
        if (!saved) return;
        try {
          const draft = JSON.parse(saved);
          if (draft.impact) $('#impact').val(draft.impact);
          if (draft.justification) $('#justification').val(draft.justification);
          if (draft.description) $('#description').val(draft.description);
          if (draft.requester) $('#requester').val(draft.requester);
          if (draft.ea_number) $('#ea_number').val(draft.ea_number);
        } catch { }
      }

      // ────────────────────────────────────────────────
      // MAIN LOGIC
      // ────────────────────────────────────────────────
      $(document).ready(function () {

        // ── SEA LIST LOADING ───────────────────────────────────────
  function loadSeaList() {
    const $container = $('#seaContainer');
    $container.html('<div class="text-center py-5"><div class="spinner-border text-primary"></div> <span>Loading existing SEAs...</span></div>');

    fetch('./src/list_seas.php')
      .then(response => {
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        return response.text();
      })
      .then(html => {
        $container.html(html);

        // Re-populate fleet filter from loaded cards
        $('#fleetFilter').html('<option value="">All Fleets</option>');
        const fleets = new Set();
        $('.sea-card').each(function () {
          const fleetText = $(this).find('strong:contains("Fleet:")').next().text().split('|')[0].trim();
          if (fleetText) fleets.add(fleetText);
        });
        [...fleets].sort().forEach(f => {
          $('#fleetFilter').append(`<option value="${f}">${f}</option>`);
        });

        // Populate status filter
        $('#statusFilter').html('<option value="">All Statuses</option>');
        const statuses = new Set();
        $('.sea-card .badge').each(function () {
          const status = $(this).text().trim();
          if (status) statuses.add(status);
        });
        [...statuses].sort().forEach(s => {
          $('#statusFilter').append(`<option value="${s}">${s}</option>`);
        });

        // Apply initial filter
        filterList();
      })
      .catch(err => {
        console.error('Failed to load SEA list:', err);
        $container.html(`<div class="alert alert-danger">Failed to load existing SEAs: ${err.message}</div>`);
      });
  }

  function filterList() {
    const term = $('#searchInput').val()?.toLowerCase().trim() || '';
    const fleet = $('#fleetFilter').val();
    const status = $('#statusFilter').val();

    $('.sea-card').each(function () {
      const $card = $(this);
      const $col = $card.closest('.col-md-6');
      const text = $card.text().toLowerCase();
      const matchesSearch = !term || text.includes(term);

      let cardFleet = $card.find('strong:contains("Fleet:")').next().text().split('|')[0].trim();
      const matchesFleet = !fleet || cardFleet === fleet;

      let cardStatus = $card.find('.badge').text().trim();
      const matchesStatus = !status || cardStatus === status;

      $col.toggle(matchesSearch && matchesFleet && matchesStatus);
    });
  }

  // Bind filter events once (after functions are defined)
  $('#searchInput').on('input', filterList);
  $('#fleetFilter, #statusFilter').on('change', filterList);

  // ────────────────────────────────────────────────
  // 2. Then define navigation functions that USE the above
  // ────────────────────────────────────────────────

  window.showSeaList = function () {
    hideAll();
    $('#listView').removeClass('hidden');
    loadSeaList();           // ← now this will exist
  };

  // ... other navigation functions: showCreateForm, goBack ...

  // ────────────────────────────────────────────────
  // 3. Startup – only at the very end
  // ────────────────────────────────────────────────
  hideAll();
  $('#choiceScreen').removeClass('hidden');

  const urlParams = new URLSearchParams(location.search);
  if (urlParams.has('id')) {
    editSea(urlParams.get('id'));
  }
});

        const fleetDeviceMap = { /* ... your fleet map ... */ };



        $('#fleet').select2({ placeholder: "Select Fleet", allowClear: true });
        $('#device').select2({ placeholder: "Select Device(s)", allowClear: true });

        const debouncedSave = debounce(saveDraft, 800);
        $('#impact, #justification, #description, #requester, #ea_number').on('input', debouncedSave);
        $('#priority, #status, #fleet, #target_date').on('change', debouncedSave);

        $('#seaForm').on('submit', saveDraft); // final save

        $('#justification').on('input', function () { autoResizeTextarea(this); });

        $('#fleet').on('change', function () {
          const fleet = $(this).val();
          const $dev = $('#device').empty().trigger('change');
          if (fleet && fleetDeviceMap[fleet]) {
            fleetDeviceMap[fleet].forEach(d => $dev.append(`<option value="${d}">${d}</option>`));
          }
        });

        // ── PARTS ───────────────────────────────────────
        window.addPartRow = function (data = {}) {
          const row = `<tr>
            <td><input class="form-control form-control-sm part-input" value="${h(data.part || '')}" /></td>
            <td><input class="form-control form-control-sm desc-input" value="${h(data.desc || '')}" /></td>
            <td><select class="form-control form-control-sm type-select">
              <option value=""></option>
              <option value="add"    ${data.type === 'add' ? 'selected' : ''}>Add</option>
              <option value="remove" ${data.type === 'remove' ? 'selected' : ''}>Remove</option>
              <option value="modify" ${data.type === 'modify' ? 'selected' : ''}>Modify</option>
            </select></td>
            <td><input type="number" class="form-control form-control-sm qty-input" value="${h(data.qty || '')}" min="1" /></td>
            <td><button type="button" class="btn btn-sm btn-outline-danger remove-row">×</button></td>
          </tr>`;
          $('#partsTable tbody').append(row);
        };

        // ── INSTRUCTIONS ────────────────────────────────
        window.addInstrRow = function (data = {}) {
          const idx = $('#instrTable tbody tr').length;
          const row = `
            <tr>
              <td class="text-center align-middle">${idx + 1}</td>
              <td>
                <textarea class="form-control instr-text"
                          name="instructions[${idx}][instruction]"
                          placeholder="Enter instruction...">${h(data.instruction || '')}</textarea>
              </td>
              <td>
                <input type="text" class="form-control instr-notes"
                       name="instructions[${idx}][notes]"
                       value="${h(data.notes || '')}" placeholder="Notes">
              </td>
              <td class="text-center align-middle">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeInstrRow(this)">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>`;
          $('#instrTable tbody').append(row);
          // NO tinymce.init() needed — global init catches it
        };

        window.removeInstrRow = function (btn) {
          $(btn).closest('tr').remove();
          $('#instrTable tbody tr').each((i, tr) => $(tr).find('td:first').text(i + 1));
        };

        
        $(document).on('click', '.remove-row', function () {
          $(this).closest('tr').remove();
        });

        // ── FORM SUBMIT ─────────────────────────────────
        $('#seaForm').on('submit', function (e) {
          e.preventDefault();
          const form = this;
          if (!form.checkValidity()) {
            form.classList.add('was-validated');
            return;
          }

          const $btn = $('#submitBtn').prop('disabled', true).text('Saving...');
          tinymce.triggerSave();

          const formData = new FormData(form);
          formData.set('parts_json', JSON.stringify(getParts()));
          formData.set('instructions_json', JSON.stringify(getInstructions()));

          // ... rest of your submit logic (ajax, conflict handling, success/error) ...
          // remains unchanged
        });

        function getParts() {
          const parts = [];
          $('#partsTable tbody tr').each(function () {
            const $r = $(this);
            parts.push({
              part: $r.find('.part-input').val().trim(),
              desc: $r.find('.desc-input').val().trim(),
              type: $r.find('.type-select').val().trim(),
              qty: $r.find('.qty-input').val().trim()
            });
          });
          return parts;
        }

        function getInstructions() {
          const instr = [];
          $('#instrTable tbody tr').each(function () {
            const $r = $(this);
            instr.push({
              instruction: $r.find('.instr-text').val().trim(),
              notes: $r.find('.instr-notes').val().trim()
            });
          });
          return instr;
        }

        // ── NAVIGATION & RESET ──────────────────────────
        function resetForm() {
          document.getElementById('seaForm')?.reset();
          $('#sea_id, #display_id').val('');
          $('#fleet, #device, #priority, #status').val('').trigger('change');
          tinymce.remove('#instrTable .instr-text');   // clean old editors
          $('#instrTable tbody, #partsTable tbody').empty();
          $('#existingAttachments').html('<small class="text-muted">No attachments</small>');
          $('#attachments').val('');
          $('.alert').remove();
          document.getElementById('seaForm')?.classList.remove('was-validated');
        }

        window.showCreateForm = function () {
          hideAll();
          resetForm();
          loadDraft('new');
          $('#createForm').removeClass('hidden');
          $('#sea_action').val('create');
          $('#formTitle span').text('New SEA');
          $('#submitBtn').text('Create SEA');
          addPartRow();
          addInstrRow();
        };

        // ... keep your other navigation functions (showSeaList, goBack, editSea, etc.) ...

        // On load
        hideAll();
        $('#choiceScreen').removeClass('hidden');

        const urlParams = new URLSearchParams(location.search);
        if (urlParams.has('id')) editSea(urlParams.get('id'));
      });


      // Make these GLOBAL so inline onclick can find them
      function hideAll() {
        $('#choiceScreen, #createForm, #listView').addClass('hidden');
      }


      window.showSeaList = function () {
        hideAll();
        $('#listView').removeClass('hidden');
        loadSeaList();         // keep your existing list loading logic
      };

      window.goBack = function () {
        hideAll();
        $('#choiceScreen').removeClass('hidden');
        history.replaceState(null, null, window.location.pathname);
      };      
    </script>

    <!-- Modal and other static elements remain unchanged -->
  </div>
</body>

</html>