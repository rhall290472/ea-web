<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Simulator Engineering Authoring Tool</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    /* ---- AUTO-RESIZE FOR INSTRUCTION TEXTAREA ---- */
    #instrTable .instr-text {
      resize: none;
      /* no manual resize handle */
      overflow: hidden;
      /* hide scrollbars */
      min-height: 60px;
      /* same as original */
    }

    /* Bootstrap already ships .visually-hidden, but just in case */
    .visually-hidden {
      position: absolute !important;
      width: 1px !important;
      height: 1px !important;
      padding: 0 !important;
      margin: -1px !important;
      overflow: hidden !important;
      clip: rect(0, 0, 0, 0) !important;
      white-space: nowrap !important;
      border: 0 !important;
    }
  </style>
  <script src="https://cdn.tiny.cloud/1/h9xs5cld1bkmamb6zycl5ymhfanahso689gglclrgt5gldlx/tinymce/7/tinymce.min.js"
    referrerpolicy="origin"></script>
  <!-- ====== CRITICAL: DEFINE FUNCTIONS FIRST ====== -->
  <script>
    // BLOCK TINYCE STATS GLOBALLY — RUNS IMMEDIATELY
    (function () {
      if (window.tinymce) {
        window.tinymce.stateless = true;
        console.log('TinyMCE stats disabled globally');
      }
    })();

    // GLOBAL: Must be defined BEFORE any inline onclick
function loadExistingAttachments(attachments) {
  // CRITICAL: Remove ALL old hidden keep_attachments inputs
  $('input[name="keep_attachments[]"]').remove();

  const $c = $('#existingAttachments').empty();
  if (!attachments || !attachments.length) {
    $c.html('<small class="text-muted">No attachments</small>');
    return;
  }

  const list = attachments.map(url => {
    const name = url.split('/').pop();
    const full = url.startsWith('http') ? url : location.origin + url;

    const escAttr = url.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    const escJS = url.replace(/\\/g, '\\\\').replace(/'/g, "\\'");

    return `<div class="d-flex align-items-center mb-1 p-2 border rounded bg-light">
              <a href="${full}" target="_blank" class="text-decoration-none me-2 flex-grow-1">${name}</a>
              <button type="button" class="btn btn-sm btn-outline-danger"
                      onclick="removeExistingAttachment(this, '${escJS}')">Remove</button>
              <input type="hidden" name="keep_attachments[]" value="${escAttr}">
            </div>`;
  }).join('');

  $c.html(`<div class="border p-2 rounded bg-white mb-2">
            <small class="text-muted d-block mb-2"><strong>Current attachments:</strong></small>${list}
          </div>`);
}


    function removeExistingAttachment(btn, url) {
      if (!confirm('Remove this attachment?')) return;
      $(btn).closest('div').remove();
    }
  </script>
  <!-- ====== END CRITICAL SECTION ====== -->
</head>

<body>
  <div class="container mt-5">

    <!-- ====================== CHOICE SCREEN ====================== -->
    <div id="choiceScreen">
      <h1 class="text-center mb-5">Simulator Engineering Authoring Tool</h1>
      <div class="row g-4">
        <div class="col-md-6">
          <div class="card choice-card h-100 text-center p-4" onclick="showCreateForm()">
            <h2 class="text-primary">Create New SEA</h2>
            <p class="text-muted">Start a fresh engineering authorization</p>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card choice-card h-100 text-center p-4" onclick="showSeaList()">
            <h2 class="text-success">View / Edit Existing SEA</h2>
            <p class="text-muted">Search and modify previous submissions</p>
          </div>
        </div>
      </div>

      <!-- ABOUT SECTION – ONLY ON CHOICE SCREEN -->
      <footer id="siteFooter">
        <div class="container">
          <div class="row">
            <div class="col-lg-12 mx-auto text-center">
              <h5>About the Simulator Engineering Authoring Tool (SEAT)</h5>
              <p>
                The <strong>Simulator Engineering Authoring Tool (SEAT)</strong> is a specialized web-based platform
                designed to simplify the creation, management, and documentation of <em>Simulator Engineering
                  Authorizations (SEAs)</em>. Built for engineering teams in aviation and simulation industries, SEAT
                provides an intuitive interface for handling authorization requests related to aircraft simulator
                fleets, such as Boeing 737, 777, 787, and Airbus A320 models.
              </p>
              <p>
                It ensures compliance, traceability, and efficiency by digitizing the entire workflow—from initial
                submission to PDF generation and archival.
              </p>

              <h6>Key Features:</h6>
              <ul class="list-unstyled text-start d-inline-block">
                <li>SEA Creation and Editing</li>
                <li>Parts and Instructions Management</li>
                <li>Attachment Handling</li>
                <li>PDF Generation with embedded attachments</li>
                <li>SEA Dashboard with search and actions</li>
                <li>Fleet-Specific Device Selection</li>
                <li>User-Friendly Responsive Interface</li>
              </ul>

              <p class="mt-3">
                SEAT addresses the challenges of manual engineering authorization processes by providing a centralized,
                digital solution that reduces errors, speeds up approvals, and maintains an audit trail. It's ideal for
                simulator maintenance teams, engineers, and requesters who need to document changes, justify
                modifications, and assess impacts on critical training equipment.
              </p>

              <p class="text-muted small">
                <em>Developed with PHP, mPDF, Bootstrap, and modern web technologies. Extensible and deployable on
                  standard web servers.</em><br>
              <p class="text-muted small" id="versionInfo">
                <em>Loading version...</em>
              </p>

              <script>
                fetch('version.json')
                  .then(r => r.ok ? r.json() : { tag: 'dev', commit: '??', date: 'unknown' })
                  .then(v => {
                    const el = document.getElementById('versionInfo');
                    el.innerHTML = `
        <strong>Version:</strong> 
        <a href="https://github.com/yourname/your-repo/commit/${v.commit}" target="_blank" class="text-decoration-none">
          ${v.tag}
        </a>
        <code class="text-muted">(${v.commit})</code>
        | <strong>Last Updated:</strong> ${v.date}
      `;
                  })
                  .catch(() => {
                    document.getElementById('versionInfo').innerHTML = '<em>Version info unavailable</em>';
                  });
              </script>
            </div>
          </div>
        </div>
      </footer>
    </div>

    <!-- ====================== CREATE / EDIT FORM ====================== -->
    <div id="createForm" class="hidden">
      <!-- <h2 id="formTitle" class="mb-4">New SEA</h2> -->
      <button class="btn btn-sm btn-outline-secondary mb-3" onclick="goBack()">Back</button>
      <h2 id="formTitle" class="mb-3 d-flex justify-content-between align-items-center">
        <span>New SEA</span>
        <div>
          <button type="button" class="btn btn-sm btn-outline-secondary me-2" onclick="showSeaList()">Cancel</button>
          <button type="button" class="btn btn-sm btn-secondary" onclick="goBack()">Back</button>
        </div>
      </h2>

      <form id="seaForm" enctype="multipart/form-data">
        <input type="hidden" id="sea_action" name="action" value="create">
        <input type="hidden" id="sea_id" name="sea_id" value="">

        <div class="row g-3 mb-3">
          <!-- SEA ID (display only) -->
          <div class="col-md-4">
            <label for="display_id" class="form-label">SEA ID</label>
            <input type="text" class="form-control bg-light" id="display_id" readonly placeholder="Auto-generated">
          </div>
          <!-- EA# & Revision -->
          <div class="col-md-4">
            <label for="ea_number" class="form-label">EA#</label>
            <input type="text" class="form-control" id="ea_number" name="ea_number" placeholder="e.g. EA-12345">
          </div>
          <div class="col-md-4">
            <label for="revision" class="form-label">EA Revision</label>
            <input type="text" class="form-control" id="revision" name="revision" placeholder="e.g. A">
          </div>

          <div class="row g-3 mb-4">
            <div class="col-md-4">
              <label class="form-label">Priority</label>
              <select class="form-select" id="priority" name="priority">
                <option value="Low">Low</option>
                <option value="Medium" selected>Medium</option>
                <option value="High">High</option>
                <option value="Critical">Critical</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Target Date</label>
              <input type="date" class="form-control" id="target_date" name="target_date">
            </div>
            <div class="col-md-4">
              <label for="status" class="form-label">Status</label>
              <select class="form-select" id="status" name="status">
                <option value="Planning" selected>Planning</option>
                <option value="In Work">In Work</option>
                <option value="Completed">Completed</option>
                <option value="On Hold">On Hold</option>
              </select>
            </div>
          </div>
          <!-- Status -->


          <!-- Fleet -->
          <div class="col-md-6">
            <label for="fleet" class="form-label">Fleet</label>
            <select class="form-select select2" id="fleet" name="fleet" required>
              <option value="">-- Select Fleet --</option>
              <option value="737">737</option>
              <option value="777">777</option>
              <option value="787">787</option>
              <option value="A320">A320</option>
              <!-- add more fleets here -->
            </select>
          </div>

          <!-- Device (multi-select) -->
          <div class="col-md-6">
            <label for="device" class="form-label">Device(s)</label>
            <select class="form-select select2" id="device" name="device[]" multiple></select>
          </div>

          <!-- Requester -->
          <div class="col-md-12">
            <label for="requester" class="form-label">Author</label>
            <input type="text" class="form-control" id="requester" name="requester" required>
          </div>

          <!-- Description -->
          <div class="col-md-12">
            <label for="description" class="form-label">Description</label>
            <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
          </div>

          <!-- Justification -->
          <div class="col-md-12">
            <label for="justification" class="form-label">Justification</label>
            <textarea class="form-control" id="justification" name="justification" rows="2"></textarea>
          </div>

          <!-- Impact -->
          <div class="col-md-12">
            <label for="impact" class="form-label">Impact On Training Device</label>
            <textarea class="form-control" id="impact" name="impact" rows="5"></textarea>
          </div>

          <!-- ==================== PARTS TABLE ==================== -->
          <h4 class="mt-4">Affected Parts</h4>
          <table class="table table-sm parts-table" id="partsTable">
            <thead>
              <tr>
                <th>Part #</th>
                <th>Description</th>
                <th>Type</th>
                <th>Qty</th>
                <th style="width:50px;"></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <button type="button" class="btn btn-outline-secondary btn-sm mb-3" onclick="addPartRow()">+ Add Part</button>

          <!-- ==================== INSTRUCTIONS TABLE ==================== -->
          <h4 class="mt-4">Work Instructions</h4>
          <table class="table table-sm instr-table" id="instrTable">
            <thead>
              <tr>
                <th style="width:5%;">#</th>
                <th style="width:70%;">Instruction</th>
                <th style="width:20%;">Notes</th>
                <th style="width:5%;"></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <button type="button" class="btn btn-outline-secondary btn-sm mb-3" onclick="addInstrRow()">+ Add
            Instruction</button>

          <!-- Attachments -->
          <div class="col-md-12">
            <label for="attachments" class="form-label">Attachments</label>
            <input type="file" class="form-control" id="attachments" name="attachments[]" multiple>
            <div id="existingAttachments" class="mt-2"></div>
          </div>
        </div>

        <!-- ==================== SUBMIT ==================== -->
        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
          <button type="button" class="btn btn-secondary me-md-2" onclick="goBack()">Back</button>
          <button type="submit" id="submitBtn" class="btn btn-primary">Create SEA</button>
        </div>
      </form>
    </div>
    <!-- ====================== LIST VIEW ====================== -->
    <div id="listView" class="hidden">
      <button class="btn btn-sm btn-outline-secondary mb-3" onclick="goBack()">Back</button>
      <h3>Existing SEAs</h3>
      <div class="row mb-3">
        <div class="col-md-6">
          <input type="text" id="searchInput" class="form-control" placeholder="Search by keyword...">
        </div>
        <div class="col-md-6">
          <select id="fleetFilter" class="form-select">
            <option value="">All Fleets</option>
            <!-- Options will be populated dynamically -->
          </select>
        </div>
      </div>
      <div id="seaContainer" class="row"></div> <!-- Content from list_seas.php loads here -->
    </div>


    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
      // BLOCK TINYCE STATS GLOBALLY
      setTimeout(() => {
        if (window.tinymce) {
          window.tinymce.stateless = true;
        }
      }, 100);
      // -------------------------------------------------
      // Small HTML-escape helper used in templates
      function h(s) {
        if (s === null || s === undefined) return '';
        return String(s)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      // AUTO-RESIZE TEXTAREA (Instruction field)
      // -------------------------------------------------
      // TinyMCE – initialise only on the instruction textarea
      // -------------------------------------------------
      tinymce.init({
        selector: '#instrTable .instr-text',          // target every instruction textarea
        height: 80,
        menubar: false,
        plugins: 'lists link image table code autoresize',
        toolbar: 'undo redo | bold italic underline | bullist numlist | link image | removeformat | code | table',
        toolbar_mode: 'wrap',  // or 'floating', 'sliding'
        branding: false,
        statusbar: true,
        // allow manual resize and enable autoresize plugin to auto-grow the editor
        resize: true,
        autoresize_bottom_margin: 12,
        stateless: true,
        setup: function (editor) {
          // keep the hidden textarea in sync (TinyMCE does this automatically)
          editor.on('change keyup', function () {
            editor.save();                       // write HTML back to <textarea>
            // keep legacy textarea sizing logic (harmless) in case TinyMCE is removed
            try { autoResizeTextarea(editor.getElement()); } catch (e) { /* noop */ }
          });
        },
        // Enable local file browser
        file_picker_types: 'image',

        file_picker_callback: function (callback, value, meta) {
          let input = document.createElement('input');
          input.setAttribute('type', 'file');
          input.setAttribute('accept', 'image/*');

          input.onchange = function () {
            let file = this.files[0];
            let reader = new FileReader();

            reader.onload = function () {
              callback(reader.result, { alt: file.name });
            };

            reader.readAsDataURL(file);
          };

          input.click();
        }
      });

      // -------------------------------------------------
      // Existing auto-resize (unchanged, works with TinyMCE HTML)
      // -------------------------------------------------
      function autoResizeTextarea(el) {
        el.style.height = 'auto';
        el.style.height = (el.scrollHeight) + 'px';
      }
      function autoResizeTextarea(el) {
        el.style.height = 'auto';                     // allow shrinking
        el.style.height = el.scrollHeight + 'px';     // fit content
      }

      $(document).ready(function () {
        let stepCounter = 1;

        // === FLEET → DEVICE MAP (YOUR ORIGINAL) ===
        const fleetDeviceMap = {
          '737': ['FFS-2', 'FFS-3', 'FFS-4', 'FFS-5', 'FFS-6', 'FTD-2', 'FTD-3', 'FTD-4', 'FFS-7', 'FFS-8', 'FFS-9', 'FFS-10'],
          '737-MAX': ['FFS-1', 'FFS-2', 'FFS-3', 'FFS-4', 'FFS-5', 'FFS-6', 'FFS-7', 'FFS-8', 'FFS-9', 'FFS-10', 'FFS-11',
            'FTD-1', 'FTD-2', 'FTD-3', 'FTD-4', 'FTD-5', 'FTD-6', 'FTD-7', 'FTD-8', 'FTD-9', 'FTD-10', 'FTD-11'],
          '757': ['FFS-1', 'FFS-2', 'FFS-3', 'FTD-1', 'FTD-2'],
          '767': ['FFS-3', 'FFS-4', 'FFS-5'],
          '777': ['FFS-1', 'FFS-2', 'FFS-3', 'FFS-5', 'FTD-1', 'FTD-2', 'FFS-6', 'FFS-7', 'FTD-3'],
          '787': ['FFS-1', 'FFS-2', 'FFS-3', 'FFS-4', 'FFS-5', 'FFS-6', 'FFS-7', 'FFS-8', 'FFS-9', 'FTD-1', 'FTD-2', 'FTD-3', 'FTD-4', 'FTD-5', 'FTD-6'],
          'A320': ['FFS-1', 'FFS-4', 'FTD-1', 'FTD-2', 'FFS-6', 'FFS-7', 'FFS-8', 'FFS-9', 'FFS-10', 'FFS-11', 'FFS-12', 'FFS-13',
            'FTD-3', 'FTD-4', 'FTD-5', 'FTD-6']
        };

        // -------------------------------------------------
        // SELECT2 INITIALISATION
        // -------------------------------------------------
        $('#fleet').select2({ placeholder: "Select Fleet", allowClear: true });
        $('#device').select2({ placeholder: "Select Device(s)", allowClear: true });

        // -------------------------------------------------
        // AUTOSIZE: justification textarea
        // -------------------------------------------------
        // auto-resize as the user types
        $('#justification').on('input', function () {
          autoResizeTextarea(this);
        });

        // -------------------------------------------------
        // FLEET → DEVICE POPULATION
        // -------------------------------------------------
        $('#fleet').on('change', function () {
          const fleet = $(this).val();
          const $device = $('#device');
          $device.empty().trigger('change');
          $('#deviceCol').toggle(!!fleet);
          if (fleet && fleetDeviceMap[fleet]) {
            fleetDeviceMap[fleet].forEach(d => $device.append(`<option value="${d}">${d}</option>`));
          }
        });

        // -------------------------------------------------
        // PARTS ROW
        // -------------------------------------------------
        window.addPartRow = function (data = {}) {
          const row = `<tr>
            <td><input type="text" class="form-control form-control-sm part-input" value="${h(data.part || '')}"></td>
            <td><input type="text" class="form-control form-control-sm desc-input" value="${h(data.desc || '')}"></td>
            <td>
              <select class="form-control form-control-sm type-select">
                <option value="add" ${data.type === 'add' ? 'selected' : ''}>Add</option>
                <option value="remove" ${data.type === 'remove' ? 'selected' : ''}>Remove</option>
                <option value="modify" ${data.type === 'modify' ? 'selected' : ''}>Modify</option>
              </select>
            </td>
            <td><input type="number" class="form-control form-control-sm qty-input" value="${h(data.qty || '')}" min="1"></td>
            <td><button type="button" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button></td>
          </tr>`;
          $('#partsTable tbody').append(row);
        };
        // -------------------------------------------------
        // INSTRUCTION ROW (with auto-resize)
        // -------------------------------------------------
        window.addInstrRow = function (data = {}) {
          const idx = $('#instrTable tbody tr').length;
          const row = `
    <tr>
      <td class="text-center align-middle">${idx + 1}</td>
      <td>
        <textarea class="form-control instr-text" name="instructions[${idx}][instruction]"
                  placeholder="Enter instruction..." rows="1">${(data.instruction || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
      </td>
      <td>
   <input type="text" class="form-control instr-notes" name="instructions[${idx}][notes]"
     value="${h(data.notes || '')}" placeholder="Notes">
      </td>
      <td class="text-center align-middle">
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeInstrRow(this)">
          <i class="bi bi-trash"></i>
        </button>
      </td>
    </tr>`;
          $('#instrTable tbody').append(row);

          // Initialise TinyMCE on the *new* textarea
          tinymce.init({
            // Use valid CSS selector (:last is jQuery-only); use :last-child for native querySelectorAll
            selector: `#instrTable tbody tr:last-child .instr-text`,
            height: 80,
            menubar: false,
            plugins: 'lists link image table code autoresize',
            toolbar: 'undo redo | bold italic underline | bullist numlist | link image | removeformat | code | table',
            branding: false,
            statusbar: true,
            resize: true,
            autoresize_bottom_margin: 12,
            stateless: true,
            setup: ed => {
              ed.on('change keyup', () => {
                ed.save();
                try { autoResizeTextarea(ed.getElement()); } catch (e) { }
              });
            },
            // Enable local file browser
            file_picker_types: 'image',

            file_picker_callback: function (callback, value, meta) {
              let input = document.createElement('input');
              input.setAttribute('type', 'file');
              input.setAttribute('accept', 'image/*');

              input.onchange = function () {
                let file = this.files[0];
                let reader = new FileReader();

                reader.onload = function () {
                  callback(reader.result, { alt: file.name });
                };

                reader.readAsDataURL(file);
              };

              input.click();
            }
          });
          // end of addInstrRow - close the function so subsequent handlers are at document-ready scope
        }

        // -------------------------------------------------
        // REMOVE ROW (update step numbers)
        // (bind once at document-ready scope, not on every row add)
        // -------------------------------------------------
        $(document).on('click', '.remove-row', function () {
          $(this).closest('tr').remove();
          $('#instrTable tbody .step-num').each((i, el) => $(el).text(i + 1));
          stepCounter = $('#instrTable tbody tr').length + 1;
        });

        // Remove Part Row
        $(document).on('click', '#partsTable .btn-outline-danger', function () {
          $(this).closest('tr').remove();
        });
        // -------------------------------------------------
        // FORM SUBMIT
        // -------------------------------------------------
        // -------------------------------------------------
        // FORM SUBMIT (AJAX) - RESTORED & FIXED
        // -------------------------------------------------
        $('#seaForm').on('submit', function (e) {
          e.preventDefault(); // ← RESTORE THIS LINE

          const $form = $(this);
          const $btn = $('#submitBtn');
          $btn.prop('disabled', true).text('Saving...');

          $('.alert').remove();

          const formData = new FormData(this);

          // === COLLECT PARTS ===
          getParts().forEach((p, i) => {
            formData.append(`parts[${i}][part]`, p.part);
            formData.append(`parts[${i}][desc]`, p.desc);
            formData.append(`parts[${i}][type]`, p.type);
            formData.append(`parts[${i}][qty]`, p.qty);
          });

          // === COLLECT INSTRUCTIONS ===
          getInstructions().forEach((instr, i) => {
            formData.append(`instructions[${i}][instruction]`, instr.instruction);
            formData.append(`instructions[${i}][notes]`, instr.notes);
          });

          // === KEEP EXISTING ATTACHMENTS ===
          if ($('#sea_action').val() === 'update') {
            $('#existingAttachments input[name="keep_attachments[]"]').each(function () {
              formData.append('keep_attachments[]', this.value);
            });
          }

          // === AJAX SUBMIT ===
          $.ajax({
            url: './src/submit.php',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            dataType: 'json',
            cache: false,
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            },
            success: function (res) {
              if (res.conflict) {
                // Show overwrite modal
                const $list = $('#conflictList').empty();
                res.conflicting_files.forEach(f => $list.append(`<li>${f}</li>`));
                $('#confirmOverwrite').off('click').on('click', function () {
                  res.conflicting_files.forEach(f => formData.append('overwrite[]', f));
                  $('#overwriteModal').modal('hide');
                  $btn.prop('disabled', true).text('Overwriting...');
                  $.ajax({
                    url: './src/submit.php',
                    method: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    dataType: 'json',
                    cache: false,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    success: res => handleSuccess(res, $btn),
                    error: xhr => handleError(xhr, $btn)
                  });
                });
                $('#overwriteModal').modal('show');
              } else {
                handleSuccess(res, $btn);
              }
            },
            error: function (xhr) {
              handleError(xhr, $btn);
            }
          });
        });

        // === SUCCESS HANDLER ===
        function handleSuccess(res, $btn) {
          if (res.success) {
            showAlert('success', res.message);
            $('html, body').animate({ scrollTop: 0 }, 300);

            if ($('#sea_action').val() === 'create') {
              const newId = res.sea_id;
              $('#sea_id').val(newId);
              $('#display_id').val(newId);
              $('#sea_action').val('update');
              $('#formTitle').text('Edit SEA – ' + newId);
              $('#submitBtn').text('Update SEA');
              history.replaceState(null, null, '?id=' + newId);
            }

            loadExistingAttachments(res.attachments || []);
          } else {
            showAlert('danger', res.message || 'Unknown error');
          }
          $btn.prop('disabled', false).text(
            $('#sea_action').val() === 'create' ? 'Create SEA' : 'Update SEA'
          );
        }

        // === ERROR HANDLER ===
        function handleError(xhr, $btn) {
          let msg = 'Network error';
          if (xhr.responseJSON?.message) {
            msg = xhr.responseJSON.message;
          } else if (xhr.status === 406) {
            msg = 'Request blocked by server (406). Check file size or mod_security rules.';
          } else if (xhr.status === 500) {
            msg = 'Server error. Check logs.';
          }
          showAlert('danger', msg);
          console.error('AJAX Error:', xhr);
          $btn.prop('disabled', false).text(
            $('#sea_action').val() === 'create' ? 'Create SEA' : 'Update SEA'
          );
        }
        // Let the browser submit the form normally
        // No AJAX → no mod_security 406
      });

      // -----------------------------------------------------------------
      function handleSuccess(res) {
        if (res.success) {
          showAlert('success', res.message);
          $('html, body').animate({ scrollTop: 0 }, 300);

          if ($('#sea_action').val() === 'create') {
            $('#sea_id').val(res.sea_id);
            $('#display_id').val(res.sea_id);
            $('#sea_action').val('update');
            $('#formTitle').text('Edit SEA – ' + res.sea_id);
            $('#submitBtn').text('Update SEA');
            history.replaceState(null, null, '?id=' + res.sea_id);
          }

          loadExistingAttachments(res.attachments || []);
        } else {
          showAlert('danger', res.message || 'Unknown error');
        }
        $btn.prop('disabled', false).text(
          $('#sea_action').val() === 'create' ? 'Create SEA' : 'Update SEA'
        );
      }

      function showAlert(type, message) {
        const alert = `<div class="alert alert-${type} alert-dismissible fade show mt-3" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
        $('#createForm').prepend(alert);
        $('html, body').animate({ scrollTop: 0 }, 300);
      }

      function downloadPdf(base64, filename) {
        const link = document.createElement('a');
        link.href = 'data:application/pdf;base64,' + base64;
        link.download = filename;
        link.click();
      }

      // -------------------------------------------------
      // NAVIGATION
      // -------------------------------------------------
      // SHOW CREATE FORM — CALL resetForm(true)
      window.showCreateForm = function () {
        hideAll();
        resetForm(true); // ← MUST PASS true
        $('#createForm').removeClass('hidden');

        $('#sea_action').val('create');
        $('#formTitle').text('New SEA');
        $('#submitBtn').text('Create SEA');
        $('#sea_id').val('');
        $('#display_id').val('');
        stepCounter = 1;
        $('#existingAttachments').html('<small class="text-muted">No attachments</small>');
        addInstrRow();

        generateIdPreview();
        $('#fleet').off('change.idPreview').on('change.idPreview', generateIdPreview);
      };

      // === HELPER: Generate and display SEA ID preview ===
      function generateIdPreview() {
        const fleetSelect = $('#fleet');
        let fleet = fleetSelect.val() || 'UNKNOWN';
        fleet = fleet.toUpperCase().replace(/[^A-Z0-9]/g, '');
        if (fleet === '') fleet = 'UNKNOWN';

        const today = new Date();
        const datePart = today.toISOString().slice(2, 10).replace(/-/g, ''); // YYYYMMDD
        const randomPart = String(Math.floor(100 + Math.random() * 900)).padStart(3, '0'); // 100–999

        const previewId = `SEA-${fleet}-${datePart}-${randomPart}`;
        $('#display_id').val(previewId);
      }
      window.showSeaList = function () {
        hideAll();
        $('#listView').removeClass('hidden');
        loadSeaList();
      };

      window.goBack = function () {
        hideAll();
        $('#choiceScreen').removeClass('hidden');
        history.replaceState(null, null, window.location.pathname);
      };

      function hideAll() {
        $('#choiceScreen, #createForm, #listView').addClass('hidden');
      }

      // -------------------------------------------------
      // LIST & EDIT
      // -------------------------------------------------
      function loadSeaList() {
        const $c = $('#seaContainer');
        $c.html('<div class="text-center py-5"><div class="spinner-border"></div> Loading...</div>');
        fetch('./src/list_seas.php')
          .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.text(); })
          .then(html => {
            $c.html(html);

            // Reset and populate fleet filter
            // Inside loadSeaList(), after populating .sea-card
            $('#fleetFilter').html('<option value="">All Fleets</option>');
            const fleets = new Set();

            $('.sea-card').each(function () {
              const $card = $(this);
              const $fleetStrong = $card.find('strong').filter((_, el) => $(el).text().trim() === 'Fleet:');
              if ($fleetStrong.length) {
                let fleetVal = '';
                const next = $fleetStrong[0].nextSibling;
                if (next && next.nodeType === Node.TEXT_NODE) {
                  fleetVal = next.textContent.split('|')[0].trim();
                } else {
                  const match = $fleetStrong.parent().text().match(/Fleet:\s*([^\|]+)/i);
                  fleetVal = match ? match[1].trim() : '';
                }
                if (fleetVal) fleets.add(fleetVal);
              }
            });

            Array.from(fleets).sort().forEach(f => {
              $('#fleetFilter').append(`<option value="${f}">${f}</option>`);
            });
            // Trigger initial filter (in case of URL params or defaults)
            filterList();
          })
          .catch(err => $c.html(`<div class="alert alert-danger">Failed: ${err.message}</div>`));
      }

      // Combined filtering function
      function filterList() {
        const term = $('#searchInput').val().toLowerCase().trim();
        const selectedFleet = $('#fleetFilter').val(); // Keep original case for comparison

        $('.sea-card').each(function () {
          const $card = $(this);
          const $col = $card.closest('.col-md-6');

          // --- Search term match ---
          const fullText = $card.text().toLowerCase();
          const matchesSearch = !term || fullText.includes(term);

          // --- Fleet match: Look for <strong>Fleet:</strong> followed by value ---
          let cardFleet = '';
          const $fleetStrong = $card.find('strong').filter(function () {
            return $(this).text().trim() === 'Fleet:';
          });
          if ($fleetStrong.length) {
            // Get the text *after* the <strong>Fleet:</strong>
            const fleetNode = $fleetStrong[0].nextSibling;
            if (fleetNode && fleetNode.nodeType === Node.TEXT_NODE) {
              cardFleet = fleetNode.textContent.split('|')[0].trim();
            } else {
              // Fallback: get parent <p> and extract after "Fleet:"
              const pText = $fleetStrong.parent().text();
              const match = pText.match(/Fleet:\s*([^\|]+)/i);
              cardFleet = match ? match[1].trim() : '';
            }
          }

          const matchesFleet = !selectedFleet || cardFleet === selectedFleet;

          // Show/hide based on both filters
          $col.toggle(matchesSearch && matchesFleet);
        });
      }


      // Event listeners for filtering
      $('#searchInput').on('input', filterList);
      $('#fleetFilter').on('change', filterList);


      window.deleteSea = function (id) {
        if (!confirm(`Delete SEA-${id}? This cannot be undone.`)) return;
        const f = document.createElement('form');
        f.method = 'POST'; f.action = './src/delete.php'; f.style.display = 'none';
        const i = document.createElement('input');
        i.type = 'hidden'; i.name = 'filename'; i.value = `sea-${id}.json`;
        f.appendChild(i); document.body.appendChild(f); f.submit();
      };

      window.editSea = function (id) {
        hideAll();

        // ---- Form mode -------------------------------------------------
        $('#sea_action').val('update');
        $('#formTitle').text('Edit SEA – ' + id);
        $('#submitBtn').text('Update SEA');

        // ---- Reset everything (while still hidden) --------------------
        $('#seaForm')[0].reset();
        $('#partsTable tbody').empty();
        $('#instrTable tbody').empty();
        stepCounter = 1;
        $('#existingAttachments').empty();
        $('#fleet').val('').trigger('change');
        $('#device').val(null).trigger('change');

        // ---- SEA ID must survive the reset ----------------------------
        $('#sea_id').val(id);
        $('#display_id').val(id);

        resetForm(false);
        // ---- Load JSON -------------------------------------------------
        fetch(`data/sea-${id}.json`)
          .then(r => { if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); })
          .then(d => {
            // <-- NEW – clean before filling
            console.log('Loaded SEA data →', d);

            // ----- Basic fields -----
            $('#ea_number').val(d.ea_number || '');
            $('#revision').val(d.revision || '');
            $('#requester').val(d.requester || '');
            $('#description').val(d.description || '');
            $('#justification').val(d.justification || '');

            // ----- Impact (the field that was previously overwritten) -----
            const impactVal = d.impact || '';
            console.log('Setting #impact →', impactVal);
            $('#impact').val(impactVal);

            $('#priority').val(d.priority || 'Medium');
            $('#target_date').val(d.target_date || '');
            $('#status').val(d.status || 'Planning');

            // ----- Parts / Instructions -----
            (JSON.parse(d.parts_json || '[]') || []).forEach(addPartRow);
            (JSON.parse(d.instructions_json || '[]') || []).forEach(addInstrRow);

            // ----- TinyMCE re-init -----
            setTimeout(() => {
              tinymce.remove('#instrTable .instr-text');
              tinymce.init({
                selector: '#instrTable .instr-text',
                height: 80,
                menubar: false,
                plugins: 'lists link image table code autoresize',
                toolbar: 'undo redo | bold italic underline | bullist numlist | link image | removeformat | code | table',
                branding: false,
                statusbar: true,
                resize: true,
                autoresize_bottom_margin: 12,
                stateless: true,
                setup: ed => {
                  ed.on('change keyup', () => {
                    ed.save();
                    try { autoResizeTextarea(ed.getElement()); } catch (e) { }
                  });
                },
                // Enable local file browser
                file_picker_types: 'image',

                file_picker_callback: function (callback, value, meta) {
                  let input = document.createElement('input');
                  input.setAttribute('type', 'file');
                  input.setAttribute('accept', 'image/*');

                  input.onchange = function () {
                    let file = this.files[0];
                    let reader = new FileReader();

                    reader.onload = function () {
                      callback(reader.result, { alt: file.name });
                    };

                    reader.readAsDataURL(file);
                  };

                  input.click();
                }
              });
              $('#instrTable .instr-text').each(function () { autoResizeTextarea(this); });
            }, 150);

            // ----- Attachments -----
            $('#existingAttachments').empty();
            loadExistingAttachments(d.attachments || []);

            // ----- Fleet / Device -----
            $('#fleet').val(d.fleet || '').trigger('change');
            const devices = Array.isArray(d.device) ? d.device : (d.device ? [d.device] : []);
            $('#device').val(devices).trigger('change');

            // ----- Finally show the form -----
            $('#createForm').removeClass('hidden');
          })
          .catch(err => {
            console.error(err);
            showAlert('danger', 'Failed to load SEA: ' + err.message);
            $('#choiceScreen').removeClass('hidden');
          });
      };
      // -------------------------------------------------
      // SEARCH
      // -------------------------------------------------
      // $('#searchInput').on('input', function () {
      //   const term = this.value.toLowerCase();
      //   $('.sea-card').each(function () {
      //     const txt = this.textContent.toLowerCase();
      //     $(this).closest('.col-md-6')[txt.includes(term) ? 'show' : 'hide']();
      //   });
      // });

      // -------------------------------------------------
      // STARTUP
      // -------------------------------------------------
      hideAll();
      $('#choiceScreen').removeClass('hidden');

      const urlParams = new URLSearchParams(window.location.search);
      const editId = urlParams.get('id');
      if (editId) editSea(editId);

      // Click-to-expand for SEA descriptions
      document.addEventListener('click', function (e) {
        if (e.target.classList.contains('expand-desc')) {
          e.preventDefault();
          const shortSpan = e.target.previousElementSibling;
          const fullText = shortSpan.dataset.full;
          const shortText = shortSpan.dataset.short;

          if (shortSpan.dataset.expanded) {
            // Collapse
            shortSpan.innerHTML = shortText;
            shortSpan.style = 'max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; display:inline-block;';
            e.target.innerHTML = '[show more]';
            delete shortSpan.dataset.expanded;
          } else {
            // Expand
            shortSpan.innerHTML = fullText;
            shortSpan.style = '';
            e.target.innerHTML = '[show less]';
            shortSpan.dataset.expanded = '1';
          }
        }
      });

      // -------------------------------------------------
      // COLLECT PARTS DATA
      // -------------------------------------------------
      function getParts() {
        const parts = [];
        $('#partsTable tbody tr').each(function () {
          const row = $(this);
          parts.push({
            part: row.find('.part-input').val().trim(),
            desc: row.find('.desc-input').val().trim(),
            type: row.find('.type-select').val().trim(),
            qty: row.find('.qty-input').val().trim()
          });
        });
        return parts;
      }
      // -------------------------------------------------
      // COLLECT INSTRUCTIONS DATA
      // -------------------------------------------------
      function getInstructions() {
        const instructions = [];
        $('#instrTable tbody tr').each(function () {
          const row = $(this);
          instructions.push({
            instruction: row.find('.instr-text').val().trim(),
            notes: row.find('.instr-notes').val().trim()
          });
        });
        return instructions;
      }

      window.removeInstrRow = function (btn) {
        // destroy TinyMCE instance first
        const editor = tinymce.get($(btn).closest('tr').find('.instr-text').attr('id'));
        if (editor) editor.remove();

        $(btn).closest('tr').remove();
        renumberInstr();               // <-- renumber after delete
      };
      // -------------------------------------------------
      // RE-NUMBER INSTRUCTION ROWS AFTER DELETE
      // -------------------------------------------------
      function renumberInstr() {
        $('#instrTable tbody tr').each(function (i) {
          $(this).find('td:first').text(i + 1);
          // also update the hidden textarea name so PHP still receives sequential indexes
          const $txt = $(this).find('.instr-text');
          const $notes = $(this).find('.instr-notes');
          const idx = i;
          $txt.attr('name', `instructions[${idx}][instruction]`);
          $notes.attr('name', `instructions[${idx}][notes]`);
        });
      };


      // -------------------------------------------------
      // RESET THE WHOLE FORM (including TinyMCE, Select2, tables)
      // -------------------------------------------------
      // RESET FORM — MUST ACCEPT isCreate
      function resetForm(isCreate = false) {
        const formEl = document.getElementById('seaForm');
        if (formEl?.reset) formEl.reset();

        $('#fleet, #device, #priority, #status').val('').trigger('change');
        tinymce.remove('#instrTable .instr-text');
        $('#instrTable tbody').empty();
        $('#partsTable tbody').empty();

        if (isCreate) {
          addPartRow(); // Only on new SEA
        }

        $('#existingAttachments').empty().html('<small class="text-muted">No attachments</small>');
        $('#attachments').val('');
        $('#ea_number, #revision, #impact, #justification, #description, #requester, #target_date').val('');
        $('.alert').remove();
      }

    </script>

    <!-- Overwrite Confirmation Modal -->
    <div class="modal fade" id="overwriteModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title text-warning">File Already Exists</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p>The following file(s) already exist:</p>
            <ul id="conflictList" class="list-unstyled"></ul>
            <p>Do you want to <strong>overwrite</strong> them?</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-warning" id="confirmOverwrite">Overwrite</button>
          </div>
        </div>
      </div>
    </div>

</body>

</html>