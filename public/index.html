<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Simulator Engineering Authoring Tool</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">

  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="shortcut icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />

  <style>
    #instrTable .instr-text {
      resize: none;
      overflow: hidden;
      min-height: 60px;
    }

    .tox-tinymce--loading::after {
      content: "Loading editor...";
      position: absolute;
      inset: 0;
      background: rgba(255,255,255,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      font-style: italic;
      pointer-events: none;
    }

    .visually-hidden {
      position: absolute !important;
      width: 1px !important;
      height: 1px !important;
      padding: 0 !important;
      margin: -1px !important;
      overflow: hidden !important;
      clip: rect(0, 0, 0, 0) !important;
      white-space: nowrap !important;
      border: 0 !important;
    }
  </style>

  <script src="https://cdn.tiny.cloud/1/h9xs5cld1bkmamb6zycl5ymhfanahso689gglclrgt5gldlx/tinymce/7/tinymce.min.js"
    referrerpolicy="origin"></script>

  <!-- CRITICAL GLOBAL FUNCTIONS -->
  <script>
    function loadExistingAttachments(attachments) {
      const $c = $('#existingAttachments').empty();
      if (!attachments || !attachments.length) {
        $c.html('<small class="text-muted">No attachments</small>');
        return;
      }

      const list = attachments.map(url => {
        const name = url.split('/').pop();
        const full = url.startsWith('http') ? url : location.origin + url;
        const escAttr = url.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        const escJS   = url.replace(/\\/g, '\\\\').replace(/'/g, "\\'");

        return `<div class="d-flex align-items-center mb-1 p-2 border rounded bg-light">
                  <a href="${full}" target="_blank" class="text-decoration-none me-2 flex-grow-1">${name}</a>
                  <button type="button" class="btn btn-sm btn-outline-danger"
                          onclick="removeExistingAttachment(this, '${escJS}')">Remove</button>
                  <input type="hidden" name="keep_attachments[]" value="${escAttr}">
                </div>`;
      }).join('');

      $c.html(`<div class="border p-2 rounded bg-white mb-2">
                <small class="text-muted d-block mb-2"><strong>Current attachments:</strong></small>${list}
              </div>`);
    }

    function removeExistingAttachment(btn, url) {
      if (!confirm('Remove this attachment?')) return;
      $(btn).closest('div').remove();
    }
  </script>
</head>

<body>
  <div class="container mt-5">

    <!-- CHOICE SCREEN -->
    <div id="choiceScreen">
      <h1 class="text-center mb-5">Simulator Engineering Authoring Tool</h1>
      <div class="row g-4">
        <div class="col-md-6">
          <div class="card choice-card h-100 text-center p-4" onclick="showCreateForm()">
            <h2 class="text-primary">Create New SEA</h2>
            <p class="text-muted">Start a fresh engineering authorization</p>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card choice-card h-100 text-center p-4" onclick="showSeaList()">
            <h2 class="text-success">View / Edit Existing SEA</h2>
            <p class="text-muted">Search and modify previous submissions</p>
          </div>
        </div>
      </div>

      <!-- ABOUT SECTION -->
      <footer id="siteFooter" class="mt-5">
        <div class="container">
          <div class="row">
            <div class="col-lg-12 mx-auto text-center">
              <h5>About the Simulator Engineering Authoring Tool (SEAT)</h5>
              <p>
                The <strong>Simulator Engineering Authoring Tool (SEAT)</strong> is a specialized web-based platform
                designed to simplify the creation, management, and documentation of <em>Simulator Engineering
                  Authorizations (SEAs)</em>. Built for engineering teams in aviation and simulation industries...
              </p>
              <!-- ... rest of about text unchanged ... -->
              <p class="text-muted small" id="versionInfo"><em>Loading version...</em></p>

              <script>
                const repo = 'rhall290472/ea-web';
                const ref  = 'main';
                fetch(`https://api.github.com/repos/${repo}/git/ref/heads/${ref}`)
                  .then(r => r.ok ? r.json() : Promise.reject())
                  .then(data => {
                    const sha = data.object.sha;
                    const shortSha = sha.slice(0,7);
                    return fetch(`https://api.github.com/repos/${repo}/tags?per_page=100`)
                      .then(r => r.ok ? r.json() : [])
                      .then(tags => {
                        const tag = tags.find(t => t.commit.sha === sha);
                        return { sha, shortSha, tag: tag?.name ?? null };
                      });
                  })
                  .then(({sha, shortSha, tag}) => {
                    const version = tag || shortSha;
                    const link = `https://github.com/${repo}/commit/${sha}`;
                    const date = new Date().toLocaleDateString('en-US',{year:'numeric',month:'short',day:'numeric'});
                    document.getElementById('versionInfo').innerHTML = `
                      <strong>Version:</strong> <a href="${link}" target="_blank">${version}</a>
                      <code class="text-muted">(${shortSha})</code> |
                      <strong>Last Updated:</strong> ${date}`;
                  })
                  .catch(() => {
                    document.getElementById('versionInfo').innerHTML = '<em>Version info unavailable</em>';
                  });
              </script>
            </div>
          </div>
        </div>
      </footer>
    </div>

    <!-- CREATE / EDIT FORM -->
    <div id="createForm" class="hidden">
      <button class="btn btn-sm btn-outline-secondary mb-3" onclick="goBack()">Back</button>
      <h2 id="formTitle" class="mb-3 d-flex justify-content-between align-items-center">
        <span>New SEA</span>
        <div>
          <button type="button" class="btn btn-sm btn-outline-secondary me-2" onclick="showSeaList()">Cancel</button>
          <button type="button" class="btn btn-sm btn-secondary" onclick="goBack()">Back</button>
        </div>
      </h2>

      <form id="seaForm" class="needs-validation" novalidate enctype="multipart/form-data">
        <input type="hidden" id="sea_action" name="action" value="create">
        <input type="hidden" id="sea_id" name="sea_id" value="">

        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label for="display_id" class="form-label">SEA ID</label>
            <input type="text" class="form-control bg-light" id="display_id" readonly placeholder="Auto-generated">
          </div>
          <div class="col-md-4">
            <label for="ea_number" class="form-label">Source Document#</label>
            <input type="text" class="form-control" id="ea_number" name="ea_number" placeholder="e.g. EA-12345">
          </div>
          <div class="col-md-4">
            <label for="revision" class="form-label">Source Document Revision</label>
            <input type="text" class="form-control" id="revision" name="revision" placeholder="e.g. A">
          </div>

          <div class="col-md-12">
            <label for="requester" class="form-label">Author</label>
            <input type="text" class="form-control" id="requester" name="requester" required>
          </div>

          <div class="col-md-12">
            <label for="description" class="form-label">Description</label>
            <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
          </div>

          <div class="col-md-12">
            <label for="justification" class="form-label">Justification</label>
            <textarea class="form-control" id="justification" name="justification" rows="2"></textarea>
          </div>

          <div class="col-md-12">
            <label for="impact" class="form-label">Impact Assessment</label>
            <textarea class="form-control" id="impact" name="impact" rows="5"></textarea>
          </div>

          <div class="col-md-4">
            <label for="priority" class="form-label">Priority</label>
            <select class="form-select" id="priority" name="priority">
              <option value="Low">Low</option>
              <option value="Medium" selected>Medium</option>
              <option value="High">High</option>
              <option value="Critical">Critical</option>
            </select>
          </div>

          <div class="col-md-4">
            <label for="target_date" class="form-label">Target Date</label>
            <input type="date" class="form-control" id="target_date" name="target_date">
          </div>

          <div class="col-md-4">
            <label for="status" class="form-label">Status</label>
            <select class="form-select" id="status" name="status">
              <option value="Planning" selected>Planning</option>
              <option value="In Work">In Work</option>
              <option value="Completed">Completed</option>
              <option value="On Hold">On Hold</option>
            </select>
          </div>

          <div class="col-md-6">
            <label for="fleet" class="form-label">Fleet</label>
            <select class="form-select select2" id="fleet" name="fleet" required>
              <option value="">-- Select Fleet --</option>
              <option value="737">737</option>
              <option value="737-MAX">737-MAX</option>
              <option value="757">757</option>
              <option value="767">767</option>
              <option value="777">777</option>
              <option value="787">787</option>
              <option value="A320">A320</option>
            </select>
            <div class="invalid-feedback">Please select a fleet.</div>
          </div>

          <div class="col-md-6">
            <label for="device" class="form-label">Device(s)</label>
            <select class="form-select select2" id="device" name="device[]" multiple></select>
          </div>

          <div class="col-md-12">
            <label for="attachments" class="form-label">Attachments</label>
            <input type="file" class="form-control" id="attachments" name="attachments[]" multiple>
            <div id="existingAttachments" class="mt-2"></div>
          </div>
        </div>

        <h4 class="mt-4">Affected Parts</h4>
        <table class="table table-sm parts-table" id="partsTable">
          <thead>
            <tr>
              <th>Part #</th>
              <th>Description</th>
              <th>Type</th>
              <th>Qty</th>
              <th style="width:50px;"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <button type="button" class="btn btn-outline-secondary btn-sm mb-3" onclick="addPartRow()">+ Add Part</button>

        <h4 class="mt-4">Work Instructions</h4>
        <table class="table table-sm instr-table" id="instrTable">
          <thead>
            <tr>
              <th style="width:5%;">#</th>
              <th style="width:70%;">Instruction</th>
              <th style="width:20%;">Notes</th>
              <th style="width:5%;"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <button type="button" class="btn btn-outline-secondary btn-sm mb-3" onclick="addInstrRow()">+ Add Instruction</button>

        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
          <button type="button" class="btn btn-secondary me-md-2" onclick="goBack()">Back</button>
          <button type="submit" id="submitBtn" class="btn btn-primary">Create SEA</button>
        </div>
      </form>
    </div>

    <!-- LIST VIEW -->
    <div id="listView" class="hidden">
      <button class="btn btn-sm btn-outline-secondary mb-3" onclick="goBack()">Back</button>
      <h3>Existing SEAs</h3>
      <div class="row mb-3 g-3">
        <div class="col-md-4">
          <input type="text" id="searchInput" class="form-control" placeholder="Search by keyword, ID, author...">
        </div>
        <div class="col-md-4">
          <select id="fleetFilter" class="form-select">
            <option value="">All Fleets</option>
          </select>
        </div>
        <div class="col-md-4">
          <select id="statusFilter" class="form-select">
            <option value="">All Statuses</option>
          </select>
        </div>
      </div>
      <div id="seaContainer" class="row"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
      // ───────────────────────────────────────────────
      // TinyMCE – LAZY INIT ON FIRST FOCUS (best quota saver)
      // ───────────────────────────────────────────────
      $(document).on('focus', 'textarea.instr-text:not(.tox-tinymce-init)', function () {
        const ta = this;
        if (ta.classList.contains('tox-tinymce-init')) return;

        ta.classList.add('tox-tinymce-init');
        ta.classList.add('tox-tinymce--loading'); // visual feedback

        tinymce.init({
          target: ta,
          height: 140,
          menubar: false,
          plugins: 'lists link image table code autoresize',
          toolbar: 'undo redo | bold italic underline | bullist numlist | link image | removeformat | code | table',
          toolbar_mode: 'wrap',
          branding: false,
          statusbar: true,
          resize: true,
          autoresize_bottom_margin: 12,

          images_upload_handler: function (blobInfo, progress) {
            return new Promise((resolve, reject) => {
              const xhr = new XMLHttpRequest();
              xhr.open('POST', './src/upload_image.php');
              xhr.upload.onprogress = e => progress(e.loaded / e.total * 100);

              xhr.onload = () => {
                if (xhr.status < 200 || xhr.status >= 300) return reject('HTTP ' + xhr.status);
                let json;
                try { json = JSON.parse(xhr.responseText); } catch { return reject('Invalid JSON'); }
                if (!json?.location) return reject('No location in response');

                const img = new Image();
                img.onload = () => {
                  const maxW = 600;
                  if (img.width <= maxW) return resolve(json.location);

                  const canvas = document.createElement('canvas');
                  const ctx = canvas.getContext('2d');
                  canvas.width = maxW;
                  canvas.height = (img.height * maxW) / img.width;
                  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                  canvas.toBlob(b => {
                    // For simplicity we resolve original + query param; you could re-upload
                    resolve(json.location + '?w=' + maxW);
                  }, blobInfo.blob().type);
                };
                img.src = URL.createObjectURL(blobInfo.blob());
                setTimeout(() => resolve(json.location), 150); // fallback
              };

              xhr.onerror = () => reject('Upload failed');
              const fd = new FormData();
              fd.append('file', blobInfo.blob(), blobInfo.filename());
              fd.append('sea_id', $('#sea_id').val() || 'temp');
              xhr.send(fd);
            });
          },

          setup: ed => {
            ed.on('init', () => {
              ta.classList.remove('tox-tinymce--loading');
              ta.classList.add('tox-tinymce--active');
            });
            ed.on('change keyup', () => {
              ed.save();
              try { autoResizeTextarea(ed.getElement()); } catch {}
            });
          }
        });
      });

      // ───────────────────────────────────────────────
      // Helpers
      // ───────────────────────────────────────────────
      function h(s) {
        if (s == null) return '';
        return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
                        .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
      }

      function autoResizeTextarea(el) {
        el.style.height = 'auto';
        el.style.height = el.scrollHeight + 'px';
      }

      const fleetDeviceMap = {
        '737':      ['FFS-2','FFS-3','FFS-4','FFS-5','FFS-6','FTD-2','FTD-3','FTD-4','FFS-7','FFS-8','FFS-9','FFS-10'],
        '737-MAX':  ['FFS-1','FFS-2','FFS-3','FFS-4','FFS-5','FFS-6','FFS-7','FFS-8','FFS-9','FFS-10','FFS-11','FTD-1','FTD-2','FTD-3','FTD-4','FTD-5','FTD-6','FTD-7','FTD-8','FTD-9','FTD-10','FTD-11'],
        // ... rest unchanged ...
      };

      let stepCounter = 1;

      // ───────────────────────────────────────────────
      // Document ready
      // ───────────────────────────────────────────────
      $(document).ready(function () {
        const debouncedSave = debounce(saveDraft, 800);

        $('#impact, #justification, #description, #requester, #ea_number').on('input', debouncedSave);
        $('#priority, #status, #fleet, #target_date').on('change', debouncedSave);

        $('#fleet').select2({ placeholder: "Select Fleet", allowClear: true });
        $('#device').select2({ placeholder: "Select Device(s)", allowClear: true });

        $('#fleet').on('change', function () {
          const fleet = $(this).val();
          const $dev = $('#device').empty().trigger('change');
          if (fleet && fleetDeviceMap[fleet]) {
            fleetDeviceMap[fleet].forEach(d => $dev.append(`<option value="${d}">${d}</option>`));
          }
          generateIdPreview();
        });

        $('#justification').on('input', function () { autoResizeTextarea(this); });

        $('#seaForm').on('submit', function (e) {
          e.preventDefault();
          // ... your existing submit logic remains unchanged ...
          // (just make sure tinymce.triggerSave() is still called before collecting data)
          tinymce.triggerSave();
          // rest of your ajax / FormData code ...
        });

        // ───────────────────────────────────────────────
        // Row adders (NO tinymce.init here anymore!)
        // ───────────────────────────────────────────────
        window.addPartRow = function (data = {}) {
          const row = `<tr>
            <td><input type="text" class="form-control form-control-sm part-input" value="${h(data.part||'')}" ></td>
            <td><input type="text" class="form-control form-control-sm desc-input" value="${h(data.desc ||'')}" ></td>
            <td>
              <select class="form-control form-control-sm type-select">
                <option value="" ${data.type===''?'selected':''}></option>
                <option value="add" ${data.type==='add'?'selected':''}>Add</option>
                <option value="remove" ${data.type==='remove'?'selected':''}>Remove</option>
                <option value="modify" ${data.type==='modify'?'selected':''}>Modify</option>
              </select>
            </td>
            <td><input type="number" class="form-control form-control-sm qty-input" value="${h(data.qty||'')}" min="1"></td>
            <td><button type="button" class="btn btn-sm btn-outline-danger remove-row">×</button></td>
          </tr>`;
          $('#partsTable tbody').append(row);
        };

        window.addInstrRow = function (data = {}) {
          const idx = $('#instrTable tbody tr').length;
          const row = `
            <tr>
              <td class="text-center align-middle">${idx + 1}</td>
              <td>
                <textarea class="form-control instr-text" name="instructions[${idx}][instruction]"
                  placeholder="Enter instruction..." rows="1">${(data.instruction||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</textarea>
              </td>
              <td>
                <input type="text" class="form-control instr-notes" name="instructions[${idx}][notes]"
                  value="${h(data.notes||'')}" placeholder="Notes">
              </td>
              <td class="text-center align-middle">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeInstrRow(this)">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>`;
          $('#instrTable tbody').append(row);
          renumberInstr();
        };

        window.removeInstrRow = function (btn) {
          const $row = $(btn).closest('tr');
          const ta = $row.find('textarea.instr-text')[0];
          if (ta && tinymce.get(ta.id)) tinymce.get(ta.id).remove();
          $row.remove();
          renumberInstr();
        };

        function renumberInstr() {
          $('#instrTable tbody tr').each((i, tr) => {
            $(tr).find('td:first').text(i + 1);
          });
        }

        // ... rest of your functions: showCreateForm, editSea, loadSeaList, filterList, getParts, getInstructions, resetForm, etc. ...
        // (keep them mostly unchanged – just ensure no tinymce.init calls remain except the lazy one above)

        // Startup
        hideAll();
        $('#choiceScreen').removeClass('hidden');

        const urlParams = new URLSearchParams(window.location.search);
        const editId = urlParams.get('id');
        if (editId) editSea(editId);
      });

      // Keep your other helpers: debounce, saveDraft, loadDraft, showCreateForm, goBack, hideAll, etc.
    </script>

    <!-- Overwrite Modal (unchanged) -->
    <div class="modal fade" id="overwriteModal" tabindex="-1">
      <!-- ... your modal code ... -->
    </div>
  </body>
</html>