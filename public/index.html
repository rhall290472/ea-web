<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Simulator Engineering Authoring Tool</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    /* ---- AUTO-RESIZE FOR INSTRUCTION TEXTAREA ---- */
    #instrTable .instr-text {
      resize: none;
      /* no manual resize handle */
      overflow: hidden;
      /* hide scrollbars */
      min-height: 60px;
      /* same as original */
    }
  </style>

  <!-- ====== CRITICAL: DEFINE FUNCTIONS FIRST ====== -->
  <script>
    // GLOBAL: Must be defined BEFORE any inline onclick
    function loadExistingAttachments(attachments) {
      const $c = $('#existingAttachments').empty();
      if (!attachments || !attachments.length) {
        $c.html('<small class="text-muted">No attachments</small>');
        return;
      }

      const list = attachments.map(url => {
        const name = url.split('/').pop();
        const full = url.startsWith('http') ? url : location.origin + url;

        // Escape for HTML attribute
        const escAttr = url.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        // Escape for JS string (single quotes)
        const escJS = url.replace(/\\/g, '\\\\').replace(/'/g, "\\'");

        return `<div class="d-flex align-items-center mb-1 p-2 border rounded bg-light">
                  <a href="${full}" target="_blank" class="text-decoration-none me-2 flex-grow-1">${name}</a>
                  <button type="button" class="btn btn-sm btn-outline-danger"
                          onclick="removeExistingAttachment(this, '${escJS}')">Remove</button>
                  <input type="hidden" name="keep_attachments[]" value="${escAttr}">
                </div>`;
      }).join('');

      $c.html(`<div class="border p-2 rounded bg-white mb-2">
                <small class="text-muted d-block mb-2"><strong>Current attachments:</strong></small>${list}
              </div>`);
    }

    function removeExistingAttachment(btn, url) {
      if (!confirm('Remove this attachment?')) return;
      $(btn).closest('div').remove();
    }
  </script>
  <!-- ====== END CRITICAL SECTION ====== -->
</head>

<body>
  <div class="container mt-5">

    <!-- ====================== CHOICE SCREEN ====================== -->
    <div id="choiceScreen">
      <h1 class="text-center mb-5">Simulator Engineering Authoring Tool</h1>
      <div class="row g-4">
        <div class="col-md-6">
          <div class="card choice-card h-100 text-center p-4" onclick="showCreateForm()">
            <h2 class="text-primary">Create New SEA</h2>
            <p class="text-muted">Start a fresh engineering authorization</p>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card choice-card h-100 text-center p-4" onclick="showSeaList()">
            <h2 class="text-success">View / Edit Existing SEA</h2>
            <p class="text-muted">Search and modify previous submissions</p>
          </div>
        </div>
      </div>

      <!-- ABOUT SECTION – ONLY ON CHOICE SCREEN -->
      <footer id="siteFooter">
        <div class="container">
          <div class="row">
            <div class="col-lg-12 mx-auto text-center">
              <h5>About the Simulator Engineering Authoring Tool (SEAT)</h5>
              <p>
                The <strong>Simulator Engineering Authoring Tool (SEAT)</strong> is a specialized web-based platform
                designed to simplify the creation, management, and documentation of <em>Simulator Engineering
                  Authorizations (SEAs)</em>. Built for engineering teams in aviation and simulation industries, SEAT
                provides an intuitive interface for handling authorization requests related to aircraft simulator
                fleets, such as Boeing 737, 777, 787, and Airbus A320 models.
              </p>
              <p>
                It ensures compliance, traceability, and efficiency by digitizing the entire workflow—from initial
                submission to PDF generation and archival.
              </p>

              <h6>Key Features:</h6>
              <ul class="list-unstyled text-start d-inline-block">
                <li>SEA Creation and Editing</li>
                <li>Parts and Instructions Management</li>
                <li>Attachment Handling</li>
                <li>PDF Generation with embedded attachments</li>
                <li>SEA Dashboard with search and actions</li>
                <li>Fleet-Specific Device Selection</li>
                <li>User-Friendly Responsive Interface</li>
              </ul>

              <p class="mt-3">
                SEAT addresses the challenges of manual engineering authorization processes by providing a centralized,
                digital solution that reduces errors, speeds up approvals, and maintains an audit trail. It's ideal for
                simulator maintenance teams, engineers, and requesters who need to document changes, justify
                modifications, and assess impacts on critical training equipment.
              </p>

              <p class="text-muted small">
                <em>Developed with PHP, mPDF, Bootstrap, and modern web technologies. Extensible and deployable on
                  standard web servers.</em><br>
                <strong>Version:</strong> 1.0 | <strong>Last Updated:</strong> November 2025
              </p>
            </div>
          </div>
        </div>
      </footer>
    </div>

    <!-- ====================== CREATE / EDIT FORM ====================== -->
    <div id="createForm" class="hidden">
      <button class="btn btn-sm btn-outline-secondary mb-3" onclick="goBack()">Back</button>
      <h3 id="formTitle">New SEA</h3>

      <form id="seaForm" class="row g-3" enctype="multipart/form-data">
        <input type="hidden" name="sea_id" id="sea_id">
        <input type="hidden" name="action" id="sea_action" value="create">
        <input type="hidden" name="parts_json" id="parts_json">
        <input type="hidden" name="instructions_json" id="instructions_json">

        <div class="col-md-4">
          <label>SEA ID</label>
          <input type="text" class="form-control" id="display_id" disabled>
        </div>
        <div class="col-md-4">
          <label>EA#</label>
          <input type="text" class="form-control" name="ea_number" id="ea_number">
        </div>
        <div class="col-md-4">
          <label>Revision</label>
          <input type="text" class="form-control" name="revision" id="revision">
        </div>
        <div class="col-12">
          <label>Title</label>
          <textarea class="form-control" name="description" id="description" rows="3"></textarea>
        </div>
        <div class="col-md-6">
          <label>Fleet</label>
          <select class="form-select" name="fleet" id="fleet">
            <option value="">Select Fleet</option>
            <option value="737">737</option>
            <option value="737-MAX">737 MAX</option>
            <option value="757">757</option>
            <option value="767">767</option>
            <option value="777">777</option>
            <option value="787">787</option>
            <option value="A320">A320</option>
          </select>
        </div>
        <div class="col-md-4" id="deviceCol" style="display:none">
          <label>Device(s)</label>
          <select class="form-select" id="device" name="device[]" multiple></select>
        </div>

        <div class="col-md-6">
          <label>Requester <span class="text-danger">*</span></label>
          <input type="text" class="form-control" name="requester" id="requester" required>
        </div>
        <div class="col-md-4"> <!-- NEW: Status Dropdown -->
          <label>Status</label>
          <select class="form-control" name="status" id="status">
            <option value="Planning">Planning</option>
            <option value="In Work">In Work</option>
            <option value="Completed">Completed</option>
            <option value="Completed">On Hold</option>
          </select>
        </div>
        <div class="col-12">
          <label>Background</label>
          <textarea class="form-control" name="justification" id="justification" rows="3"></textarea>
        </div>
        <div class="col-12">
          <label>Impact</label>
          <textarea class="form-control" name="impact" id="impact" rows="2"></textarea>
        </div>
        <div class="col-md-4">
          <label>Priority</label>
          <select class="form-select" name="priority" id="priority">
            <option value="Low">Low</option>
            <option value="Medium" selected>Medium</option>
            <option value="High">High</option>
            <option value="Critical">Critical</option>
          </select>
        </div>
        <div class="col-md-4">
          <label>Target Date</label>
          <input type="date" class="form-control" name="target_date" id="target_date">
        </div>

        <!-- PARTS TABLE -->
        <div class="col-12">
          <h5>Affected Parts</h5>
          <table class="table table-sm parts-table" id="partsTable">
            <thead>
              <tr>
                <th>Part #</th>
                <th>Description</th>
                <th>Type</th>
                <th>Qty</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <button type="button" class="btn btn-sm btn-outline-primary" onclick="addPartRow()">+ Add Part</button>
        </div>

        <!-- INSTRUCTIONS TABLE -->
        <div class="col-12">
          <h5>Work Instructions</h5>
          <table class="table table-sm instr-table" id="instrTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Instruction</th>
                <th>Notes</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <button type="button" class="btn btn-sm btn-outline-primary" onclick="addInstrRow()">+ Add
            Instruction</button>
        </div>

        <!-- ATTACHMENTS -->
        <div class="col-12">
          <h5>Attachments</h5>
          <input type="file" class="form-control" name="attachments[]" multiple
            accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
          <div id="existingAttachments" class="mt-2"></div>
        </div>

        <div class="col-12 text-end">
          <button type="submit" id="submitBtn" class="btn btn-success">Create SEA</button>
        </div>
      </form>
    </div>

    <!-- ====================== LIST VIEW ====================== -->
    <div id="listView" class="hidden">
      <button class="btn btn-sm btn-outline-secondary mb-3" onclick="goBack()">Back</button>
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>All SEAs</h3>
        <input type="text" class="form-control w-auto" id="searchInput" placeholder="Search...">
      </div>
      <div class="row" id="seaContainer">
        <!-- Loaded via AJAX -->
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <script>
    // -------------------------------------------------
    // AUTO-RESIZE TEXTAREA (Instruction field)
    // -------------------------------------------------
    function autoResizeTextarea(el) {
      el.style.height = 'auto';                     // allow shrinking
      el.style.height = el.scrollHeight + 'px';     // fit content
    }

    $(document).ready(function () {
      let stepCounter = 1;

      // === FLEET → DEVICE MAP (YOUR ORIGINAL) ===
      const fleetDeviceMap = {
        '737': ['FFS-2', 'FFS-3', 'FFS-4', 'FFS-5', 'FFS-6', 'FTD-2', 'FTD-3', 'FTD-4', 'FFS-7', 'FFS-8', 'FFS-9', 'FFS-10'],
        '737-MAX': ['FFS-1', 'FFS-2', 'FFS-3', 'FFS-4', 'FFS-5', 'FFS-6', 'FFS-7', 'FFS-8', 'FFS-9', 'FFS-10', 'FFS-11',
          'FTD-1', 'FTD-2', 'FTD-3', 'FTD-4', 'FTD-5', 'FTD-6', 'FTD-7', 'FTD-8', 'FTD-9', 'FTD-10', 'FTD-11'],
        '757': ['FFS-1', 'FFS-2', 'FFS-3', 'FTD-1', 'FTD-2'],
        '767': ['FFS-3', 'FFS-4', 'FFS-5'],
        '777': ['FFS-1', 'FFS-2', 'FFS-3', 'FFS-5', 'FTD-1', 'FTD-2', 'FFS-6', 'FFS-7', 'FTD-3'],
        '787': ['FFS-1', 'FFS-2', 'FFS-3', 'FFS-4', 'FFS-5', 'FFS-6', 'FFS-7', 'FFS-8', 'FFS-9', 'FTD-1', 'FTD-2', 'FTD-3', 'FTD-4', 'FTD-5', 'FTD-6'],
        'A320': ['FFS-1', 'FFS-4', 'FTD-1', 'FTD-2', 'FFS-6', 'FFS-7', 'FFS-8', 'FFS-9', 'FFS-10', 'FFS-11', 'FFS-12',
          'FTD-3', 'FTD-4', 'FTD-5', 'FTD-6']
      };

      // -------------------------------------------------
      // SELECT2 INITIALISATION
      // -------------------------------------------------
      $('#fleet').select2({ placeholder: "Select Fleet", allowClear: true });
      $('#device').select2({ placeholder: "Select Device(s)", allowClear: true });

      // -------------------------------------------------
      // FLEET → DEVICE POPULATION
      // -------------------------------------------------
      $('#fleet').on('change', function () {
        const fleet = $(this).val();
        const $device = $('#device');
        $device.empty().trigger('change');
        $('#deviceCol').toggle(!!fleet);
        if (fleet && fleetDeviceMap[fleet]) {
          fleetDeviceMap[fleet].forEach(d => $device.append(`<option value="${d}">${d}</option>`));
        }
      });

      // -------------------------------------------------
      // PARTS ROW
      // -------------------------------------------------
      window.addPartRow = function (data = {}) {
        const row = `<tr>
          <td><input type="text" class="form-control" value="${data.part || ''}"></td>
          <td><input type="text" class="form-control" value="${data.desc || ''}"></td>
          <td><input type="text" class="form-control" value="${data.type || ''}"></td>
          <td><input type="number" class="form-control" value="${data.qty || ''}" min="1"></td>
          <td><button type="button" class="btn btn-sm btn-outline-danger remove-row">×</button></td>
        </tr>`;
        $('#partsTable tbody').append(row);
      };

      // -------------------------------------------------
      // INSTRUCTION ROW (with auto-resize)
      // -------------------------------------------------
      window.addInstrRow = function (data = {}) {
        const row = `<tr>
          <td class="step-num">${stepCounter++}</td>
          <td><textarea class="form-control instr-text" placeholder="Enter instruction...">${data.instruction || ''}</textarea></td>
          <td><input type="text" class="form-control instr-notes" placeholder="Notes" value="${data.notes || ''}"></td>
          <td><button type="button" class="btn btn-sm btn-outline-danger remove-row">×</button></td>
        </tr>`;
        $('#instrTable tbody').append(row);

        // Resize if there is already content (e.g., edit mode)
        const ta = $('#instrTable tbody tr:last-child .instr-text')[0];
        if (ta && ta.value) autoResizeTextarea(ta);
      };

      // Resize on typing (delegated)
      $('#instrTable tbody').on('input', '.instr-text', function () {
        autoResizeTextarea(this);
      });

      // -------------------------------------------------
      // REMOVE ROW (update step numbers)
      // -------------------------------------------------
      $(document).on('click', '.remove-row', function () {
        $(this).closest('tr').remove();
        $('#instrTable tbody .step-num').each((i, el) => $(el).text(i + 1));
        stepCounter = $('#instrTable tbody tr').length + 1;
      });

      // -------------------------------------------------
      // FORM SUBMIT
      // -------------------------------------------------
      $('#seaForm').on('submit', function (e) {
        e.preventDefault();
        const $btn = $('#submitBtn').prop('disabled', true).text('Saving...');

        // ---- Parts JSON ----
        const parts = [];
        $('#partsTable tbody tr').each(function () {
          const inputs = $(this).find('input');
          const p = {
            part: inputs[0].value.trim(),
            desc: inputs[1].value.trim(),
            type: inputs[2].value.trim(),
            qty: inputs[3].value.trim()
          };
          if (p.part) parts.push(p);
        });
        $('#parts_json').val(JSON.stringify(parts));

        // ---- Instructions JSON ----
        const instructions = [];
        $('#instrTable tbody tr').each(function () {
          const ta = $(this).find('.instr-text')[0];
          const notes = $(this).find('.instr-notes')[0];
          if (ta.value.trim()) {
            instructions.push({ instruction: ta.value, notes: notes.value });
          }
        });
        $('#instructions_json').val(JSON.stringify(instructions));

        const formData = new FormData(this);
        $.ajax({
          url: './src/submit.php',
          type: 'POST',
          data: formData,
          processData: false,
          contentType: false,
          dataType: 'json',
          success: function (res) {
            if (res.conflict) {  // NEW: Handle conflicts
              if (confirm(res.message)) {
                formData.append('overwrite', '1');
                $.ajax(this);  // Resubmit with same settings
              }
              return;
            }
            if (res.success) {
              showAlert('success', res.message);
              if ($('#sea_action').val() === 'create') {
                $('#sea_id').val(res.sea_id);
                $('#display_id').val(res.sea_id);
                $('#sea_action').val('update');
                $('#formTitle').text('Edit SEA – ' + res.sea_id);
                $('#submitBtn').text('Update SEA');
                history.replaceState(null, null, '?id=' + res.sea_id);
              }
              loadExistingAttachments(res.attachments);  // NEW: Update attachments list after success
              $('#attachments').val('');  // NEW: Clear file input
              // if (res.pdf) downloadPdf(res.pdf, res.pdf_name);  // If PDF is in response
            } else {
              showAlert('danger', res.message || 'Unknown error');
            }
          },
          error: function (xhr) {
            showAlert('danger', xhr.responseJSON?.message || 'Network error');
          },
          complete: function () {
            $btn.prop('disabled', false).text(
              $('#sea_action').val() === 'create' ? 'Create SEA' : 'Update SEA'
            );
          }
        });
      });

      function showAlert(type, message) {
        const alert = `<div class="alert alert-${type} alert-dismissible fade show mt-3" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
        $('#createForm').prepend(alert);
      }

      function downloadPdf(base64, filename) {
        const link = document.createElement('a');
        link.href = 'data:application/pdf;base64,' + base64;
        link.download = filename;
        link.click();
      }

      // -------------------------------------------------
      // NAVIGATION
      // -------------------------------------------------
      window.showCreateForm = function () {
        hideAll();
        $('#createForm').removeClass('hidden');
        if (!$('#sea_id').val()) {
          $('#sea_action').val('create');
          $('#formTitle').text('New SEA');
          $('#submitBtn').text('Create SEA');
          stepCounter = 1;
          $('#partsTable tbody').empty();
          $('#instrTable tbody').empty();
          $('#existingAttachments').html('<small class="text-muted">No attachments</small>');
          addPartRow();
          addInstrRow();
        }
      };

      window.showSeaList = function () {
        hideAll();
        $('#listView').removeClass('hidden');
        loadSeaList();
      };

      window.goBack = function () {
        hideAll();
        $('#choiceScreen').removeClass('hidden');
        history.replaceState(null, null, window.location.pathname);
      };

      function hideAll() {
        $('#choiceScreen, #createForm, #listView').addClass('hidden');
      }

      // -------------------------------------------------
      // LIST & EDIT
      // -------------------------------------------------
      function loadSeaList() {
        const $c = $('#seaContainer');
        $c.html('<div class="text-center py-5"><div class="spinner-border"></div> Loading...</div>');
        fetch('./src/list_seas.php')
          .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.text(); })
          .then(html => $c.html(html))
          .catch(err => $c.html(`<div class="alert alert-danger">Failed: ${err.message}</div>`));
      }

      window.deleteSea = function (id) {
        if (!confirm(`Delete SEA-${id}? This cannot be undone.`)) return;
        const f = document.createElement('form');
        f.method = 'POST'; f.action = './src/delete.php'; f.style.display = 'none';
        const i = document.createElement('input');
        i.type = 'hidden'; i.name = 'filename'; i.value = `sea-${id}.json`;
        f.appendChild(i); document.body.appendChild(f); f.submit();
      };

      window.editSea = function (id) {
        showCreateForm();
        $('#sea_action').val('update');
        $('#sea_id').val(id);
        $('#display_id').val(id);
        $('#formTitle').text('Edit SEA – ' + id);
        $('#submitBtn').text('Update SEA');

        fetch(`data/sea-${id}.json`)
          .then(r => { if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); })
          .then(d => {
            $('#ea_number').val(d.ea_number || '');
            $('#revision').val(d.revision || '');
            $('#requester').val(d.requester || '');
            $('#description').val(d.description || '');
            $('#justification').val(d.justification || '');
            $('#impact').val(d.impact || '');
            $('#priority').val(d.priority || 'Medium');
            $('#target_date').val(d.target_date || '');
            $('#status').val(d.status || 'Planning');  // NEW: Set status

            $('#partsTable tbody').empty();
            $('#instrTable tbody').empty();
            stepCounter = 1;
            (JSON.parse(d.parts_json || '[]') || []).forEach(addPartRow);
            (JSON.parse(d.instructions_json || '[]') || []).forEach(addInstrRow);

            // ---- RESIZE ALL INSTRUCTION TEXTAREAS AFTER LOAD ----
            setTimeout(() => {
              $('#instrTable .instr-text').each(function () {
                autoResizeTextarea(this);
              });
            }, 50);

            loadExistingAttachments(d.attachments || []);

            const savedFleet = d.fleet || '';
            const savedDevices = Array.isArray(d.device) ? d.device : (d.device ? [d.device] : []);

            $('#fleet').val(savedFleet).trigger('change');
            setTimeout(() => {
              $('#device').val(savedDevices).trigger('change');
            }, 100);
          })
          .catch(err => {
            console.error(err);
            showAlert('danger', 'Failed to load SEA: ' + err.message);
          });
      };

      // -------------------------------------------------
      // SEARCH
      // -------------------------------------------------
      $('#searchInput').on('input', function () {
        const term = this.value.toLowerCase();
        $('.sea-card').each(function () {
          const txt = this.textContent.toLowerCase();
          $(this).closest('.col-md-6')[txt.includes(term) ? 'show' : 'hide']();
        });
      });

      // -------------------------------------------------
      // STARTUP
      // -------------------------------------------------
      hideAll();
      $('#choiceScreen').removeClass('hidden');

      const urlParams = new URLSearchParams(window.location.search);
      const editId = urlParams.get('id');
      if (editId) editSea(editId);

      // Click-to-expand for SEA descriptions
      document.addEventListener('click', function (e) {
        if (e.target.classList.contains('expand-desc')) {
          e.preventDefault();
          const shortSpan = e.target.previousElementSibling;
          const fullText = shortSpan.dataset.full;
          const shortText = shortSpan.dataset.short;

          if (shortSpan.dataset.expanded) {
            // Collapse
            shortSpan.innerHTML = shortText;
            shortSpan.style = 'max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; display:inline-block;';
            e.target.innerHTML = '[show more]';
            delete shortSpan.dataset.expanded;
          } else {
            // Expand
            shortSpan.innerHTML = fullText;
            shortSpan.style = '';
            e.target.innerHTML = '[show less]';
            shortSpan.dataset.expanded = '1';
          }
        }
      });
    });
  </script>
</body>

</html>