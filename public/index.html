<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Simulator Engineering Authoring Tool</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .choice-card {
      cursor: pointer;
      transition: .2s
    }

    .choice-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, .1)
    }

    .sea-card:hover {
      background: #f8f9fa
    }

    .hidden {
      display: none
    }

    .parts-table th,
    .parts-table td,
    .instr-table th,
    .instr-table td {
      vertical-align: middle
    }

    .parts-table input,
    .parts-table textarea,
    .instr-table input,
    .instr-table textarea {
      width: 100%;
      border: none;
      padding: 6px;
    }

    .select2-container {
      width: 100% !important
    }

    #instrTable th:nth-child(2),
    #instrTable td:nth-child(2) {
      width: 75%;
    }

    #instrTable th:nth-child(3),
    #instrTable td:nth-child(3) {
      width: 20%;
    }

    #instrTable th:last-child,
    #instrTable td:last-child {
      width: 5%;
    }

    #instrTable .instr-text,
    #instrTable .instr-notes {
      width: 100%;
      min-height: 60px;
      resize: vertical;
    }
  </style>
</head>

<body>
  <div class="container mt-5">
    <!-- CHOICE SCREEN -->
    <div id="choiceScreen">
      <h1 class="text-center mb-5">Simulator Engineering Authoring Tool</h1>
      <div class="row g-4">
        <div class="col-md-6">
          <div class="card choice-card h-100 text-center p-4" onclick="showCreateForm()">
            <h2 class="text-primary">Create New SEA</h2>
            <p class="text-muted">Start a fresh engineering authorization</p>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card choice-card h-100 text-center p-4" onclick="showSeaList()">
            <h2 class="text-success">View / Edit Existing SEA</h2>
            <p class="text-muted">Search and modify previous submissions</p>
          </div>
        </div>
      </div>
    </div>

    <!-- CREATE / EDIT FORM -->
    <div id="createForm" class="hidden">
      <button class="btn btn-sm btn-outline-secondary mb-3" onclick="goBack()">Back</button>
      <h3 id="formTitle">New SEA</h3>

      <form id="seaForm" action="./src/submit.php" method="POST" enctype="multipart/form-data" class="row g-3">
        <input type="hidden" name="sea_id" id="sea_id">
        <input type="hidden" name="action" id="sea_action" value="create">
        <input type="hidden" name="parts_json" id="parts_json">
        <input type="hidden" name="instructions_json" id="instructions_json">

        <div class="col-md-6">
          <label>SEA ID</label>
          <input type="text" class="form-control" id="display_id" disabled>
        </div>
        <div class="col-md-6">
          <label>EA#</label>
          <input type="text" class="form-control" name="ea_number" id="ea_number">
        </div>
        <div class="col-md-4">
          <label>Revision</label>
          <input type="text" class="form-control" name="revision" id="revision">
        </div>
        <div class="col-md-4">
          <label>Fleet <span class="text-danger">*</span></label>
          <select class="form-select" id="fleet" name="fleet" required>
            <option value="">Select Fleet</option>
            <option value="737">737</option>
            <option value="737-MAX">737 MAX</option>
            <option value="757">757</option>
            <option value="767">767</option>
            <option value="777">777</option>
            <option value="787">787</option>
            <option value="A320">A320</option>
          </select>
        </div>
        <div class="col-md-4" id="deviceCol" style="display:none">
          <label>Device(s)</label>
          <select class="form-select" id="device" name="device[]" multiple></select>
          <small class="text-muted">Ctrl/Cmd to select multiple</small>
        </div>

        <div class="col-md-6">
          <label>Requester</label>
          <input type="text" class="form-control" name="requester" id="requester" required>
        </div>
        <div class="col-12">
          <label>Description</label>
          <textarea class="form-control" name="description" id="description" rows="3"></textarea>
        </div>
        <div class="col-12">
          <label>Justification</label>
          <textarea class="form-control" name="justification" id="justification" rows="3"></textarea>
        </div>
        <div class="col-12">
          <label>Impact</label>
          <textarea class="form-control" name="impact" id="impact" rows="2"></textarea>
        </div>
        <div class="col-md-4">
          <label>Priority</label>
          <select class="form-select" name="priority" id="priority">
            <option value="Low">Low</option>
            <option value="Medium" selected>Medium</option>
            <option value="High">High</option>
          </select>
        </div>
        <div class="col-md-4">
          <label>Target Date</label>
          <input type="date" class="form-control" name="target_date" id="target_date">
        </div>

        <div class="col-12">
          <label>Attachments</label>
          < <div id="existingAttachments" class="mb-2">
        </div>
        <input type="file" class="form-control" name="attachments[]" multiple>
        <small class="text-muted">Add new files (existing preserved unless removed)</small>
    </div>

    <div class="col-12">
      <h5>Affected Parts</h5>
      <table class="table table-sm parts-table" id="partsTable">
        <thead class="table-light">
          <tr>
            <th>Part #</th>
            <th>Description</th>
            <th>Type</th>
            <th>Qty</th>
            <th><button type="button" id="addPartRow" class="btn btn-sm btn-success">+</button></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="col-12">
      <h5>Work Instructions</h5>
      <table class="table table-sm instr-table" id="instrTable">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Instruction</th>
            <th>Notes</th>
            <th><button type="button" id="addInstrRow" class="btn btn-sm btn-success">+</button></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="col-12">
      <button type="submit" id="submitBtn" class="btn btn-primary w-100">Create SEA</button>
    </div>
    </form>
  </div>

  <!-- LIST SCREEN -->
  <div id="seaList" class="hidden">
    <button class="btn btn-sm btn-outline-secondary mb-3" onclick="goBack()">Back</button>
    <h3>Existing SEAs</h3>
    <div class="mb-3">
      <input type="text" class="form-control" id="searchInput" placeholder="Search...">
    </div>
    <div id="seaContainer" class="row"></div>
  </div>
  </div>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script>
    let stepCounter = 1;

    // === YOUR REAL FLEET → DEVICE MAP ===
    const fleetDeviceMap = {
      '737': ['FFS-2', 'FFS-3', 'FFS-4', 'FFS-5', 'FTD-1', 'FTD-2', 'FTD-3', 'FTD-4', 'FFS-6', 'FFS-7', 'FFS-8', 'FFS-9', 'FFS-10'],
      '737-MAX': ['FFS-1', 'FFS-2', 'FFS-3', 'FFS-4', 'FFS-5', 'FFS-6', 'FFS-7', 'FFS-8', 'FFS-9', 'FFS-10', 'FFS-11',
        'FTD-1', 'FTD-2', 'FTD-3', 'FTD-4', 'FTD-5', 'FTD-6', 'FTD-7', 'FTD-8', 'FTD-9', 'FTD-10', 'FTD-11'],
      '757': ['FFS-1', 'FFS-2', 'FFS-3', 'FTD-1', 'FTD-2'],
      '767': ['FFS-3', 'FFS-4', 'FFS-5'],
      '777': ['FFS-1', 'FFS-2', 'FFS-3', 'FFS-5', 'FTD-1', 'FTD-2', 'FFS-6', 'FFS-7', 'FTD-3'],
      '787': ['FFS-1', 'FFS-2', 'FFS-3', 'FFS-4', 'FFS-5', 'FFS-6', 'FFS-7', 'FFS-8', 'FFS-9', 'FTD-1', 'FTD-2', 'FTD-3', 'FTD-4', 'FTD-5', 'FTD-6'],
      'A320': ['FFS-1', 'FFS-4', 'FTD-1', 'FTD-2', 'FFS-6', 'FFS-7', 'FFS-8', 'FFS-9', 'FFS-10', 'FFS-11', 'FFS-12', 'FFS-13', 'FTD-3', 'FTD-4', 'FTD-5', 'FTD-6', 'FTD-7']
    };

    function getDevicesForFleet(fleet) {
      return fleetDeviceMap[fleet] || [];
    }

    function h(s) {
      return (s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function hideAll() { $('#choiceScreen, #createForm, #seaList').addClass('hidden'); }
    function showCreateForm() {
      hideAll(); $('#createForm').removeClass('hidden');
      if ($('#sea_action').val() === 'create') {
        $('#seaForm')[0].reset();
        $('#partsTable tbody').empty();
        $('#instrTable tbody').empty();
        $('#existingAttachments').empty();
        stepCounter = 1;
        $('#fleet').val('').trigger('change');
      }
    }
    function showSeaList() { hideAll(); $('#seaList').removeClass('hidden'); loadSeaList(); }
    function goBack() { hideAll(); $('#choiceScreen').removeClass('hidden'); }

    // === FLEET CHANGE HANDLER ===
    $('#fleet').on('change', function () {
      const fleet = this.value;
      $('#deviceCol').toggle(!!fleet);
      const $dev = $('#device').empty();
      if (fleet) {
        getDevicesForFleet(fleet).forEach(d => $dev.append(`<option value="${d}">${d}</option>`));
        if ($dev.data('select2')) $dev.select2('destroy');
        $dev.select2({ placeholder: 'Select device(s)', width: '100%' });
      } else {
        if ($dev.data('select2')) $dev.select2('destroy');
      }
    });

    // === PARTS ===
    function addPartRow(p = {}) {
      const row = `<tr>
        <td><input type="text" class="form-control" value="${h(p.part || '')}" placeholder="Part #"></td>
        <td><input type="text" class="form-control" value="${h(p.desc || '')}" placeholder="Description"></td>
        <td><select class="form-select">
          <option value="Add"    ${p.type === 'Add' ? 'selected' : ''}>Add</option>
          <option value="Remove" ${p.type === 'Remove' ? 'selected' : ''}>Remove</option>
          <option value="Replace"${p.type === 'Replace' ? 'selected' : ''}>Replace</option>
        </select></td>
        <td><input type="number" class="form-control" value="${h(p.qty || '1')}" min="1"></td>
        <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="$(this).closest('tr').remove(); updatePartsJson();">X</button></td>
      </tr>`;
      $('#partsTable tbody').append(row); updatePartsJson();
    }

    function updatePartsJson() {
      const parts = $('#partsTable tbody tr').map(function () {
        return {
          part: $(this).find('input:eq(0)').val().trim(), desc: $(this).find('input:eq(1)').val().trim(),
          type: $(this).find('select').val(), qty: $(this).find('input:eq(2)').val().trim()
        };
      }).get().filter(p => p.part);
      $('#parts_json').val(JSON.stringify(parts));
    }

    $('#addPartRow').on('click', () => addPartRow());

    // === INSTRUCTIONS ===
    function addInstrRow(i = {}) {
      const row = `<tr>
        <td class="text-center">${stepCounter++}</td>
        <td><textarea class="form-control instr-text">${h(i.instruction || '')}</textarea></td>
        <td><textarea class="form-control instr-notes">${h(i.notes || '')}</textarea></td>
        <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="$(this).closest('tr').remove(); updateInstrJson();">X</button></td>
      </tr>`;
      $('#instrTable tbody').append(row); updateInstrJson();
    }

    function updateInstrJson() {
      const instr = $('#instrTable tbody tr').map(function () {
        return { instruction: $(this).find('.instr-text').val().trim(), notes: $(this).find('.instr-notes').val().trim() };
      }).get().filter(i => i.instruction);
      $('#instructions_json').val(JSON.stringify(instr));
    }

    $('#addInstrRow').on('click', () => addInstrRow());
    $('#seaForm').on('input', () => { updatePartsJson(); updateInstrJson(); });

    // === LIST & EDIT ===
    function loadSeaList() {
      const $c = $('#seaContainer');
      $c.html('<div class="text-center py-5"><div class="spinner-border"></div> Loading...</div>');
      fetch('./src/list_seas.php')
        .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.text(); })
        .then(html => $c.html(html))
        .catch(err => $c.html(`<div class="alert alert-danger">Failed: ${err.message}</div>`));
    }

    function deleteSea(id) {
      if (!confirm(`Delete SEA-${id}?`)) return;
      const f = document.createElement('form'); f.method = 'POST'; f.action = './src/delete.php'; f.style.display = 'none';
      const i = document.createElement('input'); i.type = 'hidden'; i.name = 'filename'; i.value = `sea-${id}.json`;
      f.appendChild(i); document.body.appendChild(f); f.submit();
    }

    // === EDIT SEA (100% WORKING) ===
    function editSea(id) {
      showCreateForm();
      $('#sea_action').val('update');
      $('#sea_id').val(id);
      $('#display_id').val(id);
      $('#formTitle').text('Edit SEA – ' + id);
      $('#submitBtn').text('Update SEA');

      fetch(`data/sea-${id}.json`)
        .then(r => { if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); })
        .then(d => {
          $('#ea_number').val(d.ea_number || '');
          $('#revision').val(d.revision || '');
          $('#requester').val(d.requester || '');
          $('#description').val(d.description || '');
          $('#justification').val(d.justification || '');
          $('#impact').val(d.impact || '');
          $('#priority').val(d.priority || 'Medium');
          $('#target_date').val(d.target_date || '');

          $('#partsTable tbody').empty();
          $('#instrTable tbody').empty();
          stepCounter = 1;
          (JSON.parse(d.parts_json || '[]') || []).forEach(addPartRow);
          (JSON.parse(d.instructions_json || '[]') || []).forEach(addInstrRow);
          loadExistingAttachments(d.attachments);

          // === FLEET & DEVICES (GUARANTEED) ===
          const savedFleet = d.fleet || '';
          const savedDevices = Array.isArray(d.device) ? d.device : (d.device ? [d.device] : []);

          $('#fleet').val(savedFleet);
          $('#deviceCol').toggle(!!savedFleet);
          const $device = $('#device').empty();

          if (savedFleet) {
            getDevicesForFleet(savedFleet).forEach(dev => $device.append(`<option value="${dev}">${dev}</option>`));
          }

          if ($device.data('select2')) $device.select2('destroy');
          if (savedFleet) {
            $device.select2({ placeholder: 'Select device(s)', width: '100%' });
          }

          if (savedDevices.length > 0) {
            $device.val(savedDevices).trigger('change');
          }
        })
        .catch(err => { console.error(err); alert('Load failed: ' + err.message); });
    }

    $('#searchInput').on('input', function () {
      const term = this.value.toLowerCase();
      $('.sea-card').each(function () {
        const txt = this.textContent.toLowerCase();
        $(this).closest('.col-md-6')[txt.includes(term) ? 'show' : 'hide']();
      });
    });

    function loadExistingAttachments(attachments) {
      const $c = $('#existingAttachments').empty();
      if (!attachments || !attachments.length) {
        $c.html('<small class="text-muted">No attachments</small>'); return;
      }
      const list = attachments.map(url => {
        const name = url.split('/').pop();
        const full = url.startsWith('http') ? url : location.origin + url;
        return `<div class="d-flex align-items-center mb-1 p-2 border rounded bg-light">
          <a href="${full}" target="_blank" class="text-decoration-none me-2 flex-grow-1">${name}</a>
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeExistingAttachment(this,'${url}')">Remove</button>
          <input type="hidden" name="keep_attachments[]" value="${url}">
        </div>`;
      }).join('');
      $c.html(`<div class="border p-2 rounded bg-white mb-2">
        <small class="text-muted d-block mb-2"><strong>Current attachments:</strong></small>${list}
      </div>`);
    }

    function removeExistingAttachment(btn, url) {
      if (confirm('Remove this attachment?')) {
        $(btn).closest('div').remove();
        $(`input[name="keep_attachments[]"][value="${url}"]`).remove();
      }
    }

    // === STARTUP ===
    hideAll();
    $('#choiceScreen').removeClass('hidden');

    const urlParams = new URLSearchParams(window.location.search);
    const editId = urlParams.get('id');
    if (editId) editSea(editId);
  </script>
</body>

</html>