<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Simulator Engineering Authoring Tool</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div class="container mt-5">

    <!-- ====================== CHOICE SCREEN ====================== -->
    <div id="choiceScreen">
      <h1 class="text-center mb-5">Simulator Engineering Authoring Tool</h1>
      <div class="row g-4">
        <div class="col-md-6">
          <div class="card choice-card h-100 text-center p-4" onclick="showCreateForm()">
            <h2 class="text-primary">Create New SEA</h2>
            <p class="text-muted">Start a fresh engineering authorization</p>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card choice-card h-100 text-center p-4" onclick="showSeaList()">
            <h2 class="text-success">View / Edit Existing SEA</h2>
            <p class="text-muted">Search and modify previous submissions</p>
          </div>
        </div>
      </div>

      <!-- ABOUT SECTION – ONLY ON CHOICE SCREEN -->
      <footer id="siteFooter">
        <div class="container">
          <div class="row">
            <div class="col-lg-12 mx-auto text-center">
              <h5>About the Simulator Engineering Authoring Tool (SEAT)</h5>
              <p>
                The <strong>Simulator Engineering Authoring Tool (SEAT)</strong> is a specialized web-based platform
                designed to simplify the creation, management, and documentation of <em>Simulator Engineering
                  Authorizations (SEAs)</em>. Built for engineering teams in aviation and simulation industries, SEAT
                provides an intuitive interface for handling authorization requests related to aircraft simulator
                fleets, such as Boeing 737, 777, 787, and Airbus A320 models.
              </p>
              <p>
                It ensures compliance, traceability, and efficiency by digitizing the entire workflow—from initial
                submission to PDF generation and archival.
              </p>

              <h6>Key Features:</h6>
              <ul class="list-unstyled text-start d-inline-block">
                <li>SEA Creation and Editing</li>
                <li>Parts and Instructions Management</li>
                <li>Attachment Handling</li>
                <li>PDF Generation with embedded attachments</li>
                <li>SEA Dashboard with search and actions</li>
                <li>Fleet-Specific Device Selection</li>
                <li>User-Friendly Responsive Interface</li>
              </ul>

              <p class="mt-3">
                SEAT addresses the challenges of manual engineering authorization processes by providing a centralized,
                digital solution that reduces errors, speeds up approvals, and maintains an audit trail. It's ideal for
                simulator maintenance teams, engineers, and requesters who need to document changes, justify
                modifications, and assess impacts on critical training equipment.
              </p>

              <p class="text-muted small">
                <em>Developed with PHP, mPDF, Bootstrap, and modern web technologies. Extensible and deployable on
                  standard web servers.</em><br>
                <strong>Version:</strong> 1.0 | <strong>Last Updated:</strong> November 2025
              </p>
            </div>
          </div>
        </div>
      </footer>
    </div>

    <!-- ====================== CREATE / EDIT FORM ====================== -->
    <div id="createForm" class="hidden">
      <button class="btn btn-sm btn-outline-secondary mb-3" onclick="goBack()">Back</button>
      <h3 id="formTitle">New SEA</h3>

      <form id="seaForm" class="row g-3" enctype="multipart/form-data">
        <input type="hidden" name="sea_id" id="sea_id">
        <input type="hidden" name="action" id="sea_action" value="create">
        <input type="hidden" name="parts_json" id="parts_json">
        <input type="hidden" name="instructions_json" id="instructions_json">

        <div class="col-md-4">
          <label>SEA ID</label>
          <input type="text" class="form-control" id="display_id" disabled>
        </div>
        <div class="col-md-4">
          <label>EA#</label>
          <input type="text" class="form-control" name="ea_number" id="ea_number">
        </div>
        <div class="col-md-4">
          <label>Revision</label>
          <input type="text" class="form-control" name="revision" id="revision">
        </div>
        <div class="col-12">
          <label>Title</label>
          <textarea class="form-control" name="description" id="description" rows="3"></textarea>
        </div>

        <div class="col-md-4">
          <label>Fleet <span class="text-danger">*</span></label>
          <select class="form-select" id="fleet" name="fleet" required>
            <option value="">Select Fleet</option>
            <option value="737">737</option>
            <option value="737-MAX">737 MAX</option>
            <option value="757">757</option>
            <option value="767">767</option>
            <option value="777">777</option>
            <option value="787">787</option>
            <option value="A320">A320</option>
          </select>
        </div>
        <div class="col-md-4" id="deviceCol" style="display:none">
          <label>Device(s)</label>
          <select class="form-select" id="device" name="device[]" multiple></select>
          <small class="text-muted">Ctrl/Cmd to select multiple</small>
        </div>

        <div class="col-md-6">
          <label>Requester <span class="text-danger">*</span></label>
          <input type="text" class="form-control" name="requester" id="requester" required>
        </div>
        <div class="col-12">
          <label>Background</label>
          <textarea class="form-control" name="justification" id="justification" rows="3"></textarea>
        </div>
        <div class="col-12">
          <label>Impact</label>
          <textarea class="form-control" name="impact" id="impact" rows="2"></textarea>
        </div>
        <div class="col-md-4">
          <label>Priority</label>
          <select class="form-select" name="priority" id="priority">
            <option value="Low">Low</option>
            <option value="Medium" selected>Medium</option>
            <option value="High">High</option>
          </select>
        </div>
        <div class="col-md-4">
          <label>Target Date</label>
          <input type="date" class="form-control" name="target_date" id="target_date">
        </div>

        <div class="col-12">
          <label>Attachments</label>
          <div id="existingAttachments" class="mb-2">
            <small class="text-muted">No attachments</small>
          </div>
          <input type="file" class="form-control" name="attachments[]" multiple>
          <small class="text-muted">Add new files (existing preserved unless removed)</small>
        </div>

        <div class="col-12">
          <h5>Affected Parts</h5>
          <table class="table table-sm parts-table" id="partsTable">
            <thead class="table-light">
              <tr>
                <th>Part #</th>
                <th>Description</th>
                <th>Type</th>
                <th>Qty</th>
                <th><button type="button" id="addPartRow" class="btn btn-sm btn-success">+</button></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="col-12">
          <h5>Work Instructions</h5>
          <table class="table table-sm instr-table" id="instrTable">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>Instruction</th>
                <th>Notes</th>
                <th><button type="button" id="addInstrRow" class="btn btn-sm btn-success">+</button></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="col-12">
          <button type="submit" id="submitBtn" class="btn btn-primary w-100">Create SEA</button>
        </div>
      </form>
    </div>

    <!-- ====================== LIST SCREEN ====================== -->
    <div id="seaList" class="hidden">
      <button class="btn btn-sm btn-outline-secondary mb-3" onclick="goBack()">Back</button>
      <h3>Existing SEAs</h3>
      <div class="mb-3">
        <input type="text" class="form-control" id="searchInput" placeholder="Search by ID, EA#, Requester...">
      </div>
      <div id="seaContainer" class="row"></div>
    </div>

  </div>

  <!-- ====================== SCRIPTS ====================== -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let stepCounter = 1;

    // === FLEET → DEVICE MAP ===
    const fleetDeviceMap = {
      '737': ['FFS-2', 'FFS-3', 'FFS-4', 'FFS-5', 'FFS-6', 'FTD-2', 'FTD-3', 'FTD-4', 'FFS-7', 'FFS-8', 'FFS-9', 'FFS-10'],
      '737-MAX': ['FFS-1', 'FFS-2', 'FFS-3', 'FFS-4', 'FFS-5', 'FFS-6', 'FFS-7', 'FFS-8', 'FFS-9', 'FFS-10', 'FFS-11',
                  'FTD-1', 'FTD-2', 'FTD-3', 'FTD-4', 'FTD-5', 'FTD-6', 'FTD-7', 'FTD-8', 'FTD-9', 'FTD-10', 'FTD-11'],
      '757': ['FFS-1', 'FFS-2', 'FFS-3', 'FTD-1', 'FTD-2'],
      '767': ['FFS-3', 'FFS-4', 'FFS-5'],
      '777': ['FFS-1', 'FFS-2', 'FFS-3', 'FFS-5', 'FTD-1', 'FTD-2', 'FFS-6', 'FFS-7', 'FTD-3'],
      '787': ['FFS-1', 'FFS-2', 'FFS-3', 'FFS-4', 'FFS-5', 'FFS-6', 'FFS-7', 'FFS-8', 'FFS-9', 'FTD-1', 'FTD-2', 'FTD-3', 'FTD-4', 'FTD-5', 'FTD-6'],
      'A320': ['FFS-1', 'FFS-4', 'FTD-1', 'FTD-2', 'FFS-6', 'FFS-7', 'FFS-8', 'FFS-9', 'FFS-10', 'FFS-11', 'FFS-12', , 'FFS-12',
             'FTD-3', 'FTD-4', 'FTD-5', 'FTD-6']
    };

    // === NAVIGATION ===
    function hideAll() {
      $('#choiceScreen, #createForm, #seaList').addClass('hidden');
    }

    function showCreateForm() {
      hideAll();
      $('#createForm').removeClass('hidden');
      if ($('#sea_action').val() === 'create') {
        $('#formTitle').text('New SEA');
        $('#submitBtn').text('Create SEA');
        generateSeaId();
      }
    }

    function showSeaList() {
      hideAll();
      $('#seaList').removeClass('hidden');
      loadSeaList();
    }

    function goBack() {
      hideAll();
      $('#choiceScreen').removeClass('hidden');
    }

    // === SEA ID GENERATION ===
    function generateSeaId() {
      const id = 'SEA-' + new Date().toISOString().slice(0, 10).replace(/-/g, '') + '-' + Math.random().toString(36).substr(2, 3).toUpperCase();
      $('#display_id').val(id);
    }

    // === FLEET → DEVICE POPULATION ===
    $('#fleet').on('change', function () {
      const fleet = $(this).val();
      const $deviceCol = $('#deviceCol');
      const $device = $('#device').empty();

      if (fleet && fleetDeviceMap[fleet]) {
        $deviceCol.show();
        fleetDeviceMap[fleet].forEach(d => $device.append(`<option value="${d}">${d}</option>`));
        $device.select2({ placeholder: "Select device(s)", width: '100%' });
      } else {
        $deviceCol.hide();
      }
    });

    // === PARTS TABLE ===
    function addPartRow(part = {}) {
      const row = `
        <tr>
          <td><input type="text" class="form-control form-control-sm part-num" value="${h(part.part || '')}"></td>
          <td><input type="text" class="form-control form-control-sm part-desc" value="${h(part.desc || '')}"></td>
          <td><input type="text" class="form-control form-control-sm part-type" value="${h(part.type || '')}"></td>
          <td><input type="text" class="form-control form-control-sm part-qty" value="${h(part.qty || '')}"></td>
          <td><button type="button" class="btn btn-sm btn-danger remove-row">−</button></td>
        </tr>`;
      $('#partsTable tbody').append(row);
      updatePartsJson();
    }

    function updatePartsJson() {
      const parts = $('#partsTable tbody tr').map(function () {
        return {
          part: $(this).find('.part-num').val().trim(),
          desc: $(this).find('.part-desc').val().trim(),
          type: $(this).find('.part-type').val().trim(),
          qty: $(this).find('.part-qty').val().trim()
        };
      }).get().filter(p => p.part);
      $('#parts_json').val(JSON.stringify(parts));
    }

    $('#addPartRow').on('click', () => addPartRow());
    $('#partsTable').on('click', '.remove-row', function () {
      $(this).closest('tr').remove();
      updatePartsJson();
    });

    // === INSTRUCTIONS TABLE ===
    function addInstrRow(inst = {}) {
      const row = `
        <tr>
          <td class="text-center align-middle">${stepCounter++}</td>
          <td><textarea class="form-control form-control-sm instr-text" rows="2">${h(inst.instruction || '')}</textarea></td>
          <td><textarea class="form-control form-control-sm instr-notes" rows="2">${h(inst.notes || '')}</textarea></td>
          <td><button type="button" class="btn btn-sm btn-danger remove-row">−</button></td>
        </tr>`;
      $('#instrTable tbody').append(row);
      updateInstrJson();
    }

    function renumberSteps() {
      $('#instrTable tbody tr').each(function (i) {
        $(this).find('td:first').text(i + 1);
      });
      stepCounter = $('#instrTable tbody tr').length + 1;
    }

    function updateInstrJson() {
      const instr = $('#instrTable tbody tr').map(function () {
        return {
          instruction: $(this).find('.instr-text').val().trim(),
          notes: $(this).find('.instr-notes').val().trim()
        };
      }).get().filter(i => i.instruction);
      $('#instructions_json').val(JSON.stringify(instr));
    }

    $('#addInstrRow').on('click', () => addInstrRow());
    $('#instrTable').on('click', '.remove-row', function () {
      $(this).closest('tr').remove();
      renumberSteps();
      updateInstrJson();
    });

    $('#seaForm').on('input change', () => { updatePartsJson(); updateInstrJson(); });

    // === AJAX SUBMISSION ===
    $('#seaForm').on('submit', function (e) {
      e.preventDefault();

      const $btn = $('#submitBtn').prop('disabled', true).text('Saving...');
      const formData = new FormData(this);

      $('.alert').remove();

      $.ajax({
        url: './src/submit.php',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        dataType: 'json',
        success: function (res) {
          if (res.success) {
            const action = $('#sea_action').val();
            showAlert('success',
              (action === 'create' ? 'SEA created successfully!' : 'SEA updated successfully!') +
              ` <a href="#" onclick="viewSea('${res.sea_id}')">View</a> | ` +
              `<a href="#" onclick="downloadPdf('${res.pdf}', '${res.pdf_name}')">Download PDF</a>`
            );

            if (action === 'create') {
              showCreateForm();
            } else {
              $('#display_id').val(res.sea_id);
            }
          } else {
            showAlert('danger', res.message || 'Unknown error');
          }
        },
        error: function (xhr) {
          const msg = xhr.responseJSON?.message || 'Network error. Please try again.';
          showAlert('danger', msg);
        },
        complete: function () {
          $btn.prop('disabled', false).text(
            $('#sea_action').val() === 'create' ? 'Create SEA' : 'Update SEA'
          );
        }
      });
    });

    function showAlert(type, message) {
      const alert = `<div class="alert alert-${type} alert-dismissible fade show mt-3" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>`;
      $('#createForm').prepend(alert);
    }

    function downloadPdf(base64, filename) {
      const link = document.createElement('a');
      link.href = 'data:application/pdf;base64,' + base64;
      link.download = filename;
      link.click();
    }

    function viewSea(id) {
      showSeaList();
      setTimeout(() => {
        const card = $(`#seaContainer .sea-card:contains('SEA-${id}')`);
        if (card.length) card[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 600);
    }

    // === LIST & EDIT ===
    function loadSeaList() {
      const $c = $('#seaContainer');
      $c.html('<div class="text-center py-5"><div class="spinner-border"></div> Loading...</div>');
      fetch('./src/list_seas.php')
        .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.text(); })
        .then(html => $c.html(html))
        .catch(err => $c.html(`<div class="alert alert-danger">Failed: ${err.message}</div>`));
    }

    function deleteSea(id) {
      if (!confirm(`Delete SEA-${id}? This cannot be undone.`)) return;
      const f = document.createElement('form');
      f.method = 'POST'; f.action = './src/delete.php'; f.style.display = 'none';
      const i = document.createElement('input');
      i.type = 'hidden'; i.name = 'filename'; i.value = `sea-${id}.json`;
      f.appendChild(i); document.body.appendChild(f); f.submit();
    }

    function editSea(id) {
      showCreateForm();
      $('#sea_action').val('update');
      $('#sea_id').val(id);
      $('#display_id').val(id);
      $('#formTitle').text('Edit SEA – ' + id);
      $('#submitBtn').text('Update SEA');

      fetch(`data/sea-${id}.json`)
        .then(r => { if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); })
        .then(d => {
          $('#ea_number').val(d.ea_number || '');
          $('#revision').val(d.revision || '');
          $('#requester').val(d.requester || '');
          $('#description').val(d.description || '');
          $('#justification').val(d.justification || '');
          $('#impact').val(d.impact || '');
          $('#priority').val(d.priority || 'Medium');
          $('#target_date').val(d.target_date || '');

          $('#partsTable tbody').empty();
          $('#instrTable tbody').empty();
          stepCounter = 1;
          (JSON.parse(d.parts_json || '[]') || []).forEach(addPartRow);
          (JSON.parse(d.instructions_json || '[]') || []).forEach(addInstrRow);
          loadExistingAttachments(d.attachments || []);

          const savedFleet = d.fleet || '';
          const savedDevices = Array.isArray(d.device) ? d.device : (d.device ? [d.device] : []);

          $('#fleet').val(savedFleet).trigger('change');
          setTimeout(() => {
            $('#device').val(savedDevices).trigger('change');
          }, 100);
        })
        .catch(err => {
          console.error(err);
          showAlert('danger', 'Failed to load SEA: ' + err.message);
        });
    }

    function loadExistingAttachments(attachments) {
      const $c = $('#existingAttachments').empty();
      if (!attachments || !attachments.length) {
        $c.html('<small class="text-muted">No attachments</small>');
        return;
      }
      const list = attachments.map(url => {
        const name = url.split('/').pop();
        const full = url.startsWith('http') ? url : location.origin + url;
        return `<div class="d-flex align-items-center mb-1 p-2 border rounded bg-light">
          <a href="${full}" target="_blank" class="text-decoration-none me-2 flex-grow-1">${name}</a>
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeExistingAttachment(this,'${url}')">Remove</button>
          <input type="hidden" name="keep_attachments[]" value="${url}">
        </div>`;
      }).join('');
      $c.html(`<div class="border p-2 rounded bg-white mb-2">
        <small class="text-muted d-block mb-2"><strong>Current attachments:</strong></small>${list}
      </div>`);
    }

    function removeExistingAttachment(btn, url) {
      if (confirm('Remove this attachment?')) {
        $(btn).closest('div').remove();
        $(`input[name="keep_attachments[]"][value="${url}"]`).remove();
      }
    }

    // === SEARCH ===
    $('#searchInput').on('input', function () {
      const term = this.value.toLowerCase();
      $('.sea-card').each(function () {
        const txt = this.textContent.toLowerCase();
        $(this).closest('.col-md-6')[txt.includes(term) ? 'show' : 'hide']();
      });
    });

    // === UTILS ===
    function h(str) { return String(str).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m]); }

    // === STARTUP ===
    hideAll();
    $('#choiceScreen').removeClass('hidden');

    const urlParams = new URLSearchParams(window.location.search);
    const editId = urlParams.get('id');
    if (editId) editSea(editId);

    // Click-to-expand for SEA descriptions
    document.addEventListener('click', function (e) {
      if (e.target.classList.contains('expand-desc')) {
        e.preventDefault();
        const shortSpan = e.target.previousElementSibling;
        const fullText = shortSpan.dataset.full;
        const shortText = shortSpan.dataset.short;

        if (shortSpan.dataset.expanded) {
          // Collapse
          shortSpan.innerHTML = shortText;
          shortSpan.style = 'max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; display:inline-block;';
          e.target.innerHTML = '[show more]';
          delete shortSpan.dataset.expanded;
        } else {
          // Expand
          shortSpan.innerHTML = fullText;
          shortSpan.style = '';
          e.target.innerHTML = '[show less]';
          shortSpan.dataset.expanded = '1';
        }
      }
    });    
  </script>
</body>

</html>