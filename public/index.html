<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Simulator Engineering Authoring Tool</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    #instrTable .instr-text {
      resize: none;
      overflow: hidden;
      min-height: 60px;
    }
  </style>

  <!-- Attachment helper functions (used in edit mode) -->
  <script>
    function loadExistingAttachments(attachments) {
      const $c = $('#existingAttachments').empty();
      if (!attachments || !attachments.length) {
        $c.html('<small class="text-muted">No attachments</small>');
        return;
      }

      const list = attachments.map(url => {
        const name = url.split('/').pop();
        const full = url.startsWith('http') ? url : location.origin + url;
        const escAttr = url.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        const escJS = url.replace(/\\/g, '\\\\').replace(/'/g, "\\'");

        return `<div class="d-flex align-items-center mb-1 p-2 border rounded bg-light">
                  <a href="${full}" target="_blank" class="text-decoration-none me-2 flex-grow-1">${name}</a>
                  <button type="button" class="btn btn-sm btn-outline-danger"
                          onclick="removeExistingAttachment(this, '${escJS}')">Remove</button>
                  <input type="hidden" name="keep_attachments[]" value="${escAttr}">
                </div>`;
      }).join('');

      $c.html(`<div class="border p-2 rounded bg-white mb-2">
                <small class="text-muted d-block mb-2"><strong>Current attachments:</strong></small>${list}
              </div>`);
    }

    function removeExistingAttachment(btn, url) {
      if (!confirm('Remove this attachment?')) return;
      $(btn).closest('div').remove();
    }
  </script>
</head>

<body>
  <div class="container mt-5">

    <!-- CHOICE SCREEN -->
    <div id="choiceScreen">
      <h1 class="text-center mb-5">Simulator Engineering Authoring Tool</h1>
      <div class="row g-4">
        <div class="col-md-6">
          <div class="card choice-card h-100 text-center p-4" onclick="showCreateForm()">
            <h2 class="text-primary">Create New SEA</h2>
            <p class="text-muted">Start a fresh engineering authorization</p>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card choice-card h-100 text-center p-4" onclick="showSeaList()">
            <h2 class="text-success">View / Edit Existing SEA</h2>
            <p class="text-muted">Search and modify previous submissions</p>
          </div>
        </div>
      </div>

      <footer id="siteFooter">
        <div class="container">
          <div class="row">
            <div class="col-lg-12 mx-auto text-center">
              <h5>About the Simulator Engineering Authoring Tool (SEAT)</h5>
              <p>
                The <strong>Simulator Engineering Authoring Tool (SEAT)</strong> is a specialized web-based platform
                designed to simplify the creation, management, and documentation of <em>Simulator Engineering
                  Authorizations (SEAs)</em>.
              </p>
              <p class="text-muted small">
                <em>Version:</em> 1.0 | <em>Last Updated:</em> November 2025
              </p>
            </div>
          </div>
        </div>
      </footer>
    </div>

    <!-- CREATE / EDIT FORM -->
    <div id="createForm" class="hidden">
      <button class="btn btn-sm btn-outline-secondary mb-3" onclick="goBack()">Back</button>
      <h3 id="formTitle">New SEA</h3>

      <form id="seaForm" class="row g-3" enctype="multipart/form-data">
        <input type="hidden" name="sea_id" id="sea_id">
        <input type="hidden" name="action" id="sea_action" value="create">
        <input type="hidden" name="parts_json" id="parts_json">
        <input type="hidden" name="instructions_json" id="instructions_json">
        <input type="hidden" name="overwrite" id="overwrite" value="0">

        <div class="col-md-4">
          <label>SEA ID</label>
          <input type="text" class="form-control" id="display_id" disabled>
        </div>
        <div class="col-md-4">
          <label>EA#</label>
          <input type="text" class="form-control" name="ea_number" id="ea_number">
        </div>
        <div class="col-md-4">
          <label>Revision</label>
          <input type="text" class="form-control" name="revision" id="revision">
        </div>
        <div class="col-12">
          <label>Title</label>
          <textarea class="form-control" name="description" id="description" rows="3"></textarea>
        </div>
        <div class="col-md-6">
          <label>Requester</label>
          <input type="text" class="form-control" name="requester" id="requester">
        </div>
        <div class="col-md-6">
          <label>Fleet</label>
          <select class="form-select" name="fleet" id="fleet">
            <option value="">Select Fleet</option>
            <option value="B737">B737</option>
            <option value="B777">B777</option>
            <option value="B787">B787</option>
            <option value="A320">A320</option>
          </select>
        </div>
        <div class="col-12">
          <label>Device(s)</label>
          <select class="form-select" name="device[]" id="device" multiple>
            <option value="FBS">FBS</option>
            <option value="VPT">VPT</option>
            <option value="MPS">MPS</option>
          </select>
        </div>
        <div class="col-12">
          <label>Justification</label>
          <textarea class="form-control" name="justification" rows="3"></textarea>
        </div>
        <div class="col-12">
          <label>Impact</label>
          <textarea class="form-control" name="impact" rows="3"></textarea>
        </div>
        <div class="col-md-4">
          <label>Priority</label>
          <select class="form-select" name="priority">
            <option>Low</option>
            <option selected>Medium</option>
            <option>High</option>
            <option>Critical</option>
          </select>
        </div>
        <div class="col-md-4">
          <label>Target Date</label>
          <input type="date" class="form-control" name="target_date">
        </div>
        <div class="col-md-4">
          <label>Status</label>
          <select class="form-select" name="status" id="status">
            <option>Planning</option>
            <option>In Work</option>
            <option>Completed</option>
          </select>
        </div>

        <div class="col-12">
          <label>Affected Parts</label>
          <table class="table parts-table" id="partsTable">
            <thead>
              <tr>
                <th>Part #</th>
                <th>Description</th>
                <th>Type</th>
                <th>Qty</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <button type="button" class="btn btn-sm btn-outline-primary" onclick="addPartRow()">+ Add Part</button>
        </div>

        <div class="col-12">
          <label>Work Instructions</label>
          <table class="table instr-table" id="instrTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Instruction</th>
                <th>Notes</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <button type="button" class="btn btn-sm btn-outline-primary" onclick="addInstrRow()">+ Add
            Instruction</button>
        </div>

        <div class="col-12">
          <label>Attachments</label>
          <input type="file" class="form-control" name="attachments[]" multiple>
          <div id="existingAttachments" class="mt-2"></div>
        </div>

        <div class="col-12">
          <button type="submit" id="submitBtn" class="btn btn-primary">Create SEA</button>
        </div>
      </form>
    </div>

    <!-- LIST VIEW -->
    <div id="listView" class="hidden">
      <button class="btn btn-sm btn-outline-secondary mb-3" onclick="goBack()">Back</button>
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>All SEAs</h3>
        <input type="text" class="form-control w-50" id="searchInput" placeholder="Search SEAs...">
      </div>
      <div id="seaContainer" class="row"></div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <script>
    let stepCounter = 1;

    // Auto-resize textarea
    function autoResizeTextarea(el) {
      el.style.height = 'auto';
      el.style.height = (el.scrollHeight) + 'px';
    }

    // Parts
    function addPartRow(data = {}) {
      const row = `<tr>
        <td><input type="text" class="form-control form-control-sm" value="${data.part || ''}"></td>
        <td><textarea class="form-control form-control-sm">${data.desc || ''}</textarea></td>
        <td><input type="text" class="form-control form-control-sm" value="${data.type || ''}"></td>
        <td><input type="number" class="form-control form-control-sm" value="${data.qty || ''}" style="width:80px;"></td>
        <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove()">X</button></td>
      </tr>`;
      $('#partsTable tbody').append(row);
    }

    function getPartsData() {
      return $('#partsTable tbody tr').map(function () {
        const inputs = $(this).find('input, textarea');
        return {
          part: inputs[0].value.trim(),
          desc: inputs[1].value.trim(),
          type: inputs[2].value.trim(),
          qty: inputs[3].value.trim()
        };
      }).get().filter(p => p.part || p.desc);
    }

    // Instructions
    function addInstrRow(data = {}) {
      const row = `<tr>
        <td class="text-center align-middle">${++stepCounter}</td>
        <td><textarea class="form-control instr-text" oninput="autoResizeTextarea(this)">${data.instruction || ''}</textarea></td>
        <td><input type="text" class="form-control form-control-sm" value="${data.notes || ''}"></td>
        <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove(); renumberInstructions()">X</button></td>
      </tr>`;
      $('#instrTable tbody').append(row);
      const textarea = $('#instrTable tbody tr:last .instr-text')[0];
      if (textarea) autoResizeTextarea(textarea);
    }

    function renumberInstructions() {
      $('#instrTable tbody tr').each(function (i) {
        $(this).find('td:first').text(i + 1);
      });
      stepCounter = $('#instrTable tbody tr').length;
    }

    function getInstrData() {
      return $('#instrTable tbody tr').map(function () {
        return {
          instruction: $(this).find('.instr-text').val().trim(),
          notes: $(this).find('input').val().trim()
        };
      }).get().filter(i => i.instruction);
    }

    // Form submit with overwrite
    $('#seaForm').on('submit', function (e) {
      e.preventDefault();
      const $btn = $('#submitBtn').prop('disabled', true).text('Saving...');
      const formData = new FormData(this);
      formData.set('parts_json', JSON.stringify(getPartsData()));
      formData.set('instructions_json', JSON.stringify(getInstrData()));

      $.ajax({
        url: './src/submit.php',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function (res) {
          if (res.success) {
            showAlert('success', res.message);
            if (res.pdf) downloadPdf(res.pdf, res.pdf_name);
            $('#overwrite').val('0');
            if ($('#sea_action').val() === 'create') {
              $('#sea_id').val(res.sea_id);
              $('#display_id').val(res.sea_id);
              $('#sea_action').val('update');
              $('#formTitle').text('Edit SEA – ' + res.sea_id);
              $('#submitBtn').text('Update SEA');
              history.replaceState(null, null, '?id=' + res.sea_id);
            }
          } else if (res.conflict) {
            if (confirm(res.message + '\n\nClick OK to overwrite.')) {
              $('#overwrite').val('1');
              $btn.click();
            } else {
              showAlert('warning', 'Upload canceled.');
            }
          } else {
            showAlert('danger', res.message || 'Unknown error');
          }
        },
        error: function () {
          showAlert('danger', 'Network error');
        },
        complete: function () {
          $btn.prop('disabled', false).text(
            $('#sea_action').val() === 'create' ? 'Create SEA' : 'Update SEA'
          );
        }
      });
    });

    function showAlert(type, msg) {
      $('#createForm').prepend(`<div class="alert alert-${type} alert-dismissible fade show mt-3">
        ${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>`);
    }

    function downloadPdf(base64, filename) {
      const link = document.createElement('a');
      link.href = 'data:application/pdf;base64,' + base64;
      link.download = filename;
      link.click();
    }

    // Navigation
    function hideAll() {
      $('#choiceScreen, #createForm, #listView').addClass('hidden');
    }

    window.showCreateForm = function () {
      hideAll();
      $('#createForm').removeClass('hidden');
      if (!$('#sea_id').val()) {
        $('#sea_action').val('create');
        $('#formTitle').text('New SEA');
        $('#submitBtn').text('Create SEA');
        stepCounter = 1;
        $('#partsTable tbody').empty();
        $('#instrTable tbody').empty();
        $('#existingAttachments').html('<small class="text-muted">No attachments</small>');
        addPartRow();
        addInstrRow();
        $('#seaForm')[0].reset();
        $('#fleet, #device').val(null).trigger('change');
      }
    };

    window.showSeaList = function () {
      hideAll();
      $('#listView').removeClass('hidden');
      loadSeaList();
    };

    window.goBack = function () {
      hideAll();
      $('#choiceScreen').removeClass('hidden');
      history.replaceState(null, null, window.location.pathname);
    };

    function loadSeaList() {
      const $c = $('#seaContainer');
      $c.html('<div class="text-center py-5"><div class="spinner-border"></div> Loading...</div>');
      fetch('./src/list_seas.php')
        .then(r => r.text())
        .then(html => $c.html(html))
        .catch(() => $c.html('<div class="alert alert-danger">Failed to load SEAs.</div>'));
    }

    // FIXED: editSea function
    window.editSea = function (id) {
      showCreateForm();
      $('#sea_action').val('update');
      $('#sea_id').val(id);
      $('#display_id').val(id);
      $('#formTitle').text('Edit SEA – ' + id);
      $('#submitBtn').text('Update SEA');

      fetch(`data/sea-${id}.json`)
        .then(r => r.json())
        .then(d => {
          $('#ea_number').val(d.ea_number || '');
          $('#revision').val(d.revision || '');
          $('#requester').val(d.requester || '');
          $('#description').val(d.description || '');
          $('#justification').val(d.justification || '');
          $('#impact').val(d.impact || '');
          $('#priority').val(d.priority || 'Medium');
          $('#target_date').val(d.target_date || '');
          $('#status').val(d.status || 'Planning');
          $('#fleet').val(d.fleet || '').trigger('change');

          $('#partsTable tbody').empty();
          $('#instrTable tbody').empty();
          stepCounter = 0;
          (JSON.parse(d.parts_json || '[]') || []).forEach(p => addPartRow(p));
          (JSON.parse(d.instructions_json || '[]') || []).forEach(i => addInstrRow(i));

          setTimeout(() => {
            $('#instrTable .instr-text').each(function () { autoResizeTextarea(this); });
          }, 50);

          loadExistingAttachments(d.attachments || []);

          setTimeout(() => {
            $('#device').val(Array.isArray(d.device) ? d.device : (d.device ? [d.device] : [])).trigger('change');
          }, 100);
        })
        .catch(err => {
          showAlert('danger', 'Failed to load SEA: ' + err.message);
          goBack();
        });
    };

    // Search
    $('#searchInput').on('input', function () {
      const term = this.value.toLowerCase();
      $('.sea-card').each(function () {
        const txt = this.textContent.toLowerCase();
        $(this).closest('.col-md-6')[txt.includes(term) ? 'show' : 'hide']();
      });
    });

    // Init
    $(function () {
      hideAll();
      $('#choiceScreen').removeClass('hidden');
      $('#fleet, #device').select2({ width: '100%' });

      const urlParams = new URLSearchParams(window.location.search);
      const editId = urlParams.get('id');
      if (editId) editSea(editId);
    });
  </script>
</body>

</html>