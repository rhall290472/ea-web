<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Simulator Engineering Authorizations</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <style>
    .choice-card {
      cursor: pointer;
      transition: .2s
    }

    .choice-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, .1)
    }

    .sea-card {
      transition: .2s
    }

    .sea-card:hover {
      background: #f8f9fa
    }

    .hidden {
      display: none
    }

    .parts-table th,
    .parts-table td,
    .instr-table th,
    .instr-table td {
      vertical-align: middle
    }

    .parts-table input,
    .parts-table textarea,
    .instr-table input,
    .instr-table textarea {
      width: 100%;
      border: none;
      padding: 6px
    }

    .select2-container {
      width: 100% !important
    }
  </style>
</head>

<body>
  <div class="container mt-5">

    <!-- CHOICE SCREEN -->
    <div id="choiceScreen">
      <h1 class="text-center mb-5">Simulator Engineering Authorizations</h1>
      <div class="row g-4">
        <div class="col-md-6">
          <div class="card choice-card h-100 text-center p-4" onclick="showCreateForm()">
            <h2 class="text-primary">Create New SEA</h2>
            <p class="text-muted">Start a fresh engineering authorization</p>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card choice-card h-100 text-center p-4" onclick="showSeaList()">
            <h2 class="text-success">View / Edit Existing SEA</h2>
            <p class="text-muted">Search and modify previous submissions</p>
          </div>
        </div>
      </div>
    </div>

    <!-- CREATE / EDIT FORM -->
    <div id="createForm" class="hidden">
      <button class="btn btn-sm btn-outline-secondary mb-3" onclick="goBack()">Back</button>
      <h3 id="formTitle">New SEA</h3>

      <form id="seaForm" action="/src/submit.php" method="POST" enctype="multipart/form-data" class="row g-3">
        <input type="hidden" name="sea_id" id="sea_id">
        <input type="hidden" name="action" id="sea_action" value="create">
        <input type="hidden" name="parts_json" id="parts_json">
        <input type="hidden" name="instructions_json" id="instructions_json">

        <div class="col-md-6"><label>SEA ID</label><input type="text" class="form-control" id="display_id" disabled>
        </div>
        <div class="col-md-6"><label>EA#</label><input type="text" class="form-control" name="ea_number"></div>
        <div class="col-md-4"><label>Revision</label><input type="text" class="form-control" name="revision"></div>

        <div class="col-md-4">
          <label>Fleet <span class="text-danger">*</span></label>
          <select class="form-select" id="fleet" name="fleet" required>
            <option value="">Select Fleet</option>
            <option value="737">737</option>
            <option value="737-MAX">737 MAX</option>
            <option value="757">757</option>
            <option value="767">767</option>
            <option value="777">777</option>
            <option value="787">787</option>
            <option value="A320">A320</option>
          </select>
        </div>

        <!-- DEVICE DROPDOWN -->
        <div class="col-md-4" id="deviceCol" style="display:none">
          <label>Device(s)</label>
          <select class="form-select" id="device" name="device[]" multiple></select>
          <small class="text-muted">Ctrl/Cmd to select multiple</small>
        </div>

        <div class="col-md-6"><label>Requester <span class="text-danger">*</span></label><input type="text"
            class="form-control" name="requester" required></div>
        <div class="col-12"><label>Description <span class="text-danger">*</span></label><textarea class="form-control"
            name="description" rows="3" required></textarea></div>
        <div class="col-12"><label>Justification <span class="text-danger">*</span></label><textarea
            class="form-control" name="justification" rows="3" required></textarea></div>

        <!-- PARTS TABLE -->
        <div class="col-12">
          <label class="d-flex justify-content-between">
            <span>Affected Parts</span>
            <button type="button" id="addPartRow" class="btn btn-sm btn-success">+ Add Part</button>
          </label>
          <table class="table table-bordered" id="partsTable">
            <thead class="table-light">
              <tr>
                <th>Part</th>
                <th>Description</th>
                <th>Type</th>
                <th>Qty</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="col-md-6"><label>Impact</label><textarea class="form-control" name="impact" rows="3"></textarea>
        </div>
        <div class="col-md-6">
          <label>Priority</label>
          <select class="form-select" name="priority">
            <option>Low</option>
            <option selected>Medium</option>
            <option>High</option>
            <option>Critical</option>
          </select>
        </div>
        <div class="col-md-6"><label>Target Date</label><input type="date" class="form-control" name="target_date">
        </div>
        <div class="col-12"><label>Attachments</label><input type="file" class="form-control" name="attachments[]"
            multiple></div>

        <!-- INSTRUCTIONS -->
        <div class="col-12">
          <label class="d-flex justify-content-between">
            <span>Work Instructions</span>
            <button type="button" id="addInstrRow" class="btn btn-sm btn-success">+ Add Step</button>
          </label>
          <table class="table table-bordered" id="instrTable">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>Instruction</th>
                <th>Party</th>
                <th>Notes</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="col-12"><button type="submit" id="submitBtn" class="btn btn-primary w-100">Submit SEA</button></div>
      </form>
    </div>

    <!-- LIST -->
    <div id="seaList" class="hidden">
      <button class="btn btn-sm btn-outline-secondary mb-3" onclick="goBack()">Back</button>
      <h3>Existing SEAs</h3>
      <input type="text" id="searchInput" class="form-control mb-3" placeholder="Search...">
      <div id="seaContainer" class="row"></div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ============== FLEET → DEVICES ==============
    const fleetDeviceMap = {
      'B37': ['FFS-2', 'FFS-3', 'FFS-4', 'FFS-5', , 'FTD-1', 'FTD-2', 'FTD-3', 'FTD-4', 'FFS-6', 'FFS-7', 'FFS-8', 'FFS-9', 'FFS-10'],
      'B737-MAX': ['FFS-1', 'FFS-2', 'FFS-3', 'FFS-4', 'FFS-5', 'FFS-6', 'FFS-7', 'FFS-8', 'FFS-9', 'FFS-10', 'FFS-11',
                   'FTD-1', 'FTD-2', 'FTD-3', 'FTD-4', 'FTD-5', 'FTD-6', 'FTD-7', 'FTD-8', 'FTD-9', 'FTD-10', 'FTD-11' ],
      '757': ['FFS-1', 'FFS-2', 'FFS-3', 'FTD-1', 'FTD-2'],
      '767': ['FFS-3', 'FFS-4', 'FFS-5'],
      '777': ['FFS-1', 'FFS-2', 'FFS-3', 'FFS-5', 'FTD-1', 'FTD-2', 'FFS-6', 'FFS-7', 'FTD-3'],
      '787': ['FFS-1', 'FFS-2', 'FFS-3', 'FFS-4', 'FFS-5', 'FFS-6', 'FFS-7', 'FFS-8', 'FFS-9', 'FTD-1', 'FTD-2', 'FTD-3', 'FTD-4', 'FTD-5', 'FTD-6'],
      'A320': ['FFS-1', 'FFS-4', 'FTD-1', 'FTD-2', 'FFS-6', 'FFS-7', 'FFS-8', 'FFS-9', 'FFS-10', 'FFS-11', 'FFS-12', 'FFS-13', 'FTD-3', 'FTD-4', 'FTD-5', 'FTD-6', 'FTD-7']
    };

    function rebuildDeviceSelect() {
      const fleet = document.getElementById('fleet').value;
      const $dev = $('#device');
      const $col = $('#deviceCol');

      // Destroy existing
      if ($dev.hasClass('select2-hidden-accessible')) {
        $dev.select2('destroy');
      }
      $dev.empty();

      const devices = fleetDeviceMap[fleet] || [];

      if (devices.length) {
        $col.show(); // FORCE visible
        devices.forEach(d => $dev.append(`<option value="${d}">${d}</option>`));
      } else {
        $col.hide();
        $dev.append('<option></option>');
      }

      // Re-init
      $dev.select2({
        placeholder: devices.length ? 'Select device(s)' : 'No devices',
        allowClear: true,
        width: '100%'
      });

      // Force render if needed
      if (devices.length > 5) {
        setTimeout(() => {
          $dev.select2('open');
          $dev.select2('close');
        }, 100);
      }

      $dev.val(null).trigger('change');
    }
    document.getElementById('fleet').addEventListener('change', rebuildDeviceSelect);

    // ============== NAVIGATION ==============
    function showCreateForm() {
      hideAll();
      $('#createForm').removeClass('hidden');
      $('#seaForm')[0].reset();
      $('#sea_id').val('');
      $('#sea_action').val('create');
      $('#display_id').val('');
      $('#formTitle').text('New Simulator Engineering Authorization (SEA)');
      $('#submitBtn').text('Submit SEA');
      $('#partsTable tbody, #instrTable tbody').empty();
      $('#deviceCol').hide();
      stepCounter = 1;
      addPartRow();
      addInstrRow();
      rebuildDeviceSelect();   // start clean
    }
    function showSeaList() { hideAll(); $('#seaList').removeClass('hidden'); loadSeaList(); }
    function goBack() { hideAll(); $('#choiceScreen').removeClass('hidden'); }
    function hideAll() { $('#choiceScreen,#createForm,#seaList').addClass('hidden'); }

    // ============== TABLES ==============
    let stepCounter = 1;
    function addPartRow(d = {}) {
      const html = `<tr>
        <td><input class="part-number" value="${h(d.part || '')}"></td>
        <td><textarea class="part-desc">${h(d.desc || '')}</textarea></td>
        <td><select class="form-select change-type">
            ${['Modify', 'Add', 'Remove', 'Replace'].map(o => `<option ${o === d.type ? 'selected' : ''}>${o}</option>`).join('')}
        </select></td>
        <td><input type="number" class="part-qty" value="${d.qty || 1}" style="width:60px"></td>
        <td><button type="button" class="btn btn-sm btn-danger delete-row">X</button></td>
    </tr>`;
      $('#partsTable tbody').append(html);
      updatePartsJson();
    }
    function addInstrRow(d = {}) {
      const html = `<tr>
        <td class="text-center fw-bold">${stepCounter++}</td>
        <td><textarea class="instr-text" rows="2">${h(d.instruction || '')}</textarea></td>
        <td><input class="instr-party" value="${h(d.party || '')}"></td>
        <td><input class="instr-notes" value="${h(d.notes || '')}"></td>
        <td><button type="button" class="btn btn-sm btn-danger delete-row">X</button></td>
    </tr>`;
      $('#instrTable tbody').append(html);
      updateInstrJson();
    }
    $(document).on('click', '.delete-row', function () { $(this).closest('tr').remove(); renumberSteps(); updatePartsJson(); updateInstrJson(); });
    function renumberSteps() { stepCounter = 1; $('#instrTable tbody tr td:first-child').each(function () { $(this).text(stepCounter++); }); }
    function updatePartsJson() {
      const parts = $('#partsTable tbody tr').map(function () {
        return {
          part: $(this).find('.part-number').val().trim(),
          desc: $(this).find('.part-desc').val().trim(),
          type: $(this).find('.change-type').val(),
          qty: $(this).find('.part-qty').val() || '1'
        };
      }).get().filter(p => p.part || p.desc);
      $('#parts_json').val(JSON.stringify(parts));
    }
    function updateInstrJson() {
      const instr = $('#instrTable tbody tr').map(function () {
        return {
          instruction: $(this).find('.instr-text').val().trim(),
          party: $(this).find('.instr-party').val().trim(),
          notes: $(this).find('.instr-notes').val().trim()
        };
      }).get().filter(i => i.instruction);
      $('#instructions_json').val(JSON.stringify(instr));
    }
    $('#addPartRow').on('click', () => addPartRow());
    $('#addInstrRow').on('click', () => addInstrRow());
    $('#seaForm').on('input', () => { updatePartsJson(); updateInstrJson(); });

    // ============== LIST & EDIT ==============
    function loadSeaList() {
      const $container = $('#seaContainer');
      $container.html('<div class="text-center"><div class="spinner-border"></div> Loading SEAs...</div>');

      fetch('/src/list_seas.php', {
        headers: {
          'Accept': 'application/json'
        }
      })
        .then(response => {
          console.log('HTTP Status:', response.status);
          console.log('Headers:', response.headers.get('content-type'));

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          if (!response.headers.get('content-type')?.includes('application/json')) {
            throw new Error('Not JSON response');
          }
          return response.json();
        })
        .then(seas => {
          console.log('SEAs loaded:', seas);
          $container.empty();

          if (!seas || seas.length === 0) {
            $container.html('<div class="alert alert-info">No SEAs found. <a href="#" onclick="showCreateForm()">Create one</a>.</div>');
            return;
          }

          seas.forEach(s => {
            const dev = Array.isArray(s.device) ? s.device.join(', ') : (s.device || '—');
            $container.append(`
                <div class="col-md-6 mb-3">
                    <div class="card sea-card">
                        <div class="card-body">
                            <h5>SEA-${h(s.id)}</h5>
                            <p><strong>EA#:</strong> ${h(s.ea_number || '—')}</p>
                            <p><strong>Fleet:</strong> ${h(s.fleet)} | <strong>Device:</strong> ${dev}</p>
                            <p><strong>Requester:</strong> ${h(s.requester)}</p>
                            <p class="small text-muted">${h(s.timestamp)} | v${s.version}</p>
                            <div class="mt-2">
                                <button class="btn btn-sm btn-primary" onclick="editSea('${s.id}')">Edit</button>
                                <a href="/src/print_sea.php?id=${s.id}" target="_blank" class="btn btn-sm btn-success">PDF</a>
                            </div>
                        </div>
                    </div>
                </div>
            `);
          });
        })
        .catch(err => {
          console.error('Fetch error:', err);
          $container.html(`
            <div class="alert alert-danger">
                <strong>Error loading SEAs:</strong> ${err.message}
                <br><small>
                    Test: <a href="/src/list_seas.php" target="_blank">Open list_seas.php directly</a>
                </small>
            </div>
        `);
        });
    }

    function editSea(id) {
      showCreateForm();
      $('#sea_action').val('update');
      $('#sea_id').val(id);
      $('#display_id').val(id);
      $('#formTitle').text('Edit SEA – ' + id);
      $('#submitBtn').text('Update SEA');

      fetch(`/data/sea-${id}.json`)
        .then(r => r.json())
        .then(d => {
          $('#ea_number').val(d.ea_number || '');
          $('#revision').val(d.revision || '');
          $('#requester').val(d.requester || '');
          $('#description').val(d.description || '');
          $('#justification').val(d.justification || '');
          $('#impact').val(d.impact || '');
          $('#priority').val(d.priority || 'Medium');
          $('#target_date').val(d.target_date || '');
          $('#fleet').val(d.fleet || '').trigger('change');

          setTimeout(() => {
            const saved = Array.isArray(d.device) ? d.device : (d.device ? [d.device] : []);
            $('#device').val(saved).trigger('change');
          }, 150);

          $('#partsTable tbody').empty();
          JSON.parse(d.parts_json || '[]').forEach(addPartRow);
          $('#instrTable tbody').empty();
          stepCounter = 1;
          JSON.parse(d.instructions_json || '[]').forEach(addInstrRow);
        });
    }
    $('#searchInput').on('input', function () {
      const term = this.value.toLowerCase();
      $('.sea-card').each(function () {
        const txt = this.textContent.toLowerCase();
        $(this).closest('.col-md-6')[txt.includes(term) ? 'show' : 'hide']();
      });
    });
    function h(s) { return (s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;'); }

    // ============== START ==============
    hideAll();
    $('#choiceScreen').removeClass('hidden');
  </script>
</body>

</html>