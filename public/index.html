<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Simulator Engineering Authoring Tool</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    /* ---- AUTO-RESIZE FOR INSTRUCTION TEXTAREA ---- */
    #instrTable .instr-text {
      resize: none;
      /* no manual resize handle */
      overflow: hidden;
      /* hide scrollbars */
      min-height: 60px;
      /* same as original */
    }

    /* Bootstrap already ships .visually-hidden, but just in case */
    .visually-hidden {
      position: absolute !important;
      width: 1px !important;
      height: 1px !important;
      padding: 0 !important;
      margin: -1px !important;
      overflow: hidden !important;
      clip: rect(0, 0, 0, 0) !important;
      white-space: nowrap !important;
      border: 0 !important;
    }
  </style>
  <script src="https://cdn.tiny.cloud/1/h9xs5cld1bkmamb6zycl5ymhfanahso689gglclrgt5gldlx/tinymce/7/tinymce.min.js"
    referrerpolicy="origin"></script>
  <!-- ====== CRITICAL: DEFINE FUNCTIONS FIRST ====== -->
  <script>
    // GLOBAL: Must be defined BEFORE any inline onclick
    function loadExistingAttachments(attachments) {
      const $c = $('#existingAttachments').empty();
      if (!attachments || !attachments.length) {
        $c.html('<small class="text-muted">No attachments</small>');
        return;
      }

      const list = attachments.map(url => {
        const name = url.split('/').pop();
        const full = url.startsWith('http') ? url : location.origin + url;

        // Escape for HTML attribute
        const escAttr = url.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        // Escape for JS string (single quotes)
        const escJS = url.replace(/\\/g, '\\\\').replace(/'/g, "\\'");

        return `<div class="d-flex align-items-center mb-1 p-2 border rounded bg-light">
                  <a href="${full}" target="_blank" class="text-decoration-none me-2 flex-grow-1">${name}</a>
                  <button type="button" class="btn btn-sm btn-outline-danger"
                          onclick="removeExistingAttachment(this, '${escJS}')">Remove</button>
                  <input type="hidden" name="keep_attachments[]" value="${escAttr}">
                </div>`;
      }).join('');

      $c.html(`<div class="border p-2 rounded bg-white mb-2">
                <small class="text-muted d-block mb-2"><strong>Current attachments:</strong></small>${list}
              </div>`);
    }

    function removeExistingAttachment(btn, url) {
      if (!confirm('Remove this attachment?')) return;
      $(btn).closest('div').remove();
    }
  </script>
  <!-- ====== END CRITICAL SECTION ====== -->
</head>

<body>
  <div class="container mt-5">

    <!-- ====================== CHOICE SCREEN ====================== -->
    <div id="choiceScreen">
      <h1 class="text-center mb-5">Simulator Engineering Authoring Tool</h1>
      <div class="row g-4">
        <div class="col-md-6">
          <div class="card choice-card h-100 text-center p-4" onclick="showCreateForm()">
            <h2 class="text-primary">Create New SEA</h2>
            <p class="text-muted">Start a fresh engineering authorization</p>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card choice-card h-100 text-center p-4" onclick="showSeaList()">
            <h2 class="text-success">View / Edit Existing SEA</h2>
            <p class="text-muted">Search and modify previous submissions</p>
          </div>
        </div>
      </div>

      <!-- ABOUT SECTION – ONLY ON CHOICE SCREEN -->
      <footer id="siteFooter">
        <div class="container">
          <div class="row">
            <div class="col-lg-12 mx-auto text-center">
              <h5>About the Simulator Engineering Authoring Tool (SEAT)</h5>
              <p>
                The <strong>Simulator Engineering Authoring Tool (SEAT)</strong> is a specialized web-based platform
                designed to simplify the creation, management, and documentation of <em>Simulator Engineering
                  Authorizations (SEAs)</em>. Built for engineering teams in aviation and simulation industries, SEAT
                provides an intuitive interface for handling authorization requests related to aircraft simulator
                fleets, such as Boeing 737, 777, 787, and Airbus A320 models.
              </p>
              <p>
                It ensures compliance, traceability, and efficiency by digitizing the entire workflow—from initial
                submission to PDF generation and archival.
              </p>

              <h6>Key Features:</h6>
              <ul class="list-unstyled text-start d-inline-block">
                <li>SEA Creation and Editing</li>
                <li>Parts and Instructions Management</li>
                <li>Attachment Handling</li>
                <li>PDF Generation with embedded attachments</li>
                <li>SEA Dashboard with search and actions</li>
                <li>Fleet-Specific Device Selection</li>
                <li>User-Friendly Responsive Interface</li>
              </ul>

              <p class="mt-3">
                SEAT addresses the challenges of manual engineering authorization processes by providing a centralized,
                digital solution that reduces errors, speeds up approvals, and maintains an audit trail. It's ideal for
                simulator maintenance teams, engineers, and requesters who need to document changes, justify
                modifications, and assess impacts on critical training equipment.
              </p>

              <p class="text-muted small">
                <em>Developed with PHP, mPDF, Bootstrap, and modern web technologies. Extensible and deployable on
                  standard web servers.</em><br>
              <p class="text-muted small" id="versionInfo">
                <em>Loading version...</em>
              </p>

              <script>
                fetch('version.json')
                  .then(r => r.ok ? r.json() : { tag: 'dev', commit: '??', date: 'unknown' })
                  .then(v => {
                    const el = document.getElementById('versionInfo');
                    el.innerHTML = `
        <strong>Version:</strong> 
        <a href="https://github.com/yourname/your-repo/commit/${v.commit}" target="_blank" class="text-decoration-none">
          ${v.tag}
        </a>
        <code class="text-muted">(${v.commit})</code>
        | <strong>Last Updated:</strong> ${v.date}
      `;
                  })
                  .catch(() => {
                    document.getElementById('versionInfo').innerHTML = '<em>Version info unavailable</em>';
                  });
              </script>
            </div>
          </div>
        </div>
      </footer>
    </div>

    <!-- ====================== CREATE / EDIT FORM ====================== -->
    <div id="createForm" class="hidden">
      <!-- <h2 id="formTitle" class="mb-4">New SEA</h2> -->
      <button class="btn btn-sm btn-outline-secondary mb-3" onclick="goBack()">Back</button>
      <h2 id="formTitle" class="mb-3 d-flex justify-content-between align-items-center">
        <span>New SEA</span>
        <div>
          <button type="button" class="btn btn-sm btn-outline-secondary me-2" onclick="showSeaList()">Cancel</button>
          <button type="button" class="btn btn-sm btn-secondary" onclick="goBack()">Back</button>
        </div>
      </h2>

      <form id="seaForm" enctype="multipart/form-data">
        <input type="hidden" id="sea_action" name="action" value="create">
        <input type="hidden" id="sea_id" name="sea_id" value="">

        <div class="row g-3 mb-3">
          <!-- SEA ID (display only) -->
          <div class="col-md-4">
            <label for="display_id" class="form-label">SEA ID</label>
            <input type="text" class="form-control bg-light" id="display_id" readonly placeholder="Auto-generated">
          </div>
          <!-- EA# & Revision -->
          <div class="col-md-4">
            <label for="ea_number" class="form-label">EA#</label>
            <input type="text" class="form-control" id="ea_number" name="ea_number" placeholder="e.g. EA-12345">
          </div>
          <div class="col-md-4">
            <label for="revision" class="form-label">EA Revision</label>
            <input type="text" class="form-control" id="revision" name="revision" placeholder="e.g. A">
          </div>


          <!-- Requester -->
          <div class="col-md-12">
            <label for="requester" class="form-label">Author</label>
            <input type="text" class="form-control" id="requester" name="requester" required>
          </div>

          <!-- Description -->
          <div class="col-md-12">
            <label for="description" class="form-label">Description</label>
            <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
          </div>

          <!-- Justification -->
          <div class="col-md-12">
            <label for="justification" class="form-label">Justification</label>
            <textarea class="form-control" id="justification" name="justification" rows="2"></textarea>
          </div>

          <!-- Impact -->
          <div class="col-md-12">
            <label for="impact" class="form-label">Impact Assessment</label>
            <textarea class="form-control" id="impact" name="impact" rows="5"></textarea>
          </div>

          <!-- Priority -->
          <div class="col-md-4">
            <label for="priority" class="form-label">Priority</label>
            <select class="form-select" id="priority" name="priority">
              <option value="Low">Low</option>
              <option value="Medium" selected>Medium</option>
              <option value="High">High</option>
              <option value="Critical">Critical</option>
            </select>
          </div>

          <!-- Target Date -->
          <div class="col-md-4">
            <label for="target_date" class="form-label">Target Date</label>
            <input type="date" class="form-control" id="target_date" name="target_date">
          </div>

          <!-- Status -->
          <div class="col-md-4">
            <label for="status" class="form-label">Status</label>
            <select class="form-select" id="status" name="status">
              <option value="Planning" selected>Planning</option>
              <option value="In Work">In Work</option>
              <option value="Completed">Completed</option>
              <option value="On Hold">On Hold</option>
            </select>
          </div>

          <!-- Fleet -->
          <div class="col-md-6">
            <label for="fleet" class="form-label">Fleet</label>
            <select class="form-select select2" id="fleet" name="fleet" required>
              <option value="">-- Select Fleet --</option>
              <option value="737">737</option>
              <option value="777">777</option>
              <option value="787">787</option>
              <option value="A320">A320</option>
              <!-- add more fleets here -->
            </select>
          </div>

          <!-- Device (multi-select) -->
          <div class="col-md-6">
            <label for="device" class="form-label">Device(s)</label>
            <select class="form-select select2" id="device" name="device[]" multiple></select>
          </div>

          <!-- Attachments -->
          <div class="col-md-12">
            <label for="attachments" class="form-label">Attachments</label>
            <input type="file" class="form-control" id="attachments" name="attachments[]" multiple>
            <div id="existingAttachments" class="mt-2"></div>
          </div>
        </div>

        <!-- ==================== PARTS TABLE ==================== -->
        <h4 class="mt-4">Affected Parts</h4>
        <table class="table table-sm parts-table" id="partsTable">
          <thead>
            <tr>
              <th>Part #</th>
              <th>Description</th>
              <th>Type</th>
              <th>Qty</th>
              <th style="width:50px;"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <button type="button" class="btn btn-outline-secondary btn-sm mb-3" onclick="addPartRow()">+ Add Part</button>

        <!-- ==================== INSTRUCTIONS TABLE ==================== -->
        <h4 class="mt-4">Work Instructions</h4>
        <table class="table table-sm instr-table" id="instrTable">
          <thead>
            <tr>
              <th style="width:5%;">#</th>
              <th style="width:70%;">Instruction</th>
              <th style="width:20%;">Notes</th>
              <th style="width:5%;"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <button type="button" class="btn btn-outline-secondary btn-sm mb-3" onclick="addInstrRow()">+ Add
          Instruction</button>

        <!-- ==================== SUBMIT ==================== -->
        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
          <button type="button" class="btn btn-secondary me-md-2" onclick="goBack()">Back</button>
          <button type="submit" id="submitBtn" class="btn btn-primary">Create SEA</button>
        </div>
      </form>
    </div>
    <!-- ====================== LIST VIEW ====================== -->
    <div id="listView" class="hidden">
      <button class="btn btn-sm btn-outline-secondary mb-3" onclick="goBack()">Back</button>
      <h3>Existing SEAs</h3>
      <div class="row mb-3">
        <div class="col-md-6">
          <input type="text" id="searchInput" class="form-control" placeholder="Search by keyword...">
        </div>
        <div class="col-md-6">
          <select id="fleetFilter" class="form-select">
            <option value="">All Fleets</option>
            <!-- Options will be populated dynamically -->
          </select>
        </div>
      </div>
      <div id="seaContainer" class="row"></div> <!-- Content from list_seas.php loads here -->
    </div>


    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
      // -------------------------------------------------
      // Small HTML-escape helper used in templates
      function h(s) {
        if (s === null || s === undefined) return '';
        return String(s)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      // AUTO-RESIZE TEXTAREA (Instruction field)
      // -------------------------------------------------
      // TinyMCE – initialise only on the instruction textarea
      // -------------------------------------------------
      tinymce.init({
        selector: '#instrTable .instr-text',          // target every instruction textarea
        height: 80,
        menubar: false,
        plugins: 'lists link image table code autoresize',
        toolbar: 'undo redo | bold italic underline | bullist numlist | link image| removeformat | code | table',
        toolbar_mode: 'wrap',  // or 'floating', 'sliding'
        branding: false,
        statusbar: true,
        // allow manual resize and enable autoresize plugin to auto-grow the editor
        resize: true,
        autoresize_bottom_margin: 12,
        images_upload_handler: function (blobInfo, progress) {
          return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            xhr.open('POST', './src/upload_image.php');

            xhr.upload.onprogress = (e) => {
              progress(e.loaded / e.total * 100);
            };

            xhr.onload = () => {
              if (xhr.status < 200 || xhr.status >= 300) {
                reject('HTTP Error: ' + xhr.status);
                return;
              }
              const json = JSON.parse(xhr.responseText);
              if (!json || typeof json.location !== 'string') {
                reject('Invalid JSON: ' + xhr.responseText);
                return;
              }

              // RESIZE: Limit max width to 600px (adjust as needed)
              const img = new Image();
              img.onload = function () {
                const maxWidth = 600;
                if (img.width > maxWidth) {
                  const canvas = document.createElement('canvas');
                  const ctx = canvas.getContext('2d');
                  canvas.width = maxWidth;
                  canvas.height = (img.height * maxWidth) / img.width;
                  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                  canvas.toBlob((resizedBlob) => {
                    // Re-upload resized version? Or just insert scaled
                    resolve(json.location + '?w=' + maxWidth); // Or keep original, scale in CSS
                  }, blobInfo.blob().type);
                } else {
                  resolve(json.location);
                }
              };
              img.src = URL.createObjectURL(blobInfo.blob());

              // Fallback: just insert original
              setTimeout(() => resolve(json.location), 100);
            };

            xhr.onerror = () => reject('Upload failed');

            const formData = new FormData();
            formData.append('file', blobInfo.blob(), blobInfo.filename());
            formData.append('sea_id', $('#sea_id').val() || 'temp');
            xhr.send(formData);
          });
        },
        setup: function (editor) {
          // keep the hidden textarea in sync (TinyMCE does this automatically)
          editor.on('change keyup', function () {
            editor.save();                       // write HTML back to <textarea>
            // keep legacy textarea sizing logic (harmless) in case TinyMCE is removed
            try { autoResizeTextarea(editor.getElement()); } catch (e) { /* noop */ }
          });
        }
      });

      // -------------------------------------------------
      // Existing auto-resize (unchanged, works with TinyMCE HTML)
      // -------------------------------------------------
      function autoResizeTextarea(el) {
        el.style.height = 'auto';
        el.style.height = (el.scrollHeight) + 'px';
      }
      function autoResizeTextarea(el) {
        el.style.height = 'auto';                     // allow shrinking
        el.style.height = el.scrollHeight + 'px';     // fit content
      }

      $(document).ready(function () {
        let stepCounter = 1;

        // === FLEET → DEVICE MAP (YOUR ORIGINAL) ===
        const fleetDeviceMap = {
          '737': ['FFS-2', 'FFS-3', 'FFS-4', 'FFS-5', 'FFS-6', 'FTD-2', 'FTD-3', 'FTD-4', 'FFS-7', 'FFS-8', 'FFS-9', 'FFS-10'],
          '737-MAX': ['FFS-1', 'FFS-2', 'FFS-3', 'FFS-4', 'FFS-5', 'FFS-6', 'FFS-7', 'FFS-8', 'FFS-9', 'FFS-10', 'FFS-11',
            'FTD-1', 'FTD-2', 'FTD-3', 'FTD-4', 'FTD-5', 'FTD-6', 'FTD-7', 'FTD-8', 'FTD-9', 'FTD-10', 'FTD-11'],
          '757': ['FFS-1', 'FFS-2', 'FFS-3', 'FTD-1', 'FTD-2'],
          '767': ['FFS-3', 'FFS-4', 'FFS-5'],
          '777': ['FFS-1', 'FFS-2', 'FFS-3', 'FFS-5', 'FTD-1', 'FTD-2', 'FFS-6', 'FFS-7', 'FTD-3'],
          '787': ['FFS-1', 'FFS-2', 'FFS-3', 'FFS-4', 'FFS-5', 'FFS-6', 'FFS-7', 'FFS-8', 'FFS-9', 'FTD-1', 'FTD-2', 'FTD-3', 'FTD-4', 'FTD-5', 'FTD-6'],
          'A320': ['FFS-1', 'FFS-4', 'FTD-1', 'FTD-2', 'FFS-6', 'FFS-7', 'FFS-8', 'FFS-9', 'FFS-10', 'FFS-11', 'FFS-12', 'FFS-13',
            'FTD-3', 'FTD-4', 'FTD-5', 'FTD-6']
        };

        // -------------------------------------------------
        // SELECT2 INITIALISATION
        // -------------------------------------------------
        $('#fleet').select2({ placeholder: "Select Fleet", allowClear: true });
        $('#device').select2({ placeholder: "Select Device(s)", allowClear: true });

        // -------------------------------------------------
        // AUTOSIZE: justification textarea
        // -------------------------------------------------
        // auto-resize as the user types
        $('#justification').on('input', function () {
          autoResizeTextarea(this);
        });

        // -------------------------------------------------
        // FLEET → DEVICE POPULATION
        // -------------------------------------------------
        $('#fleet').on('change', function () {
          const fleet = $(this).val();
          const $device = $('#device');
          $device.empty().trigger('change');
          $('#deviceCol').toggle(!!fleet);
          if (fleet && fleetDeviceMap[fleet]) {
            fleetDeviceMap[fleet].forEach(d => $device.append(`<option value="${d}">${d}</option>`));
          }
        });

        // -------------------------------------------------
        // PARTS ROW
        // -------------------------------------------------
        window.addPartRow = function (data = {}) {
          const row = `<tr>
            <td><input type="text" class="form-control form-control-sm part-input" value="${h(data.part || '')}"></td>
            <td><input type="text" class="form-control form-control-sm desc-input" value="${h(data.desc || '')}"></td>
            <td>
              <select class="form-control form-control-sm type-select">
                <option value="" ${data.type === '' ? 'selected' : ''}></option>
                <option value="add" ${data.type === 'add' ? 'selected' : ''}>Add</option>
                <option value="remove" ${data.type === 'remove' ? 'selected' : ''}>Remove</option>
                <option value="modify" ${data.type === 'modify' ? 'selected' : ''}>Modify</option>
              </select>
            </td>
            <td><input type="number" class="form-control form-control-sm qty-input" value="${h(data.qty || '')}" min="1"></td>
            <td><button type="button" class="btn btn-sm btn-outline-danger remove-row">×</button></td>
          </tr>`;
          $('#partsTable tbody').append(row);
        };
        // -------------------------------------------------
        // INSTRUCTION ROW (with auto-resize)
        // -------------------------------------------------
        window.addInstrRow = function (data = {}) {
          const idx = $('#instrTable tbody tr').length;
          const row = `
    <tr>
      <td class="text-center align-middle">${idx + 1}</td>
      <td>
        <textarea class="form-control instr-text" name="instructions[${idx}][instruction]"
                  placeholder="Enter instruction..." rows="1">${(data.instruction || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
      </td>
      <td>
   <input type="text" class="form-control instr-notes" name="instructions[${idx}][notes]"
     value="${h(data.notes || '')}" placeholder="Notes">
      </td>
      <td class="text-center align-middle">
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeInstrRow(this)">
          <i class="bi bi-trash"></i>
        </button>
      </td>
    </tr>`;
          $('#instrTable tbody').append(row);

          // Initialise TinyMCE on the *new* textarea
          tinymce.init({
            // Use valid CSS selector (:last is jQuery-only); use :last-child for native querySelectorAll
            selector: `#instrTable tbody tr:last-child .instr-text`,
            height: 80,
            menubar: false,
            plugins: 'lists link image table code autoresize',
            toolbar: 'undo redo | bold italic underline | bullist numlist | link image| removeformat | code | table',
            branding: false,
            statusbar: true,
            resize: true,
            autoresize_bottom_margin: 12,
            images_upload_handler: function (blobInfo, progress) {
              return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', './src/upload_image.php');

                xhr.upload.onprogress = (e) => {
                  progress(e.loaded / e.total * 100);
                };

                xhr.onload = () => {
                  if (xhr.status < 200 || xhr.status >= 300) {
                    reject('HTTP Error: ' + xhr.status);
                    return;
                  }
                  const json = JSON.parse(xhr.responseText);
                  if (!json || typeof json.location !== 'string') {
                    reject('Invalid JSON: ' + xhr.responseText);
                    return;
                  }

                  // RESIZE: Limit max width to 600px (adjust as needed)
                  const img = new Image();
                  img.onload = function () {
                    const maxWidth = 600;
                    if (img.width > maxWidth) {
                      const canvas = document.createElement('canvas');
                      const ctx = canvas.getContext('2d');
                      canvas.width = maxWidth;
                      canvas.height = (img.height * maxWidth) / img.width;
                      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                      canvas.toBlob((resizedBlob) => {
                        // Re-upload resized version? Or just insert scaled
                        resolve(json.location + '?w=' + maxWidth); // Or keep original, scale in CSS
                      }, blobInfo.blob().type);
                    } else {
                      resolve(json.location);
                    }
                  };
                  img.src = URL.createObjectURL(blobInfo.blob());

                  // Fallback: just insert original
                  setTimeout(() => resolve(json.location), 100);
                };

                xhr.onerror = () => reject('Upload failed');

                const formData = new FormData();
                formData.append('file', blobInfo.blob(), blobInfo.filename());
                formData.append('sea_id', $('#sea_id').val() || 'temp');
                xhr.send(formData);
              });
            },
            setup: ed => {
              ed.on('change keyup', () => {
                ed.save();
                try { autoResizeTextarea(ed.getElement()); } catch (e) { }
              });
            }
          });
          // end of addInstrRow - close the function so subsequent handlers are at document-ready scope
        }

        // -------------------------------------------------
        // REMOVE ROW (update step numbers)
        // (bind once at document-ready scope, not on every row add)
        // -------------------------------------------------
        $(document).on('click', '.remove-row', function () {
          $(this).closest('tr').remove();
          $('#instrTable tbody .step-num').each((i, el) => $(el).text(i + 1));
          stepCounter = $('#instrTable tbody tr').length + 1;
        });

        // -------------------------------------------------
        // FORM SUBMIT
        // -------------------------------------------------
        $('#seaForm').on('submit', function (e) {
          e.preventDefault();
          const $form = $(this);
          const $btn = $('#submitBtn');
          $btn.prop('disabled', true).text('Saving...');

          // Clear old alerts
          $('.alert').remove();

          // Collect form data
          const formData = new FormData(this);
          formData.set('parts_json', JSON.stringify(getParts()));
          formData.set('instructions_json', JSON.stringify(getInstructions()));

          // First, try submit
          $.ajax({
            url: './src/submit.php',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            dataType: 'json',
            success: function (res) {
              if (res.conflict) {
                // SHOW MODAL with conflict list
                const $list = $('#conflictList').empty();
                res.conflicting_files.forEach(f => {
                  $list.append(`<li><code>${f}</code></li>`);
                });

                const modal = new bootstrap.Modal('#overwriteModal');
                $('#confirmOverwrite').off('click').on('click', function () {
                  modal.hide();
                  // Resubmit with overwrite flag
                  res.conflicting_files.forEach(f => {
                    formData.append('overwrite[]', f);
                  });
                  $btn.prop('disabled', true).text('Overwriting...');
                  $.ajax({
                    url: './src/submit.php',
                    method: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    dataType: 'json',
                    success: handleSuccess,
                    error: handleError
                  });
                });
                modal.show();
                $btn.prop('disabled', false).text(
                  $('#sea_action').val() === 'create' ? 'Create SEA' : 'Update SEA'
                );
              } else {
                handleSuccess(res);
              }
            },
            error: handleError
          });

          function handleSuccess(res) {
            if (res.success) {
              showAlert('success', res.message);
              $('html, body').animate({ scrollTop: 0 }, 300);

              if ($('#sea_action').val() === 'create') {
                $('#sea_id').val(res.sea_id);
                $('#display_id').val(res.sea_id);
                $('#sea_action').val('update');
                $('#formTitle').text('Edit SEA – ' + res.sea_id);
                $('#submitBtn').text('Update SEA');
                history.replaceState(null, null, '?id=' + res.sea_id);
              }

              // Refresh attachments list
              loadExistingAttachments(res.attachments || []);

              // Optional: auto-download PDF
              // if (res.pdf) downloadPdf(res.pdf, res.pdf_name);
            } else {
              showAlert('danger', res.message || 'Unknown error');
            }
            $btn.prop('disabled', false).text(
              $('#sea_action').val() === 'create' ? 'Create SEA' : 'Update SEA'
            );
          }

          function handleError(xhr) {
            showAlert('danger', xhr.responseJSON?.message || 'Network error');
            $btn.prop('disabled', false).text(
              $('#sea_action').val() === 'create' ? 'Create SEA' : 'Update SEA'
            );
          }
        });


        function showAlert(type, message) {
          const alert = `<div class="alert alert-${type} alert-dismissible fade show mt-3" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
          $('#createForm').prepend(alert);
          $('html, body').animate({ scrollTop: 0 }, 300);
        }

        function downloadPdf(base64, filename) {
          const link = document.createElement('a');
          link.href = 'data:application/pdf;base64,' + base64;
          link.download = filename;
          link.click();
        }

        // -------------------------------------------------
        // NAVIGATION
        // -------------------------------------------------
        window.showCreateForm = function () {
          hideAll();
          resetForm();               // <-- NEW
          addPartRow();  // Add initial blank row for new SEA
          $('#createForm').removeClass('hidden');

          if (!$('#sea_id').val()) {
            // === NEW SEA: Setup form ===
            $('#sea_action').val('create');
            $('#formTitle').text('New SEA');
            $('#submitBtn').text('Create SEA');
            stepCounter = 1;
            $('#partsTable tbody').empty();
            $('#instrTable tbody').empty();
            $('#existingAttachments').html('<small class="text-muted">No attachments</small>');
            addPartRow();
            addInstrRow();

            // === PREVIEW ID: Generate initial preview ===
            generateIdPreview();

            // === LIVE UPDATE: When fleet changes, update ID preview ===
            $('#fleet').off('change.idPreview').on('change.idPreview', generateIdPreview);
          } else {
            // === EDIT MODE: Don't mess with existing ID ===
            $('#fleet').off('change.idPreview'); // Remove listener if editing
          }
        };

        // === HELPER: Generate and display SEA ID preview ===
        function generateIdPreview() {
          const fleetSelect = $('#fleet');
          let fleet = fleetSelect.val() || 'UNKNOWN';
          fleet = fleet.toUpperCase().replace(/[^A-Z0-9]/g, '');
          if (fleet === '') fleet = 'UNKNOWN';

          const today = new Date();
          const datePart = today.toISOString().slice(2, 10).replace(/-/g, ''); // YYYYMMDD
          const randomPart = String(Math.floor(100 + Math.random() * 900)).padStart(3, '0'); // 100–999

          const previewId = `SEA-${fleet}-${datePart}-${randomPart}`;
          $('#display_id').val(previewId);
        }
        window.showSeaList = function () {
          hideAll();
          $('#listView').removeClass('hidden');
          loadSeaList();
        };

        window.goBack = function () {
          hideAll();
          $('#choiceScreen').removeClass('hidden');
          history.replaceState(null, null, window.location.pathname);
        };

        function hideAll() {
          $('#choiceScreen, #createForm, #listView').addClass('hidden');
        }

        // -------------------------------------------------
        // LIST & EDIT
        // -------------------------------------------------
        function loadSeaList() {
          const $c = $('#seaContainer');
          $c.html('<div class="text-center py-5"><div class="spinner-border"></div> Loading...</div>');
          fetch('./src/list_seas.php')
            .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.text(); })
            .then(html => {
              $c.html(html);

              // Reset and populate fleet filter
              // Inside loadSeaList(), after populating .sea-card
              $('#fleetFilter').html('<option value="">All Fleets</option>');
              const fleets = new Set();

              $('.sea-card').each(function () {
                const $card = $(this);
                const $fleetStrong = $card.find('strong').filter((_, el) => $(el).text().trim() === 'Fleet:');
                if ($fleetStrong.length) {
                  let fleetVal = '';
                  const next = $fleetStrong[0].nextSibling;
                  if (next && next.nodeType === Node.TEXT_NODE) {
                    fleetVal = next.textContent.split('|')[0].trim();
                  } else {
                    const match = $fleetStrong.parent().text().match(/Fleet:\s*([^\|]+)/i);
                    fleetVal = match ? match[1].trim() : '';
                  }
                  if (fleetVal) fleets.add(fleetVal);
                }
              });

              Array.from(fleets).sort().forEach(f => {
                $('#fleetFilter').append(`<option value="${f}">${f}</option>`);
              });
              // Trigger initial filter (in case of URL params or defaults)
              filterList();
            })
            .catch(err => $c.html(`<div class="alert alert-danger">Failed: ${err.message}</div>`));
        }

        // Combined filtering function
        function filterList() {
          const term = $('#searchInput').val().toLowerCase().trim();
          const selectedFleet = $('#fleetFilter').val(); // Keep original case for comparison

          $('.sea-card').each(function () {
            const $card = $(this);
            const $col = $card.closest('.col-md-6');

            // --- Search term match ---
            const fullText = $card.text().toLowerCase();
            const matchesSearch = !term || fullText.includes(term);

            // --- Fleet match: Look for <strong>Fleet:</strong> followed by value ---
            let cardFleet = '';
            const $fleetStrong = $card.find('strong').filter(function () {
              return $(this).text().trim() === 'Fleet:';
            });
            if ($fleetStrong.length) {
              // Get the text *after* the <strong>Fleet:</strong>
              const fleetNode = $fleetStrong[0].nextSibling;
              if (fleetNode && fleetNode.nodeType === Node.TEXT_NODE) {
                cardFleet = fleetNode.textContent.split('|')[0].trim();
              } else {
                // Fallback: get parent <p> and extract after "Fleet:"
                const pText = $fleetStrong.parent().text();
                const match = pText.match(/Fleet:\s*([^\|]+)/i);
                cardFleet = match ? match[1].trim() : '';
              }
            }

            const matchesFleet = !selectedFleet || cardFleet === selectedFleet;

            // Show/hide based on both filters
            $col.toggle(matchesSearch && matchesFleet);
          });
        }


        // Event listeners for filtering
        $('#searchInput').on('input', filterList);
        $('#fleetFilter').on('change', filterList);


        window.deleteSea = function (id) {
          if (!confirm(`Delete SEA-${id}? This cannot be undone.`)) return;
          const f = document.createElement('form');
          f.method = 'POST'; f.action = './src/delete.php'; f.style.display = 'none';
          const i = document.createElement('input');
          i.type = 'hidden'; i.name = 'filename'; i.value = `sea-${id}.json`;
          f.appendChild(i); document.body.appendChild(f); f.submit();
        };

        window.editSea = function (id) {
          hideAll();

          // ---- Form mode -------------------------------------------------
          $('#sea_action').val('update');
          $('#formTitle').text('Edit SEA – ' + id);
          $('#submitBtn').text('Update SEA');

          // ---- Reset form completely (clears everything safely) ----------
          resetForm();  // This replaces all your manual .empty() and .reset() calls

          // ---- SEA ID must survive the reset ----------------------------
          $('#sea_id').val(id);
          $('#display_id').val(id);

          // ---- Load JSON -------------------------------------------------
          fetch(`data/sea-${id}.json`)
            .then(r => { if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); })
            .then(d => {
              console.log('Loaded SEA data →', d);

              // ----- Basic fields -----
              $('#ea_number').val(d.ea_number || '');
              $('#revision').val(d.revision || '');
              $('#requester').val(d.requester || '');
              $('#description').val(d.description || '');
              $('#justification').val(d.justification || '');

              // ----- Impact -----
              $('#impact').val(d.impact || '');

              $('#priority').val(d.priority || 'Medium');
              $('#target_date').val(d.target_date || '');
              $('#status').val(d.status || 'Planning');

              // ----- Parts: Load existing, then add blank row only if empty -----
              const parts = JSON.parse(d.parts_json || '[]') || [];
              parts.forEach(addPartRow);
              if (parts.length === 0) {
                addPartRow();  // Add one blank row only if no parts exist
              }

              // ----- Instructions: Just load existing (no auto-blank) -----
              (JSON.parse(d.instructions_json || '[]') || []).forEach(addInstrRow);

              // ----- TinyMCE re-init -----
              setTimeout(() => {
                tinymce.remove('#instrTable .instr-text');
                tinymce.init({
                  selector: '#instrTable .instr-text',
                  height: 80,
                  menubar: false,
                  plugins: 'lists link image table code autoresize',
                  toolbar: 'undo redo | bold italic underline | bullist numlist | link image| removeformat | code | table',
                  branding: false,
                  statusbar: true,
                  resize: true,
                  autoresize_bottom_margin: 12,
                  images_upload_handler: function (blobInfo, progress) {
                    return new Promise((resolve, reject) => {
                      const xhr = new XMLHttpRequest();
                      xhr.open('POST', './src/upload_image.php');

                      xhr.upload.onprogress = (e) => {
                        progress(e.loaded / e.total * 100);
                      };

                      xhr.onload = () => {
                        if (xhr.status < 200 || xhr.status >= 300) {
                          reject('HTTP Error: ' + xhr.status);
                          return;
                        }
                        const json = JSON.parse(xhr.responseText);
                        if (!json || typeof json.location !== 'string') {
                          reject('Invalid JSON: ' + xhr.responseText);
                          return;
                        }

                        // RESIZE: Limit max width to 600px (adjust as needed)
                        const img = new Image();
                        img.onload = function () {
                          const maxWidth = 600;
                          if (img.width > maxWidth) {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            canvas.width = maxWidth;
                            canvas.height = (img.height * maxWidth) / img.width;
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            canvas.toBlob((resizedBlob) => {
                              // Re-upload resized version? Or just insert scaled
                              resolve(json.location + '?w=' + maxWidth); // Or keep original, scale in CSS
                            }, blobInfo.blob().type);
                          } else {
                            resolve(json.location);
                          }
                        };
                        img.src = URL.createObjectURL(blobInfo.blob());

                        // Fallback: just insert original
                        setTimeout(() => resolve(json.location), 100);
                      };

                      xhr.onerror = () => reject('Upload failed');

                      const formData = new FormData();
                      formData.append('file', blobInfo.blob(), blobInfo.filename());
                      formData.append('sea_id', $('#sea_id').val() || 'temp');
                      xhr.send(formData);
                    });
                  },
                  setup: ed => {
                    ed.on('change keyup', () => {
                      ed.save();
                      try { autoResizeTextarea(ed.getElement()); } catch (e) { }
                    });
                  }
                });
                $('#instrTable .instr-text').each(function () { autoResizeTextarea(this); });
              }, 150);

              // ----- Attachments -----
              loadExistingAttachments(d.attachments || []);

              // ----- Fleet / Device -----
              $('#fleet').val(d.fleet || '').trigger('change');
              const devices = Array.isArray(d.device) ? d.device : (d.device ? [d.device] : []);
              $('#device').val(devices).trigger('change');

              // ----- Finally show the form -----
              $('#createForm').removeClass('hidden');
            })
            .catch(err => {
              console.error(err);
              showAlert('danger', 'Failed to load SEA: ' + err.message);
              $('#choiceScreen').removeClass('hidden');
            });
        };        // -------------------------------------------------
        // SEARCH
        // -------------------------------------------------
        // $('#searchInput').on('input', function () {
        //   const term = this.value.toLowerCase();
        //   $('.sea-card').each(function () {
        //     const txt = this.textContent.toLowerCase();
        //     $(this).closest('.col-md-6')[txt.includes(term) ? 'show' : 'hide']();
        //   });
        // });

        // -------------------------------------------------
        // STARTUP
        // -------------------------------------------------
        hideAll();
        $('#choiceScreen').removeClass('hidden');

        const urlParams = new URLSearchParams(window.location.search);
        const editId = urlParams.get('id');
        if (editId) editSea(editId);

        // Click-to-expand for SEA descriptions
        document.addEventListener('click', function (e) {
          if (e.target.classList.contains('expand-desc')) {
            e.preventDefault();
            const shortSpan = e.target.previousElementSibling;
            const fullText = shortSpan.dataset.full;
            const shortText = shortSpan.dataset.short;

            if (shortSpan.dataset.expanded) {
              // Collapse
              shortSpan.innerHTML = shortText;
              shortSpan.style = 'max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; display:inline-block;';
              e.target.innerHTML = '[show more]';
              delete shortSpan.dataset.expanded;
            } else {
              // Expand
              shortSpan.innerHTML = fullText;
              shortSpan.style = '';
              e.target.innerHTML = '[show less]';
              shortSpan.dataset.expanded = '1';
            }
          }
        });
      });

      // -------------------------------------------------
      // COLLECT PARTS DATA
      // -------------------------------------------------
      function getParts() {
        const parts = [];
        $('#partsTable tbody tr').each(function () {
          const row = $(this);
          parts.push({
            part: row.find('.part-input').val().trim(),
            desc: row.find('.desc-input').val().trim(),
            type: row.find('.type-select').val().trim(),
            qty: row.find('.qty-input').val().trim()
          });
        });
        return parts;
      }
      // -------------------------------------------------
      // COLLECT INSTRUCTIONS DATA
      // -------------------------------------------------
      function getInstructions() {
        const instructions = [];
        $('#instrTable tbody tr').each(function () {
          const row = $(this);
          instructions.push({
            instruction: row.find('.instr-text').val().trim(),
            notes: row.find('.instr-notes').val().trim()
          });
        });
        return instructions;
      }

      window.removeInstrRow = function (btn) {
        const editorId = tinymce.get($(btn).closest('tr').find('.instr-text').attr('id'));
        if (editorId) tinymce.remove(editorId);
        $(btn).closest('tr').remove();
        renumberInstr();
      };


      // -------------------------------------------------
      // RESET THE WHOLE FORM (including TinyMCE, Select2, tables)
      // -------------------------------------------------
      function resetForm() {
        // 1. Reset the actual <form id="seaForm">
        const formEl = document.getElementById('seaForm');
        if (formEl && typeof formEl.reset === 'function') {
          formEl.reset();
        }

        // 2. Clear Select2 fields (not reset by form.reset())
        $('#fleet, #device, #priority, #status').val('').trigger('change');

        // 3. Clear TinyMCE + instruction rows
        tinymce.remove('#instrTable .instr-text');
        $('#instrTable tbody').empty();

        // 4. Clear parts table + add one blank row
        $('#partsTable tbody').empty();
        //addPartRow();  // one empty row for user

        // 5. Clear attachments UI
        $('#existingAttachments')
          .empty()
          .html('<small class="text-muted">No attachments</small>');
        $('#attachments').val('');  // file input

        // 6. Clear any fields that might be outside form or not reset
        $('#ea_number, #revision, #impact, #justification, #description, #requester, #target_date')
          .val('');

        // 7. Remove alerts
        $('.alert').remove();
      }
    </script>

    <!-- Overwrite Confirmation Modal -->
    <div class="modal fade" id="overwriteModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title text-warning">File Already Exists</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p>The following file(s) already exist:</p>
            <ul id="conflictList" class="list-unstyled"></ul>
            <p>Do you want to <strong>overwrite</strong> them?</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-warning" id="confirmOverwrite">Overwrite</button>
          </div>
        </div>
      </div>
    </div>

</body>

</html>