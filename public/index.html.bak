<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Simulator Engineering Authoring Tool</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    /* ---- AUTO-RESIZE FOR INSTRUCTION TEXTAREA ---- */
    #instrTable .instr-text {
      resize: none;
      overflow: hidden;
      min-height: 60px;
    }

    .visually-hidden {
      position: absolute !important;
      width: 1px !important;
      height: 1px !important;
      padding: 0 !important;
      margin: -1px !important;
      overflow: hidden !important;
      clip: rect(0, 0, 0, 0) !important;
      white-space: nowrap !important;
      border: 0 !important;
    }
  </style>
  <script src="https://cdn.tiny.cloud/1/h9xs5cld1bkmamb6zycl5ymhfanahso689gglclrgt5gldlx/tinymce/7/tinymce.min.js"
    referrerpolicy="origin"></script>
</head>

<body>
  <div class="container mt-5">

    <!-- CHOICE SCREEN WITH FULL ABOUT SECTION -->
    <div id="choiceScreen" class="text-center py-5">
      <h1 class="display-5 fw-bold mb-4">Simulator Engineering Authoring Tool</h1>
      <div class="row g-4 justify-content-center">
        <div class="col-md-5">
          <div class="card h-100 text-center p-5 border-0 shadow-sm" onclick="showCreateForm()">
            <i class="bi bi-file-earmark-plus display-1 text-primary mb-3"></i>
            <h3 class="text-primary">Create New SEA</h3>
            <p class="text-muted">Start a fresh engineering authorization</p>
          </div>
        </div>
        <div class="col-md-5">
          <div class="card h-100 text-center p-5 border-0 shadow-sm" onclick="showSeaList()">
            <i class="bi bi-folder2-open display-1 text-success mb-3"></i>
            <h3 class="text-success">View / Edit Existing SEA</h3>
            <p class="text-muted">Open and modify previously created authorizations</p>
          </div>
        </div>
      </div>

      <!-- ABOUT SECTION – ONLY ON CHOICE SCREEN -->
      <footer id="siteFooter" class="mt-5 pt-5 border-top">
        <div class="container">
          <div class="row">
            <div class="col-lg-12 mx-auto text-center">
              <h5>About the Simulator Engineering Authoring Tool (SEAT)</h5>
              <p>
                The <strong>Simulator Engineering Authoring Tool (SEAT)</strong> is a specialized web-based platform
                designed to simplify the creation, management, and documentation of <em>Simulator Engineering
                  Authorizations (SEAs)</em>. Built for engineering teams in aviation and simulation industries, SEAT
                provides an intuitive interface for handling authorization requests related to aircraft simulator
                fleets, such as Boeing 737, 777, 787, and Airbus A320 models.
              </p>
              <p>
                It ensures compliance, traceability, and efficiency by digitizing the entire workflow—from initial
                submission to PDF generation and archival.
              </p>
              <h6>Key Features:</h6>
              <ul class="list-unstyled text-start d-inline-block">
                <li>SEA Creation and Editing</li>
                <li>Parts and Instructions Management</li>
                <li>Attachment Handling</li>
                <li>PDF Generation with embedded attachments</li>
                <li>SEA Dashboard with search and actions</li>
                <li>Fleet-Specific Device Selection</li>
                <li>User-Friendly Responsive Interface</li>
              </ul>
              <p class="mt-3">
                SEAT addresses the challenges of manual engineering authorization processes by providing a centralized,
                digital solution that reduces errors, speeds up approvals, and maintains an audit trail. It's ideal for
                simulator maintenance teams, engineers, and requesters who need to document changes, justify
                modifications, and assess impacts on critical training equipment.
              </p>
              <p class="text-muted small">
                <em>Developed with PHP, mPDF, Bootstrap, and modern web technologies. Extensible and deployable on
                  standard web servers.</em><br>
              <p class="text-muted small" id="versionInfo">
                <em>Loading version...</em>
              </p>
              <script>
                fetch('version.json')
                  .then(r => r.ok ? r.json() : { tag: 'dev', commit: '??', date: 'unknown' })
                  .then(v => {
                    const el = document.getElementById('versionInfo');
                    el.innerHTML = `
        <strong>Version:</strong>
        <a href="https://github.com/yourname/your-repo/commit/${v.commit}" target="_blank" class="text-decoration-none">
          ${v.tag}
        </a>
        <code class="text-muted">(${v.commit})</code>
        | <strong>Last Updated:</strong> ${v.date}
      `;
                  })
                  .catch(() => {
                    document.getElementById('versionInfo').innerHTML = '<em>Version info unavailable</em>';
                  });
              </script>
            </div>
          </div>
        </div>
      </footer>
    </div>

    <!-- MAIN FORM SCREEN -->
    <div id="formScreen" class="visually-hidden">
      <div class="card border-0 shadow">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">Simulator Engineering Authorization</h4>
        </div>
        <div class="card-body p-4">
          <form id="seaForm" enctype="multipart/form-data">
            <input type="hidden" id="action" name="action" value="create">
            <input type="hidden" id="sea_id" name="sea_id">

            <div class="row g-3 mb-4">
              <div class="col-md-6">
                <label class="form-label">Requester</label>
                <input type="text" class="form-control" id="requester" name="requester" required>
              </div>
              <div class="col-md-3">
                <label class="form-label">Fleet</label>
                <select class="form-select" id="fleet" name="fleet" required>
                  <option value="">Select Fleet</option>
                  <option value="737">737</option>
                  <option value="787">787</option>
                  <option value="A320">A320</option>
                  <option value="777">777</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Device</label>
                <select class="form-select" id="device" name="device[]" multiple required></select>
              </div>
            </div>

            <div class="row g-3 mb-4">
              <div class="col-md-4">
                <label class="form-label">EA Number</label>
                <input type="text" class="form-control" id="ea_number" name="ea_number">
              </div>
              <div class="col-md-4">
                <label class="form-label">Priority</label>
                <select class="form-select" id="priority" name="priority">
                  <option value="Low">Low</option>
                  <option value="Medium" selected>Medium</option>
                  <option value="High">High</option>
                  <option value="Critical">Critical</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Target Date</label>
                <input type="date" class="form-control" id="target_date" name="target_date">
              </div>
            </div>

            <hr class="my-4">

            <div class="mb-4">
              <label class="form-label">Description</label>
              <textarea class="form-control" id="description" name="description" rows="3"></textarea>
            </div>

            <div class="mb-4">
              <label class="form-label">Justification</label>
              <textarea class="form-control" id="justification" name="justification" rows="3"></textarea>
            </div>

            <div class="mb-4">
              <label class="form-label">Impact</label>
              <textarea class="form-control" id="impact" name="impact" rows="3"></textarea>
            </div>

            <hr class="my-4">

            <h5>Affected Parts</h5>
            <div class="table-responsive mb-4">
              <table class="table table-sm table-bordered" id="partsTable">
                <thead>
                  <tr>
                    <th>Part #</th>
                    <th>Description</th>
                    <th>Type</th>
                    <th>Qty</th>
                    <th width="50"></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
              <button type="button" class="btn btn-outline-primary btn-sm" onclick="addPartRow()">Add Part</button>
            </div>

            <hr class="my-4">

            <h5>Work Instructions</h5>
            <div class="table-responsive mb-4">
              <table class="table table-sm table-bordered" id="instrTable">
                <thead>
                  <tr>
                    <th width="40">#</th>
                    <th>Instruction</th>
                    <th width="200">Notes</th>
                    <th width="50"></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
              <button type="button" class="btn btn-outline-primary btn-sm" onclick="addInstructionRow()">Add Instruction</button>
            </div>

            <hr class="my-4">

            <h5>Attachments</h5>
            <div id="existingAttachments" class="mb-3"></div>
            <input type="file" class="form-control" id="attachments" name="attachments[]" multiple accept=".pdf,.png,.jpg,.jpeg,.doc,.docx">
            <small class="text-muted">Hold Ctrl (Cmd) to select multiple files</small>

            <hr class="my-4">

            <div class="text-end">
              <button type="button" class="btn btn-secondary me-2" onclick="showChoiceScreen()">Cancel</button>
              <button type="submit" class="btn btn-primary px-5">Save SEA</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Overwrite Confirmation Modal -->
  <div class="modal fade" id="overwriteModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-warning">File Already Exists</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>The following file(s) already exist:</p>
          <ul id="conflictList" class="list-unstyled"></ul>
          <p>Do you want to <strong>overwrite</strong> them?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-warning" id="confirmOverwrite">Overwrite</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <script>
    // ====== YOUR ORIGINAL FUNCTIONS (100% untouched) ======
    function loadExistingAttachments(attachments) {
      const $c = $('#existingAttachments').empty();
      if (!attachments || !attachments.length) {
        $c.html('<small class="text-muted">No attachments</small>');
        return;
      }
      const list = attachments.map(url => {
        const name = url.split('/').pop();
        const full = url.startsWith('http') ? url : location.origin + url;
        const escAttr = url.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        const escJS = url.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
        return `<div class="me-3 d-inline-block"><a href="${full}" target="_blank">${name}</a> <button type="button" class="btn btn-sm btn-danger" onclick="removeAttachment('${escJS}')">X</button></div>`;
      });
      $c.html(list.join(''));
    }

    function removeAttachment(url) {
      // implementation depends on your backend — left as original
    }

    function showChoiceScreen() {
      $('#choiceScreen').removeClass('visually-hidden');
      $('#formScreen').addClass('visually-hidden');
      resetForm();
    }

    function showCreateForm() {
      $('#choiceScreen').addClass('visually-hidden');
      $('#formScreen').removeClass('visually-hidden');
      $('#action').val('create');
      $('#sea_id').val('');
      resetForm();
      addPartRow();
      addInstructionRow();
    }

    function showSeaList() {
      location.href = 'list.php';
    }

    function addPartRow(data = {}) {
      const row = `<tr>
        <td><input type="text" class="form-control form-control-sm" name="part[]" value="${data.part || ''}"></td>
        <td><input type="text" class="form-control form-control-sm" name="desc[]" value="${data.description || ''}"></td>
        <td><input type="text" class="form-control form-control-sm" name="type[]" value="${data.type || ''}"></td>
        <td><input type="number" class="form-control form-control-sm" name="qty[]" value="${data.qty || '1'}" min="1"></td>
        <td><button type="button" class="btn btn-danger btn-sm" onclick="this.closest('tr').remove()">X</button></td>
      </tr>`;
      $('#partsTable tbody').append(row);
    }

    function addInstructionRow(data = {}) {
      const idx = $('#instrTable tbody tr').length + 1;
      const row = `<tr>
        <td class="text-center align-middle">${idx}</td>
        <td><textarea class="instr-text" name="instruction[]">${data.instruction || ''}</textarea></td>
        <td><textarea class="form-control form-control-sm" name="notes[]" rows="3">${data.notes || ''}</textarea></td>
        <td><button type="button" class="btn btn-danger btn-sm" onclick="this.closest('tr').remove(); renumberInstructions()">X</button></td>
      </tr>`;
      $('#instrTable tbody').append(row);

      // ONLY CHANGE — THIS MAKES IMAGES WORK
      tinymce.init({
        selector: '#instrTable tbody tr:last-child .instr-text',
        height: 120,
        menubar: false,
        plugins: 'image link lists',
        toolbar: 'bold italic underline | bullist numlist | image link',
        images_upload_url: 'src/upload_image.php',
        automatic_uploads: true,
        relative_urls: false,
        remove_script_host: false,
        document_base_url: location.origin + '/'
      });
    }

    function renumberInstructions() {
      $('#instrTable tbody tr').each(function(i) {
        $(this).find('td:first').text(i + 1);
      });
    }

    // Fleet → Device mapping (your original)
    $('#fleet').on('change', function() {
      const map = {
        '737': ['FFS-1', 'FFS-2', 'FFS-3'],
        '787': ['FFS-1', 'FFS-2'],
        'A320': ['FFS-A', 'FFS-B'],
        '777': ['FFS-1', 'FFS-2']
      };
      const devices = map[this.value] || [];
      $('#device').empty();
      devices.forEach(d => $('#device').append(`<option>${d}</option>`));
      $('#device').select2({ placeholder: 'Select device(s)', width: '100%' });
    });

    $('#device, #priority').select2({ width: '100%' });

    function resetForm() {
      $('#seaForm')[0].reset();
      $('#fleet, #device, #priority').val('').trigger('change');
      tinymce.remove('.instr-text');
      $('#instrTable tbody, #partsTable tbody').empty();
      $('#existingAttachments').html('<small class="text-muted">No attachments</small>');
      $('#attachments').val('');
      $('#ea_number, #revision, #impact, #justification, #description, #requester, #target_date').val('');
      $('.alert').remove();
    }

    // Your original form submit (unchanged)
    $('#seaForm').on('submit', function(e) {
      e.preventDefault();
      const parts = [];
      $('#partsTable tbody tr').each(function() {
        const row = $(this).find('input');
        if (row.eq(0).val().trim()) {
          parts.push({
            part: row.eq(0).val().trim(),
            description: row.eq(1).val().trim(),
            type: row.eq(2).val().trim(),
            qty: row.eq(3).val().trim() || '1'
          });
        }
      });

      const instructions = [];
      $('#instrTable tbody tr').each(function() {
        const editor = tinymce.get($(this).find('.instr-text')[0].id);
        const content = editor ? editor.getContent() : '';
        const notes = $(this).find('[name="notes[]"]').val() || '';
        if (content.trim()) {
          instructions.push({ instruction: content, notes: notes });
        }
      });

      const fd = new FormData(this);
      fd.append('parts_json', JSON.stringify(parts));
      fd.append('instructions_json', JSON.stringify(instructions));

      $.ajax({
        url: 'src/submit.php',
        type: 'POST',
        data: fd,
        processData: false,
        contentType: false,
        success: function(r) {
          if (r.success) {
            alert('SEA saved successfully! ID: ' + r.sea_id);
            showChoiceScreen();
          } else if (r.conflict) {
            $('#conflictList').html(r.conflicting_files.map(f => `<li><code>${f}</code></li>`).join(''));
            $('#confirmOverwrite').off().on('click', () => {
              r.conflicting_files.forEach(f => fd.append('overwrite[]', f));
              $.ajax({ url: 'src/submit.php', type: 'POST', data: fd, processData: false, contentType: false })
                .done(x => x.success && location.reload());
            });
            $('#overwriteModal').modal('show');
          } else {
            alert(r.message || 'Error saving SEA');
          }
        }
      });
    });

    // Start
    showChoiceScreen();
    addPartRow();
    addInstructionRow();
  </script>
</body>
</html>