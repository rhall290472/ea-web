<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Simulator Engineering Authoring Tool</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
  <link rel="stylesheet" href="style.css">
  <style>
    /* TinyMCE in table cells */
    .tox-tinymce {
      height: 120px !important;
      border: 1px solid #ced4da;
      border-radius: .25rem;
    }

    /* DataTables input styling */
    #partsTable input,
    #partsTable textarea,
    #partsTable select {
      width: 100%;
      border: 1px solid #ced4da;
      border-radius: .25rem;
      padding: .25rem .5rem;
      font-size: .875rem;
    }

    #partsTable input:focus,
    #partsTable textarea:focus,
    #partsTable select:focus {
      border-color: #86b7fe;
      outline: 0;
      box-shadow: 0 0 0 .2rem rgba(13, 110, 253, .25);
    }

    #partsTable thead th {
      font-weight: 600;
      font-size: .875rem;
    }

    /* Rich-text preview */
    .instruction-preview {
      white-space: normal;
      line-height: 1.5;
      font-size: .9rem;
      color: #555;
      margin-top: .25rem;
    }
  </style>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- DataTables -->
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
  <!-- Select2 -->
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <!-- TinyMCE (free, no API key) -->
  <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>

  <!-- CRITICAL: Global functions before body -->
  <script>
    let partsTable = null;
    let tinymceInstances = [];

    function loadExistingAttachments(attachments) {
      const $c = $('#existingAttachments').empty();
      if (!attachments || !attachments.length) {
        $c.html('<small class="text-muted">No attachments</small>');
        return;
      }
      const list = attachments.map(url => {
        const name = url.split('/').pop();
        const full = url.startsWith('http') ? url : location.origin + url;
        const escAttr = url.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        const escJS = url.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
        return `<div class="d-flex align-items-center mb-1 p-2 border rounded bg-light">
                  <a href="${full}" target="_blank" class="text-decoration-none me-2 flex-grow-1">${name}</a>
                  <button type="button" class="btn btn-sm btn-outline-danger"
                          onclick="removeExistingAttachment(this, '${escJS}')">Remove</button>
                  <input type="hidden" name="keep_attachments[]" value="${escAttr}">
                </div>`;
      }).join('');
      $c.html(`<div class="border p-2 rounded bg-white mb-2">
                <small class="text-muted d-block mb-2"><strong>Current attachments:</strong></small>${list}
              </div>`);
    }

    function removeExistingAttachment(btn, url) {
      if (!confirm('Remove this attachment?')) return;
      $(btn).closest('div').remove();
    }
  </script>
</head>

<body>
  <div class="container mt-5">

    <!-- CHOICE SCREEN -->
    <div id="choiceScreen">
      <h1 class="text-center mb-5">Simulator Engineering Authoring Tool</h1>
      <div class="row g-4">
        <div class="col-md-6">
          <div class="card choice-card h-100 text-center p-4" onclick="showCreateForm()">
            <h2 class="text-primary">Create New SEA</h2>
            <p class="text-muted">Start a fresh engineering authorization</p>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card choice-card h-100 text-center p-4" onclick="showSeaList()">
            <h2 class="text-success">View / Edit Existing SEA</h2>
            <p class="text-muted">Search and modify previous submissions</p>
          </div>
        </div>
      </div>

      <!-- ABOUT SECTION -->
      <footer id="siteFooter">
        <div class="container">
          <div class="row">
            <div class="col-lg-12 mx-auto text-center">
              <h5>About the Simulator Engineering Authoring Tool (SEAT)</h5>
              <p>
                The <strong>Simulator Engineering Authoring Tool (SEAT)</strong> is a specialized web-based platform
                designed to simplify the creation, management, and documentation of <em>Simulator Engineering
                  Authorizations (SEAs)</em>. Built for engineering teams in aviation and simulation industries, SEAT
                provides an intuitive interface for handling authorization requests related to aircraft simulator
                fleets, such as Boeing 737, 777, 787, and Airbus A320 models.
              </p>
              <p>
                It ensures compliance, traceability, and efficiency by digitizing the entire workflow—from initial
                submission to PDF generation and archival.
              </p>

              <h6>Key Features:</h6>
              <ul class="list-unstyled text-start d-inline-block">
                <li>SEA Creation and Editing</li>
                <li>Parts and Instructions Management</li>
                <li>Attachment Handling</li>
                <li>PDF Generation with embedded attachments</li>
                <li>SEA Dashboard with search and actions</li>
                <li>Fleet-Specific Device Selection</li>
                <li>User-Friendly Responsive Interface</li>
              </ul>

              <p class="mt-3">
                SEAT addresses the challenges of manual engineering authorization processes by providing a centralized,
                digital solution that reduces errors, speeds up approvals, and maintains an audit trail. It's ideal for
                simulator maintenance teams, engineers, and requesters who need to document changes, justify
                modifications, and assess impacts on critical training equipment.
              </p>

              <p class="text-muted small">
                <em>Developed with PHP, mPDF, Bootstrap, and modern web technologies. Extensible and deployable on
                  standard web servers.</em><br>
                <strong>Version:</strong> 1.0 | <strong>Last Updated:</strong> November 2025
              </p>
            </div>
          </div>
        </div>
      </footer>
    </div>

    <!-- CREATE / EDIT FORM -->
    <div id="createForm" class="hidden">
      <button class="btn btn-sm btn-outline-secondary mb-3" onclick="goBack()">Back</button>
      <h3 id="formTitle">New SEA</h3>

      <form id="seaForm" class="row g-3" enctype="multipart/form-data">
        <input type="hidden" name="sea_id" id="sea_id">
        <input type="hidden" name="action" id="sea_action" value="create">
        <input type="hidden" name="parts_json" id="parts_json">
        <input type="hidden" name="instructions_json" id="instructions_json">

        <div class="col-md-4">
          <label>SEA ID</label>
          <input type="text" class="form-control" id="display_id" disabled>
        </div>
        <div class="col-md-4">
          <label>EA#</label>
          <input type="text" class="form-control" name="ea_number" id="ea_number">
        </div>
        <div class="col-md-4">
          <label>Revision</label>
          <input type="text" class="form-control" name="revision" id="revision">
        </div>
        <div class="col-12">
          <label>Title</label>
          <textarea class="form-control" name="description" id="description" rows="3"></textarea>
        </div>
        <div class="col-md-6">
          <label>Fleet</label>
          <select class="form-select" name="fleet" id="fleet">
            <option value="">Select Fleet...</option>
          </select>
        </div>
        <div class="col-md-6">
          <label>Device(s)</label>
          <select class="form-select" name="device[]" id="device" multiple></select>
        </div>
        <div class="col-md-6">
          <label>Requester</label>
          <input type="text" class="form-control" name="requester" id="requester">
        </div>
        <div class="col-md-6">
          <label>Status</label>
          <select class="form-select" name="status" id="status">
            <option value="Planning">Planning</option>
            <option value="In Work">In Work</option>
            <option value="Completed">Completed</option>
          </select>
        </div>
        <div class="col-12">
          <label>Justification</label>
          <textarea class="form-control" name="justification" id="justification" rows="3"></textarea>
        </div>
        <div class="col-12">
          <label>Impact</label>
          <textarea class="form-control" name="impact" id="impact" rows="3"></textarea>
        </div>
        <div class="col-md-6">
          <label>Priority</label>
          <select class="form-select" name="priority" id="priority">
            <option value="Low">Low</option>
            <option value="Medium" selected>Medium</option>
            <option value="High">High</option>
          </select>
        </div>
        <div class="col-md-6">
          <label>Target Date</label>
          <input type="date" class="form-control" name="target_date" id="target_date">
        </div>

        <!-- AFFECTED PARTS TABLE WITH DATATABLES SORTING -->
        <div class="col-12">
          <label class="form-label">Affected Parts</label>
          <div class="table-responsive">
            <table id="partsTable" class="table table-sm parts-table mb-4">
              <thead class="table-light">
                <tr>
                  <th style="width:22%;">Part</th>
                  <th style="width:38%;">Desc</th>
                  <th style="width:20%;">Type</th>
                  <th style="width:10%; text-align:center;">Qty</th>
                  <th style="width:10%;"></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted"><span id="partsCount">0</span> part(s) added</small>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addPartRow()">Add Part</button>
          </div>
        </div>

        <!-- WORK INSTRUCTIONS TABLE WITH TINYMCE -->
        <div class="col-12">
          <label class="form-label">Work Instructions</label>
          <div class="table-responsive">
            <table id="instrTable" class="table table-sm instr-table mb-4">
              <thead class="table-light">
                <tr>
                  <th style="width:5%;">#</th>
                  <th style="width:70%;">Instruction</th>
                  <th style="width:20%;">Notes</th>
                  <th style="width:5%;"></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted"><span id="instrCount">0</span> instruction(s) added</small>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addInstrRow()">Add
              Instruction</button>
          </div>
        </div>

        <!-- ATTACHMENTS -->
        <div class="col-12">
          <label class="form-label">Attachments</label>
          <input type="file" class="form-control" name="attachments[]" multiple>
          <div id="existingAttachments" class="mt-2"></div>
        </div>

        <!-- SUBMIT BUTTON -->
        <div class="col-12 text-end">
          <button type="submit" id="submitBtn" class="btn btn-success px-4">Create SEA</button>
        </div>
      </form>
    </div>

    <!-- LIST VIEW -->
    <div id="listView" class="hidden">
      <button class="btn btn-sm btn-outline-secondary mb-3" onclick="goBack()">Back</button>
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Existing SEAs</h3>
        <input type="text" id="searchInput" class="form-control w-50" placeholder="Search SEAs...">
      </div>
      <div id="seaContainer" class="row"></div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // GLOBAL VARS
    let stepCounter = 1;

    // FLEET/DEVICE POPULATION (RESTORED FROM ORIGINAL)
    $(document).ready(function () {
      // Fleet options
      const fleets = [
        { value: 'Boeing-737', text: 'Boeing 737' },
        { value: 'Boeing-777', text: 'Boeing 777' },
        { value: 'Boeing-787', text: 'Boeing 787' },
        { value: 'Airbus-A320', text: 'Airbus A320' },
        { value: 'Other', text: 'Other' }
      ];
      fleets.forEach(f => $('#fleet').append(`<option value="${f.value}">${f.text}</option>`));

      // Device options by fleet
      const devicesByFleet = {
        'Boeing-737': ['Visual System', 'Motion System', 'Avionics', 'Instructor Station'],
        'Boeing-777': ['Flight Controls', 'Hydraulics', 'Electrics', 'FMS'],
        'Boeing-787': ['Glass Cockpit', 'Fly-by-Wire', 'Dreamliner Avionics'],
        'Airbus-A320': ['Side-Stick Controls', 'Fly-by-Wire', 'ECAM System'],
        'Other': ['Custom Device 1', 'Custom Device 2']
      };

      // Select2 init
      $('#fleet, #device').select2({ theme: 'bootstrap-5', width: '100%' });

      // Dynamic devices on fleet change
      $('#fleet').on('change', function () {
        const fleet = $(this).val();
        $('#device').empty().prop('disabled', !fleet).select2('destroy').select2({ theme: 'bootstrap-5', width: '100%' });
        if (fleet) {
          (devicesByFleet[fleet] || []).forEach(d => $('#device').append(`<option value="${d}">${d}</option>`));
        }
      });
    });

    // DATATABLES FOR PARTS
    function initPartsTable() {
      if (partsTable) partsTable.destroy();
      partsTable = $('#partsTable').DataTable({
        paging: false, searching: false, info: false, ordering: true, order: [[0, 'asc']],
        columnDefs: [
          { targets: 3, render: (data, type) => type === 'sort' ? parseInt(data) || 0 : data },
          { targets: 4, orderable: false }
        ],
        language: { emptyTable: "No parts added yet. Click 'Add Part' to begin." },
        drawCallback: function () {
          $('#partsTable tbody tr').each(function (i) {
            $(this).attr('data-row', i + 1);
            $(this).find('input, textarea, select').each(function () {
              const name = $(this).attr('name');
              if (name) $(this).attr('name', name.replace(/\[(\d+)\]/, `[${i + 1}]`));
            });
          });
          updatePartsCount();
        }
      });
    }

    // PARTS FUNCTIONS
    function addPartRow(data = {}) {
      const rowNum = $('#partsTable tbody tr').length + 1;
      const row = `<tr data-row="${rowNum}">
        <td><input type="text" name="parts[${rowNum}][part]" value="${data.part || ''}" class="form-control form-control-sm" placeholder="Part number" required /></td>
        <td><textarea name="parts[${rowNum}][desc]" class="form-control form-control-sm" rows="2" placeholder="Description">${data.desc || ''}</textarea></td>
        <td><select name="parts[${rowNum}][type]" class="form-select form-select-sm">
          <option value="">Select type</option><option value="Hardware" ${data.type === 'Hardware' ? 'selected' : ''}>Hardware</option>
          <option value="Software" ${data.type === 'Software' ? 'selected' : ''}>Software</option><option value="Configuration" ${data.type === 'Configuration' ? 'selected' : ''}>Configuration</option>
          <option value="Firmware" ${data.type === 'Firmware' ? 'selected' : ''}>Firmware</option><option value="Other" ${data.type === 'Other' ? 'selected' : ''}>Other</option></select></td>
        <td style="text-align:center;"><input type="number" name="parts[${rowNum}][qty]" value="${data.qty || 1}" min="1" class="form-control form-control-sm text-center" style="width:60px;display:inline-block;" /></td>
        <td style="white-space:nowrap;text-align:right;"><button type="button" class="btn btn-sm btn-outline-danger" onclick="removePartRow(this)">Remove</button></td>
      </tr>`;
      $('#partsTable tbody').append(row);
      if (partsTable) partsTable.row.add($(row)).draw(false);
      updatePartsCount();
    }

    function removePartRow(btn) {
      if (!confirm('Remove this part?')) return;
      const $row = $(btn).closest('tr'), idx = $row.index();
      $row.remove();
      if (partsTable) partsTable.row(idx).remove().draw(false);
      updatePartsCount();
    }

    function updatePartsCount() {
      const rows = $('#partsTable tbody tr'), count = rows.length;
      $('#partsCount').text(count);
      const parts = rows.map((i, tr) => {
        const $tr = $(tr);
        return {
          part: $tr.find('input[name$="[part]"]').val() || '',
          desc: $tr.find('textarea[name$="[desc]"]').val() || '',
          type: $tr.find('select[name$="[type]"]').val() || '',
          qty: parseInt($tr.find('input[name$="[qty]"]').val()) || 1
        };
      }).get().filter(p => p.part.trim());
      $('#parts_json').val(JSON.stringify(parts));
    }

    // INSTRUCTIONS WITH TINYMCE
    function addInstrRow(data = {}) {
      const rowNum = $('#instrTable tbody tr').length + 1;
      const row = `<tr data-row="${rowNum}">
        <td style="text-align:center;">${rowNum}</td>
        <td><textarea name="instructions[${rowNum}][instruction]" class="tinymce-instr" style="display:none;">${data.instruction || ''}</textarea>
        <div class="instruction-preview small text-muted"></div></td>
        <td><input type="text" name="instructions[${rowNum}][notes]" value="${data.notes || ''}" class="form-control form-control-sm" placeholder="Notes" /></td>
        <td style="white-space:nowrap;text-align:right;"><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeInstrRow(this)">Remove</button></td>
      </tr>`;
      $('#instrTable tbody').append(row);
      const $textarea = $('#instrTable tbody tr:last .tinymce-instr');
      const editorId = `tinymce-${rowNum}`;
      $textarea.attr('id', editorId);
      tinymce.init({
        selector: `#${editorId}`,
        height: 120,
        menubar: false,
        plugins: 'lists link image table code',
        toolbar: 'undo redo | bold italic underline | bullist numlist | link image | table | code',
        setup: (ed) => ed.on('Change Keyup', () => updateInstrPreview(ed.getContent(), $textarea.closest('tr')))
      }).then((eds) => {
        tinymceInstances.push(eds[0]);
        updateInstrPreview(eds[0].getContent(), $textarea.closest('tr'));
      });
      updateInstrCount();
    }

    function removeInstrRow(btn) {
      if (!confirm('Remove this instruction?')) return;
      const $row = $(btn).closest('tr'), editorId = $row.find('.tinymce-instr').attr('id');
      if (editorId) { tinymce.get(editorId)?.remove(); tinymceInstances = tinymceInstances.filter(e => e.id !== editorId); }
      $row.remove();
      updateInstrCount();
    }

    function updateInstrCount() {
      const rows = $('#instrTable tbody tr'), count = rows.length;
      $('#instrCount').text(count);
      rows.each((i, row) => {
        $(row).find('td:first').text(i + 1);
        $(row).find('textarea, input').each((_, el) => {
          const name = $(el).attr('name');
          if (name) $(el).attr('name', name.replace(/\[(\d+)\]/, `[${i + 1}]`));
        });
      });
      const instructions = rows.map((_, tr) => {
        const $tr = $(tr), edId = $tr.find('.tinymce-instr').attr('id');
        return { instruction: edId ? tinymce.get(edId)?.getContent() || '' : '', notes: $tr.find('input[name$="[notes]"]').val() || '' };
      }).get();
      $('#instructions_json').val(JSON.stringify(instructions));
    }

    function updateInstrPreview(html, $row) {
      const $prev = $row.find('.instruction-preview');
      $prev.html(html || '').toggle(!!html.trim());
    }

    // FORM SUBMISSION
    $('#seaForm').on('submit', function (e) {
      e.preventDefault();
      if (partsTable) partsTable.draw(false);
      tinymce.triggerSave(); // Save TinyMCE content to textareas
      const formData = new FormData(this);
      const $btn = $('#submitBtn').prop('disabled', true).text('Saving...');
      $.ajax({
        url: './src/submit.php', method: 'POST', data: formData, processData: false, contentType: false, dataType: 'json',
        success: (res) => {
          if (res.success) {
            $('#sea_id').val(res.sea_id); $('#display_id').val(res.sea_id); $('#sea_action').val('update');
            $('#formTitle').text('Edit SEA – ' + res.sea_id); $('#submitBtn').text('Update SEA');
            history.replaceState(null, null, '?id=' + res.sea_id);
            if (res.pdf) downloadPdf(res.pdf, res.pdf_name);
            showAlert('success', res.message);
          } else showAlert('danger', res.message || 'Unknown error');
        },
        error: (xhr) => showAlert('danger', xhr.responseJSON?.message || 'Network error'),
        complete: () => $btn.prop('disabled', false).text($('#sea_action').val() === 'create' ? 'Create SEA' : 'Update SEA')
      });
    });

    function showAlert(type, message) {
      const alert = `<div class="alert alert-${type} alert-dismissible fade show mt-3" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
      $('#createForm').prepend(alert);
    }

    function downloadPdf(base64, filename) {
      const link = document.createElement('a');
      link.href = 'data:application/pdf;base64,' + base64; link.download = filename; link.click();
    }

    // NAVIGATION
    window.showCreateForm = function () {
      hideAll(); $('#createForm').removeClass('hidden');
      if (!$('#sea_id').val()) {
        $('#sea_action').val('create'); $('#formTitle').text('New SEA'); $('#submitBtn').text('Create SEA');
        stepCounter = 1; $('#partsTable tbody').empty(); $('#instrTable tbody').empty();
        $('#existingAttachments').html('<small class="text-muted">No attachments</small>');
        setTimeout(initPartsTable, 50); addPartRow(); addInstrRow();
      }
    };

    window.showSeaList = function () { hideAll(); $('#listView').removeClass('hidden'); loadSeaList(); };

    window.goBack = function () { hideAll(); $('#choiceScreen').removeClass('hidden'); history.replaceState(null, null, window.location.pathname); };

    function hideAll() { $('#choiceScreen, #createForm, #listView').addClass('hidden'); }

    // LIST & EDIT
    function loadSeaList() {
      const $c = $('#seaContainer');
      $c.html('<div class="text-center py-5"><div class="spinner-border"></div> Loading...</div>');
      fetch('./src/list_seas.php').then(r => r.ok ? r.text() : Promise.reject('HTTP ' + r.status))
        .then(html => {
          $c.html(html); $('#searchInput').off('input').on('input', function () {
            const term = this.value.toLowerCase(); $('.sea-card').each(function () {
              const txt = this.textContent.toLowerCase(); $(this).closest('.col-md-6')[txt.includes(term) ? 'show' : 'hide']();
            });
          });
        }).catch(err => $c.html(`<div class="alert alert-danger">Failed: ${err.message}</div>`));
    }

    window.deleteSea = function (id) {
      if (!confirm(`Delete SEA-${id}? This cannot be undone.`)) return;
      const f = document.createElement('form'); f.method = 'POST'; f.action = './src/delete.php'; f.style.display = 'none';
      const i = document.createElement('input'); i.type = 'hidden'; i.name = 'filename'; i.value = `sea-${id}.json`;
      f.appendChild(i); document.body.appendChild(f); f.submit();
    };

    window.editSea = function (id) {
      showCreateForm(); $('#sea_action').val('update'); $('#sea_id').val(id); $('#display_id').val(id);
      $('#formTitle').text('Edit SEA – ' + id); $('#submitBtn').text('Update SEA');
      fetch(`data/sea-${id}.json`).then(r => r.ok ? r.json() : Promise.reject(`HTTP ${r.status}`))
        .then(d => {
          $('#ea_number').val(d.ea_number || ''); $('#revision').val(d.revision || ''); $('#requester').val(d.requester || '');
          $('#description').val(d.description || ''); $('#justification').val(d.justification || ''); $('#impact').val(d.impact || '');
          $('#priority').val(d.priority || 'Medium'); $('#target_date').val(d.target_date || ''); $('#status').val(d.status || 'Planning');
          $('#partsTable tbody').empty(); (JSON.parse(d.parts_json || '[]') || []).forEach(addPartRow); setTimeout(initPartsTable, 100);
          $('#instrTable tbody').empty(); tinymceInstances.forEach(e => e.remove()); tinymceInstances = [];
          (JSON.parse(d.instructions_json || '[]') || []).forEach(addInstrRow);
          loadExistingAttachments(d.attachments || []);
          const savedFleet = d.fleet || '', savedDevices = Array.isArray(d.device) ? d.device : (d.device ? [d.device] : []);
          $('#fleet').val(savedFleet).trigger('change');
          setTimeout(() => $('#device').val(savedDevices).trigger('change'), 100);
        }).catch(err => { console.error(err); showAlert('danger', 'Failed to load SEA: ' + err.message); });
    };

    // SEARCH IN LIST
    $(document).on('input', '#searchInput', function () {
      const term = this.value.toLowerCase();
      $('.sea-card').each(function () {
        const txt = this.textContent.toLowerCase();
        $(this).closest('.col-md-6')[txt.includes(term) ? 'show' : 'hide']();
      });
    });

    // DESCRIPTION EXPAND IN LIST
    $(document).on('click', '.expand-desc', function (e) {
      e.preventDefault();
      const $span = $(this).prev(), full = $span.data('full'), short = $span.data('short');
      if ($span.data('expanded')) {
        $span.html(short).css({ 'max-width': '100%', overflow: 'hidden', 'text-overflow': 'ellipsis', 'white-space': 'nowrap', display: 'inline-block' });
        $(this).text('[show more]'); $span.removeData('expanded');
      } else {
        $span.html(full).css({ 'max-width': '', overflow: '', 'text-overflow': '', 'white-space': '', display: '' });
        $(this).text('[show less]'); $span.data('expanded', '1');
      }
    });

    // STARTUP
    hideAll(); $('#choiceScreen').removeClass('hidden');
    const urlParams = new URLSearchParams(window.location.search), editId = urlParams.get('id');
    if (editId) editSea(editId);
  </script>
</body>

</html>